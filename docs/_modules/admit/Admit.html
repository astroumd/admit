<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>admit.Admit &#8212; ADMIT 1.0.6 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="ADMIT 1.0.6 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ADMIT 1.0.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for admit.Admit</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;**Project** --- ADMIT project.</span>
<span class="sd">   ------------------------------</span>

<span class="sd">   This module defines the Admit project class.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1"># system imports</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="k">as</span> <span class="nn">et</span>
<span class="kn">import</span> <span class="nn">fnmatch</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">webbrowser</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="c1">#import Queue</span>
<span class="c1">#from multiprocessing.dummy import Pool as ThreadPool </span>
<span class="kn">import</span> <span class="nn">signal</span>

<span class="c1"># ADMIT imports</span>
<span class="kn">import</span> <span class="nn">admit</span>
<span class="kn">import</span> <span class="nn">admit.version</span> 
<span class="kn">import</span> <span class="nn">admit.xmlio.Parser</span> <span class="k">as</span> <span class="nn">Parser</span>
<span class="kn">import</span> <span class="nn">admit.Summary</span> <span class="k">as</span> <span class="nn">Summary</span>
<span class="kn">import</span> <span class="nn">admit.util.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">admit.util.AdmitHTTP</span>
<span class="kn">import</span> <span class="nn">admit.util.PlotControl</span> <span class="k">as</span> <span class="nn">PlotControl</span>
<span class="kn">from</span> <span class="nn">admit.xmlio.DtdReader</span> <span class="k">import</span> <span class="n">DtdReader</span>
<span class="kn">import</span> <span class="nn">admit.util.bdp_types</span> <span class="k">as</span> <span class="nn">bt</span>
<span class="kn">from</span> <span class="nn">admit.util.AdmitLogging</span> <span class="k">import</span> <span class="n">AdmitLogging</span> <span class="k">as</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">admit.util</span> <span class="k">import</span> <span class="n">LineData</span>

<span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="Admit"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit">[docs]</a><span class="k">class</span> <span class="nc">Admit</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for an ADMIT project.   The project is normally based on one</span>
<span class="sd">    single FITS cube (in some cases two, where the ingest stage needs a</span>
<span class="sd">    primary beam to correct the science cube with), although this is not</span>
<span class="sd">    a restriction to ADMIT.</span>

<span class="sd">    A FITS cube results in an ADMIT directory, within which you will</span>
<span class="sd">    find an admit.xml file describing the project, it&#39;s data products (BDP&#39;s)</span>
<span class="sd">    and the AT&#39;s (tasks) that generated the BDP&#39;s.</span>

<span class="sd">    If input file/directory are given or admit.xml is located in the current</span>
<span class="sd">    directory then they are loaded into the class, else a new (empty) class is</span>
<span class="sd">    instantiated.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    baseDir : str</span>
<span class="sd">        Base directory for XML files (the &quot;ADMIT directory&quot;).</span>

<span class="sd">    name : str</span>
<span class="sd">        Alias name.</span>

<span class="sd">    basefile : str</span>
<span class="sd">        Base XML file name (default: admit.xml).</span>

<span class="sd">    create : bool</span>
<span class="sd">        Whether to create any needed directories.</span>

<span class="sd">    dataserver : bool</span>
<span class="sd">        Whether to start the data browser server.</span>

<span class="sd">    loglevel : int</span>
<span class="sd">        The integer log level from the Python *logging* module.  One of:</span>
<span class="sd"> </span>
<span class="sd">        - logging.CRITICAL    = 50</span>
<span class="sd">        - logging.ERROR       = 40</span>
<span class="sd">        - logging.WARNING     = 30</span>
<span class="sd">        - logging.INFO        = 20</span>
<span class="sd">        - logging.DEBUG       = 10</span>
<span class="sd"> </span>
<span class="sd">        Default is logging.INFO.</span>

<span class="sd">    commit : bool, optional</span>
<span class="sd">        Whether to commit XML-backed flows immediately; default is ``True``.</span>
<span class="sd">        Set to ``True`` if the flow will *not* be reconstructed (as in a recipe</span>
<span class="sd">        script) before use; this is usually the case for interactive mode. Set</span>
<span class="sd">        to ``False`` in (most) scripts, which reconstruct the flow each time.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    baseDir : str</span>
<span class="sd">        Base directory for XML files (the &quot;ADMIT directory&quot;).</span>
<span class="sd">        Guaranteed to end in os.sep.</span>

<span class="sd">    baseFile : str</span>
<span class="sd">        Base XML file name, usually admit.xml.</span>

<span class="sd">    currDir : str</span>
<span class="sd">        Current working directory (at construction).</span>

<span class="sd">    fm : FlowManager</span>
<span class="sd">        Project flow manager instance.</span>

<span class="sd">    new : bool</span>
<span class="sd">        Whether the project is new or constructed from an existing XML file.</span>

<span class="sd">    pm : ProjectManager</span>
<span class="sd">        Project manager instance.</span>

<span class="sd">    pmode : int</span>
<span class="sd">        Plotting mode.</span>

<span class="sd">    ptype : int</span>
<span class="sd">        Plotting type.</span>

<span class="sd">    count : int</span>
<span class="sd">        Flow counter how many times the flow has been run (stored in userData)</span>

<span class="sd">    project_id : int</span>
<span class="sd">        Static project identification number</span>

<span class="sd">    summaryData : instance of admit.Summary</span>
<span class="sd">        AT summary data</span>

<span class="sd">    userData : dict</span>
<span class="sd">        Additional, user-defined data.</span>

<span class="sd">    _data_browser_port : int</span>
<span class="sd">        Port number that the localhost http server for the data</span>
<span class="sd">        browser (aka data GUI) will use.  This attribute is set</span>
<span class="sd">        by the operating system.</span>

<span class="sd">    _data_server : bool</span>
<span class="sd">        Whether to start the data browser server.</span>

<span class="sd">    _server : HTTP server</span>
<span class="sd">        Data HTTP server.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. todo::</span>

<span class="sd">      1. in the current implementation every directory, admit or not-admit, can</span>
<span class="sd">      be made an admit directory (i.e. contain a root admit.xml)</span>

<span class="sd">      2. we really don&#39;t need a basefile= in the argument list</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">project_id</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1"># Class static project ID counter.</span>
    <span class="n">loginit</span> <span class="o">=</span> <span class="kc">False</span>       <span class="c1"># whether or not the logger has been innitialized</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">basefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dataserver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># IMPORTANT note for dtd&#39;s:   if you add items for admit.xml here,</span>
        <span class="c1"># don&#39;t forget to edit dtdGenerator.py and run bin/dtdGenerator</span>
        <span class="c1">#</span>

        
        <span class="c1"># baseDir  : should be a directory, always needed</span>
        <span class="c1"># name     : some ID, deprecate?</span>
        <span class="c1"># basefile : should be admit.xml, why change it?</span>
        <span class="c1"># create   : create any new directory that&#39;s needed</span>

        <span class="c1"># global ID</span>
        <span class="c1"># [KPR] This doesn&#39;t actually work as the ID is &quot;global&quot; only to</span>
        <span class="c1">#       individual scripts. The ProjectManager overrides it.</span>
        <span class="c1"># @todo   can we remove this?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span>  <span class="o">=</span> <span class="n">Admit</span><span class="o">.</span><span class="n">project_id</span>
        <span class="n">Admit</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">Admit</span><span class="o">.</span><span class="n">project_id</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Project manager instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>

        <span class="c1"># Timing info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Dtime</span><span class="p">(</span><span class="s2">&quot;ADMITrun&quot;</span><span class="p">)</span>

        <span class="c1"># default to zero to let OS pick an open port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_browser_port</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># start the server for the data browser or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_server</span> <span class="o">=</span> <span class="n">dataserver</span>
        <span class="c1"># old admit2 things to keep it working</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotparams</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span> <span class="o">=</span> <span class="n">loglevel</span>
        <span class="c1"># new Admit things</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">userData</span> <span class="o">=</span> <span class="p">{}</span>                <span class="c1"># user added data, anything can go in here; use get/set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summaryData</span> <span class="o">=</span> <span class="n">Summary</span><span class="o">.</span><span class="n">Summary</span><span class="p">()</span>      <span class="c1"># summary added data, the my_AT.summary() will provide these</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span> <span class="o">=</span> <span class="kc">None</span>                  <span class="c1"># flow manager as read from XML</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">Flow</span><span class="p">()</span>            <span class="c1"># flow manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>         <span class="c1"># project manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>                  <span class="c1"># is this a new admit object or are we building it from an xml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astale</span> <span class="o">=</span> <span class="mi">0</span>                   <span class="c1"># export hack (will be True if lightweight tar file is built)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>                    <span class="c1"># keep track how many times this admit has been run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="kc">None</span>               <span class="c1"># data HTTP server</span>
        <span class="c1"># location information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">=</span> <span class="kc">None</span>               <span class="c1"># base directory for xml files (&#39;the admit directory&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseFile</span> <span class="o">=</span> <span class="kc">None</span>              <span class="c1"># base file name, usually admit.xml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>        <span class="c1"># remember where we started (deprecate, we don&#39;t need it now)</span>
        <span class="c1">#self.queue = Queue.Queue()</span>
        <span class="c1">#self.pool = ThreadPool(1)</span>

        <span class="k">if</span> <span class="n">baseDir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">baseDir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">:</span>
                <span class="n">baseDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">baseDir</span><span class="p">)</span>
                <span class="c1">#print &quot;Absolute ADMIT&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">baseDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currDir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">baseDir</span><span class="p">)</span>
                <span class="c1">#print &quot;Relative ADMIT&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">baseDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currDir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
            <span class="c1">#print &quot;Local ADMIT&quot;</span>
        <span class="c1">#print &quot;ADMIT(%s): CWD=%s&quot; % (baseDir, self.currDir)</span>
        <span class="nb">print</span> <span class="s2">&quot;ADMIT basedir   = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">baseDir</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;ADMIT root      = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">admit_root</span><span class="p">())</span>
        <span class="nb">print</span> <span class="s2">&quot;ADMIT version   = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loggername</span> <span class="o">=</span> <span class="n">baseDir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loggername</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loggername</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loggername</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># look for admit.xml or admit.zip files</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">baseDir</span><span class="p">):</span>                <span class="c1"># does basedir even exist yet</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">baseDir</span><span class="p">):</span>            <span class="c1"># basedir is actually a file (should we allow this?)</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">baseDir</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
                <span class="c1"># separate out the base directory and the base file</span>
                <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baseFile</span> <span class="o">=</span> <span class="n">baseDir</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">baseDir</span><span class="p">[:</span><span class="n">loc</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baseFile</span> <span class="o">=</span> <span class="n">baseDir</span><span class="p">[</span><span class="n">loc</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">baseDir</span><span class="p">):</span>           <span class="c1"># basedir is a directory</span>
                <span class="k">if</span> <span class="n">baseDir</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">=</span> <span class="n">baseDir</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">=</span> <span class="n">baseDir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">baseFile</span> <span class="o">=</span> <span class="s2">&quot;admit.xml&quot;</span> <span class="k">if</span> <span class="n">basefile</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">basefile</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseFile</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;basedir </span><span class="si">%s</span><span class="s2"> not a file or directory? &quot;</span> <span class="o">%</span> <span class="n">baseDir</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseFile</span><span class="p">):</span>           <span class="c1"># detect if the file is a zip file</span>

                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseFile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">+</span> <span class="s2">&quot;admit.xml&quot;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No admit.xml file located in &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseFile</span> <span class="o">=</span> <span class="s2">&quot;admit.xml&quot;</span>
        <span class="k">else</span><span class="p">:</span>                                                             <span class="c1"># we are working with a new basedir</span>
            <span class="c1">#create = False</span>
            <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">baseDir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">baseDir</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">=</span> <span class="n">baseDir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">=</span> <span class="n">baseDir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baseFile</span> <span class="o">=</span> <span class="s2">&quot;admit.xml&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loggername</span><span class="p">,</span> <span class="n">baseDir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;admit.log&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Admit</span><span class="o">.</span><span class="n">loginit</span><span class="p">:</span>
            <span class="c1"># @todo should this be in logging? for now, do here</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">TIMING</span><span class="p">,</span>     <span class="s2">&quot;TIMING&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span> <span class="s2">&quot;REGRESSION&quot;</span><span class="p">)</span>
            <span class="n">Admit</span><span class="o">.</span><span class="n">loginit</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new</span><span class="p">:</span>                           <span class="c1"># load the existing files/data</span>
            <span class="c1"># @todo the AT&#39;s need the self.baseDir</span>
            <span class="c1">#       until then checkfiles() will complain the BDP.getfiles() don&#39;t exist on a re-run</span>
            <span class="c1"># notice admit is passed to the Parser</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="o">.</span><span class="n">Parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseFile</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getflowmanager</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="o">.</span><span class="n">_summaryData</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getSummary</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="o">.</span><span class="n">_twins</span> <span class="o">=</span> <span class="p">{}</span>             <span class="c1"># dict of merged tasks</span>

            <span class="c1"># Re-initialize project manager.</span>
            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">projmanager</span><span class="p">:</span>
                <span class="c1"># Managed projects must be fully formed and up to date.</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">projmanager</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">mergeFlow</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">addProject</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">projmanager</span><span class="p">[</span><span class="n">pid</span><span class="p">])</span>

            <span class="c1"># Replace linked ATs in multiflows with their master copies.</span>
            <span class="c1"># Only the latter contain validated BDP data.</span>
            <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="p">:</span>
                <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">getProject</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
                    <span class="c1"># This task is linked from another project.</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="p">:</span>
                        <span class="n">tid0</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tid0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">fm</span><span class="p">:</span>
                            <span class="c1"># Copy master AT reference.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">)]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No task #</span><span class="si">%d</span><span class="s1"> in project #</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tid0</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No linked project #</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">commit</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mergeFlow</span><span class="p">()</span>

        <span class="c1">#print &quot;ADMIT.baseDir = &quot;, self.baseDir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ADMIT.basedir=</span><span class="si">%s</span><span class="s1"> does not end with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>

        <span class="c1"># data server for locahost web browing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_server</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startDataServer</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_url</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">userData</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;flowcount&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">userData</span><span class="p">[</span><span class="s1">&#39;flowcount&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">userData</span><span class="p">[</span><span class="s1">&#39;flowcount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
        <span class="nb">print</span> <span class="s2">&quot;ADMIT flowcount = </span><span class="si">%d</span><span class="s2"> stale = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">astale</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">bt</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">BOLD</span> <span class="o">+</span> <span class="n">bt</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s2">&quot;ADMIT :&quot;</span> <span class="o">+</span> <span class="n">bt</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">END</span>
        <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the numbers of tasks in the project.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flow tasks membership operator.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           tid : int</span>
<span class="sd">               Task ID number or alias name.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           bool</span>
<span class="sd">               Membership result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">__contains__</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flow tasks iterator.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           iterator</span>
<span class="sd">               Task iterator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an AT, referred by its task ID (an integer &gt;= 0).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tid : int</span>
<span class="sd">            Task ID number or alias name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AT</span>
<span class="sd">          Reference to AT with ID `tid`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        A BDP (bdp_out) can be accessed by indexing the task, i.e.,</span>
<span class="sd">        admit[task_id][bdp_out_id] returns a BDP.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>

<div class="viewcode-block" id="Admit.version"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.version">[docs]</a>    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return version of ADMIT</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">admit</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">__version__</span></div>
    
<div class="viewcode-block" id="Admit.setlogginglevel"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.setlogginglevel">[docs]</a>    <span class="k">def</span> <span class="nf">setlogginglevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to set the logging level</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            level : int</span>
<span class="sd">                The logging level to use</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span></div>

<div class="viewcode-block" id="Admit.getlogginglevel"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.getlogginglevel">[docs]</a>    <span class="k">def</span> <span class="nf">getlogginglevel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to return the current logging level</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            An int representing the current logging level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span></div>

<div class="viewcode-block" id="Admit.mkdir"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.mkdir">[docs]</a>    <span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a directory in the ADMIT hierarchy, if it doesn&#39;t exist yet.</span>
<span class="sd">           It also allows an absolute path, in the classical unix sense, but</span>
<span class="sd">           this is normally not needed.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           dirname : str</span>
<span class="sd">               Directory name.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dirname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">:</span>
            <span class="c1"># it&#39;s already an absolute path</span>
            <span class="n">dname</span> <span class="o">=</span> <span class="n">dirname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># make it relative to the admit</span>
            <span class="n">dname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">+</span> <span class="n">dirname</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dname</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span> <span class="c1"># Python &gt;2.5</span>
                <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dname</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">raise</span></div>
            <span class="c1">#print &quot;ADMIT.mkdir: &quot;,dname</span>

<div class="viewcode-block" id="Admit.getFlow"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.getFlow">[docs]</a>    <span class="k">def</span> <span class="nf">getFlow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns flow manager instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FlowManager</span>
<span class="sd">            Flow manager instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span></div>

<div class="viewcode-block" id="Admit.getManager"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.getManager">[docs]</a>    <span class="k">def</span> <span class="nf">getManager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns project manager instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ProjectManager</span>
<span class="sd">            Project manager instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span></div>

<div class="viewcode-block" id="Admit.plotparams"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.plotparams">[docs]</a>    <span class="k">def</span> <span class="nf">plotparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plotmode</span><span class="o">=</span><span class="n">PlotControl</span><span class="o">.</span><span class="n">BATCH</span><span class="p">,</span> <span class="n">plottype</span><span class="o">=</span><span class="n">PlotControl</span><span class="o">.</span><span class="n">PNG</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determines if plots are saved and in what format.</span>
<span class="sd">            These are based on simple matplotlib diagrams.</span>
<span class="sd">            Common output formats are png and pdf.</span>
<span class="sd">            Note: this only applies to new AT&#39;s started in a flow,</span>
<span class="sd">            to change existing parameters in a re-run for example,</span>
<span class="sd">            you will need to manually change the AT._plot_mode</span>
<span class="sd">            and AT._plot_type</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            plotmode : int</span>
<span class="sd">                Plotting mode.  Default: PlotControl.BATCH</span>

<span class="sd">            plottype : int  </span>
<span class="sd">                Plot format type.  Default: PlotControl.PNG.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>

<span class="sd">            See Also</span>
<span class="sd">            --------</span>
<span class="sd">            util.PlotControl plot modes and types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#if plotmode &lt; 0:</span>
        <span class="c1">#    return (self.pmode,self.ptype)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pmode</span> <span class="o">=</span> <span class="n">plotmode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">plottype</span></div>
        <span class="c1">#AT._plot_mode = plotmode</span>
        <span class="c1">#AT._plot_type = plottype</span>
        <span class="c1"># nasty cheat, need to formalize a safer method to talk to APlot</span>
        <span class="c1"># @todo this also means the XML reader will not properly pass this on</span>
        <span class="c1">#aplot.APlot.pmode = plotmode</span>
        <span class="c1"># aplot.APlot.ptype = plottype</span>
        <span class="c1">#print &quot;plotmode: pmode=%d ptype=%s&quot; % (self.pmode,self.ptype)</span>

<div class="viewcode-block" id="Admit.addtask"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.addtask">[docs]</a>    <span class="k">def</span> <span class="nf">addtask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">stuples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtuples</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an AT to the project.</span>

<span class="sd">        Also adjusts the connection mapping between tasks.</span>
<span class="sd">        Usually all but the first task---typically, Ingest_AT---will have</span>
<span class="sd">        &#39;stuples&#39; (a List of Source Tuples (task-id,bdp-id)). A source 2-tuple</span>
<span class="sd">        consists of a task ID (``task-id``, such as returned by this method) and</span>
<span class="sd">        BDP output slot number (``bdp-id``, zero-based). If the output slot is</span>
<span class="sd">        zero (the tuple refers to the *first* BDP output from the task), then</span>
<span class="sd">        the tuple can be replaced by the task ID for convenience---e.g.,</span>
<span class="sd">        stuples = [(t1,0), (t2,1)] is equivalent to</span>
<span class="sd">        stuples = [t1, (t2,1)].</span>

<span class="sd">        Support for re-running scripts: this method will ignore attempts to</span>
<span class="sd">        re-add a task of the same type and ID to the existing flow, if the</span>
<span class="sd">        project has been restored from XML. Between invocations, scripts may be</span>
<span class="sd">        edited to append new tasks to the flow, but not remove or insert them.</span>
<span class="sd">        Keywords for existing ATs may also be changed by the script; if changes</span>
<span class="sd">        are found, the existing task will be marked out-of-date.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a : AT</span>
<span class="sd">            ADMIT task to append/insert into the flow.</span>

<span class="sd">        stuples : list of 2-tuples, optional</span>
<span class="sd">            List of source connection 2-tuples, one per BDP input port.</span>

<span class="sd">        dtuples : list of 4-tuples, optional</span>
<span class="sd">            List of destination connection 4-tuples.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Input task ID on success, else -1 (error detected).</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        add (FlowManager)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># need to check if fm has been installed</span>
        <span class="c1"># a.check() - was deprecated</span>
        <span class="c1"># task should inherit these from ADMIT</span>
        <span class="c1"># @todo  some (pmode) could be changed without hard</span>
        <span class="c1">#        others (baseDir) probably not a good idea unless you cd around</span>
        <span class="n">a</span><span class="o">.</span><span class="n">_plot_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmode</span>
        <span class="n">a</span><span class="o">.</span><span class="n">_plot_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptype</span>
        <span class="n">a</span><span class="o">.</span><span class="n">setloggername</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loggername</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">getProject</span><span class="p">():</span>
            <span class="c1"># Reset base directory for local tasks only.</span>
            <span class="n">a</span><span class="o">.</span><span class="n">baseDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Increment link count for tasks from other projects.</span>
            <span class="n">a</span><span class="o">.</span><span class="n">link</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stuples</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;addtask: cannot specify stuples for linked task&quot;</span><span class="p">)</span>
        <span class="c1"># now add the BDP_in&#39;s to the AT</span>
        <span class="c1"># note the BDP_out&#39;s are generated later, and cannot be added via fm.add() at this stage</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">stuples</span><span class="p">,</span> <span class="n">dtuples</span><span class="p">)</span></div>


<div class="viewcode-block" id="Admit.findtask"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.findtask">[docs]</a>    <span class="k">def</span> <span class="nf">findtask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isMatch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds ATs in the flow matching a criterion.</span>

<span class="sd">        Applies the function `isMatch` to all ATs in the flow, in proper</span>
<span class="sd">        dependency order, accumulating matching ATs in a list (the return</span>
<span class="sd">        value). Downstream ATs are guaranteed to follow their predecessors in</span>
<span class="sd">        this list. Often `isMatch` may be conveniently expressed as a lambda</span>
<span class="sd">        function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        isMatch : bool functor(AT)</span>
<span class="sd">            Function object taking one AT as input and returning a Boolean.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of ATs</span>
<span class="sd">            ATs testing True using `isMatch`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method is a wrapper for `FlowManager.find()</span>
<span class="sd">        &lt;FlowManager.html#admit.FlowManager.FlowManager.find&gt;`_.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        To find all ATs with ID less than 100 in project `p`:</span>

<span class="sd">        &gt;&gt;&gt; p.find(lambda at: at.id() &lt; 100)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">isMatch</span><span class="p">)</span></div>

<div class="viewcode-block" id="Admit.dir"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.dir">[docs]</a>    <span class="k">def</span> <span class="nf">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See AT.dir() but placed here for convenience as well.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           None</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           str</span>
<span class="sd">               Base directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span></div>

<div class="viewcode-block" id="Admit.exit"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.exit">[docs]</a>    <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Early cleanup and exit if exit &gt; 0</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            exit : int</span>
<span class="sd">                The exit code to exit with (must be &gt; 0)</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">exit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;exit </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exit</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="n">exit</span><span class="p">)</span>     <span class="c1"># quick exit, return status &#39;exit&#39;</span>
            <span class="c1">#sys.exit(exit)    # exit back to CASA, which then becomes confused and return status 0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exit </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exit</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Admit.mergeFlow"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.mergeFlow">[docs]</a>    <span class="k">def</span> <span class="nf">mergeFlow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merges tasks from the XML-derived flow (if any).</span>

<span class="sd">        When projects are restored to memory from persistent XML files, that</span>
<span class="sd">        task flow is initially held in stasis while the (possibly modified)</span>
<span class="sd">        flow is being reconstructed, typically by re-running a script. This</span>
<span class="sd">        reconstruction phase lasts from the point where the XML is read up to</span>
<span class="sd">        the first call to this method with `finalize` set (most typically, the</span>
<span class="sd">        first call to run(), which calls this method internally). Calling this</span>
<span class="sd">        method during reconstruction compares the old flow to the newly</span>
<span class="sd">        constructed flow and tasks present unaltered in the new flow (i.e.,</span>
<span class="sd">        same BDP inputs and keyword values as before) are marked up to date, if</span>
<span class="sd">        they were up to date in the original flow. Other relevant attributes</span>
<span class="sd">        are transferred as appropriate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        finalize : bool, optional</span>
<span class="sd">            Whether to discard the XML-derived flow after merge analysis,</span>
<span class="sd">            preventing future merge attempts.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        It is permissible to add or remove arbitrary tasks from the flow, in an</span>
<span class="sd">        arbitrary order, while reconstructing it. Tasks unaffected by the</span>
<span class="sd">        changes (if any) will not be re-executed gratuitously.</span>

<span class="sd">        After finalization, the old flow is forgotten and subsequent calls will</span>
<span class="sd">        have no effect (and likewise for fresh projects not backed by XML).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="p">:</span>
<span class="c1">#          print &quot;-- fm0 -- &quot;</span>
<span class="c1">#          self._fm0.show()</span>
<span class="c1">#          print &quot;-- fm (pre) -- &quot;</span>
<span class="c1">#          self.fm.show()</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">:</span>
            <span class="c1"># A non-empty flow has been constructed.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">mergeTasks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summaryData</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="o">.</span><span class="n">_summaryData</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="o">.</span><span class="n">_twins</span><span class="p">,</span> <span class="n">finalize</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No new flow; just restore the old one as-is.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">summaryData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="o">.</span><span class="n">_summaryData</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="o">.</span><span class="n">_summaryData</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="o">.</span><span class="n">_twins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Ensure new task IDs don&#39;t overwrite existing ones!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">_taskid</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">_bdpmap</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">finalize</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="p">:</span>
            <span class="c1"># Remove orphaned BDPs attached to any remaining unmatched tasks.</span>
            <span class="c1"># These tasks are gone from the flow.</span>
            <span class="k">for</span> <span class="n">tid0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="p">:</span>
              <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="o">.</span><span class="n">_twins</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">tid0</span><span class="p">):</span>
                <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="p">[</span><span class="n">tid0</span><span class="p">]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Task </span><span class="si">%s</span><span class="s2"> - &#39;</span><span class="si">%s</span><span class="s2">&#39; no longer in flow; deleting &quot;</span>
                                <span class="s2">&quot;associated BDP data:&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">_alias</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">bdp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span><span class="p">[</span><span class="n">tid0</span><span class="p">]:</span>
                  <span class="k">if</span> <span class="n">bdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;     BDP Name: </span><span class="si">%s</span><span class="s2">  Type: </span><span class="si">%s</span><span class="s2">  Uid: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
                                    <span class="p">(</span><span class="n">bdp</span><span class="o">.</span><span class="n">show</span><span class="p">(),</span> <span class="n">bdp</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">bdp</span><span class="o">.</span><span class="n">_uid</span><span class="p">))</span>
                    <span class="n">bdp</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_fm0</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="c1">#        print &quot;-- fm (post) -- &quot;</span>
<span class="c1">#        self.fm.show()</span>



<span class="c1">#    def __run__(self, write=True):</span>
<span class="c1">#        print &quot;******************DOING RUN IN THREADPOOL*************************&quot;</span>
<span class="c1">#        writeargs = [write]</span>
<span class="c1">#        self.pool.map(self.__run__,writeargs)</span>
<span class="c1">#        print &quot;******************DONE RUN IN THREADPOOL*************************&quot;</span>

    <span class="k">def</span> <span class="nf">_signal_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">num</span><span class="p">,</span><span class="n">stack</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;Received signal </span><span class="si">%d</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">())</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<div class="viewcode-block" id="Admit.dryrun"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.dryrun">[docs]</a>    <span class="k">def</span> <span class="nf">dryrun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">dryrun</span><span class="p">()</span></div>


<div class="viewcode-block" id="Admit.run"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the project flow.</span>

<span class="sd">        Run those pieces of the pipeline flow</span>
<span class="sd">        deemed out of date. After the run, the flow</span>
<span class="sd">        tasks  gather their summary into ADMIT&#39;s summaryData,</span>
<span class="sd">        ensuring that summaryData always is consistent with the</span>
<span class="sd">        current flow, and does not contain remnants from orphans.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        write : bool, optional</span>
<span class="sd">          Whether to write the project XML files after running the flow;</span>
<span class="sd">          default is ``True``.</span>

<span class="sd">        commit: bool, optional</span>
<span class="sd">          Whether to commit the current flow after merging flow tasks with</span>
<span class="sd">          the XML-derived flow (if present). Set to ``False`` during incremental</span>
<span class="sd">          run()/addtask() flow reconstruction. Once a flow is committed, all</span>
<span class="sd">          requests to add or remove flow tasks will vest immediately. Default</span>
<span class="sd">          is ``True``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        mergeFlow</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method supports intelligent re-running of projects read from XML.</span>
<span class="sd">        Task flows may be reconstructed (as in a script) in any order, from the</span>
<span class="sd">        point where the XML is read up to the first call to run() (with</span>
<span class="sd">        commit=True). Tasks present (unaltered) in the new flow and marked up</span>
<span class="sd">        to date in the XML will not be re-executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For multiflows, re-run parent projects first. This ensures all</span>
        <span class="c1"># linked tasks (which could depend on each other, if linked from the </span>
        <span class="c1"># same parent) are processed in the correct order.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ADMIT run() called [flowcount </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="c1"># Merge XML-backed flow, if any.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mergeFlow</span><span class="p">(</span><span class="n">commit</span><span class="p">)</span>

        <span class="c1"># Make current project summary globally available to ATs.</span>
        <span class="c1"># It will be updated on-the-fly in FlowManager.run().</span>
        <span class="n">admit</span><span class="o">.</span><span class="n">Project</span><span class="o">.</span><span class="n">summaryData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summaryData</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Project run() failed; </span><span class="si">%s</span><span class="s2"> : saving state...&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()))</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
          <span class="k">raise</span>

<span class="c1">#        print &quot;-- fm (run) -- &quot;</span>
<span class="c1">#        self.fm.show()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">userdata</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">write</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>  <span class="c1"># includes HTML update</span>

        <span class="n">cpu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ADMIT run() finished [flowcount </span><span class="si">%d</span><span class="s2">] [cpu </span><span class="si">%g</span><span class="s2"> </span><span class="si">%g</span><span class="s2"> ]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">,</span><span class="n">cpu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cpu</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div>

<div class="viewcode-block" id="Admit.print_summary"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.print_summary">[docs]</a>    <span class="k">def</span> <span class="nf">print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print out summary data</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           None</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;############## SUMMARY DATA ###############&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summaryData</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Admit.userdata"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.userdata">[docs]</a>    <span class="k">def</span> <span class="nf">userdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collects current AT userdata. **warning:** No check is done for duplicate keys!</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           None</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">userData</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">userdata</span><span class="p">())</span></div>

<div class="viewcode-block" id="Admit.updateHTML"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.updateHTML">[docs]</a>    <span class="k">def</span> <span class="nf">updateHTML</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes out HTML views of this object.</span>
<span class="sd">           It is expected that summary() has been called first.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           None</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">admitresources</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">admit_root</span><span class="p">()</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;etc&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;resources&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;resources&quot;</span>
        <span class="c1">#grmph, this gets CVS directory too. need to remove separately</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;rm -rf </span><span class="si">%s</span><span class="s2"> &amp;&amp; cp -r </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">admitresources</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="c1"># rm CVS</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">dirs</span><span class="p">,</span><span class="n">files</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;CVS&quot;</span><span class="p">):</span>
               <span class="n">utils</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">dotfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;admit.dot&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">diagram</span><span class="p">(</span><span class="n">dotfile</span><span class="p">)</span>
        <span class="c1"># Attempt to create a PNG from the dot file.</span>
        <span class="c1"># summary.html() will look for this. Ignore</span>
        <span class="c1"># if &#39;dot&#39; is not on system (retval nonzero)</span>
        <span class="c1">#</span>
        <span class="c1"># Command must be in a list because shell=True is a security hazard.</span>
        <span class="c1"># See https://docs.python.org/2/library/subprocess.html#using-the-subprocess-module</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dot&quot;</span><span class="p">,</span> <span class="s2">&quot;-Tpng&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dotdiagram</span><span class="p">(),</span> <span class="n">dotfile</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="n">diagram</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">diagram</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">summaryData</span><span class="o">.</span><span class="n">html</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dotdiagram</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atToHTML</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logToHTML</span><span class="p">()</span></div>


<div class="viewcode-block" id="Admit.atToHTML"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.atToHTML">[docs]</a>    <span class="k">def</span> <span class="nf">atToHTML</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write individual AT data to the html form&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">connectInputs</span><span class="p">()</span> <span class="c1"># throws exception</span>
        <span class="n">admitloc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">admit_root</span><span class="p">()</span>
        <span class="n">admitetc</span> <span class="o">=</span> <span class="n">admitloc</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;etc&quot;</span>
        <span class="n">admitfile</span> <span class="o">=</span> <span class="n">admitetc</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;form_at.html&quot;</span>
        <span class="n">admit_headfile</span> <span class="o">=</span> <span class="n">admitetc</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;form_head.html&quot;</span>
        <span class="n">admit_tailfile</span> <span class="o">=</span> <span class="n">admitetc</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;form_tail.html&quot;</span>

        <span class="c1"># self.dir() has trailing slash, need to strip it or</span>
        <span class="c1"># basename() returns &#39;&#39;</span>
        <span class="c1"># python basename() behavior different from Unix!!</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">outdir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>

        <span class="c1"># Spit out the boiler plate header that is the same for</span>
        <span class="c1"># all form.html files.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">admit_headfile</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="n">basedir</span><span class="p">,</span><span class="n">basedir</span><span class="p">)</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span>  <span class="s2">&quot;form.html&quot;</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">admitfile</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> 
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">xx</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">:</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">html</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>

        <span class="c1"># Spit out the boiler plate tail that is the same for</span>
        <span class="c1"># all form.html files.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">admit_tailfile</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h</span><span class="p">:</span>
                <span class="n">tail</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">%</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> 
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span> 
        <span class="k">except</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Admit.logToHTML"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.logToHTML">[docs]</a>    <span class="k">def</span> <span class="nf">logToHTML</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the admit.log to an html file&quot;&quot;&quot;</span>
        <span class="n">admitloc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">admit_root</span><span class="p">()</span>
        <span class="n">admitetc</span> <span class="o">=</span> <span class="n">admitloc</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;etc&quot;</span>
        <span class="n">admitfile</span> <span class="o">=</span> <span class="n">admitetc</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;log_template.html&quot;</span>

        <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">outdir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>
        <span class="n">admitlog</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;admit.log&quot;</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span>  <span class="s2">&quot;log.html&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">admitfile</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> 
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">admitlog</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">logtext</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> 
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">template</span> <span class="o">%</span> <span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">logtext</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">e</span>
            <span class="k">return</span></div>



<div class="viewcode-block" id="Admit.script"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.script">[docs]</a>    <span class="k">def</span> <span class="nf">script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a Python script regenerating the current project.</span>

<span class="sd">        The resulting script is intended to recreate the project results from</span>
<span class="sd">        scratch and to be run from the *parent* of the project directory.</span>
<span class="sd">        Running the script over existing project results is unpredictable and</span>
<span class="sd">        not supported.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pyfile : str</span>
<span class="sd">            Output Python script file name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">py</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pyfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">py</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/usr/bin/env casarun</span><span class="se">\n</span><span class="s2">&quot;</span>
                 <span class="s2">&quot;#</span><span class="se">\n</span><span class="s2">&quot;</span>
                 <span class="s2">&quot;# This script was auto-generated by ADMIT version </span><span class="si">%s</span><span class="s2">&quot;</span>
                 <span class="s2">&quot; and may be overwritten;</span><span class="se">\n</span><span class="s2">&quot;</span>
                 <span class="s2">&quot;# copy before editing. It expects to run from </span><span class="si">%s</span><span class="s2">/.</span><span class="se">\n</span><span class="s2">&quot;</span>
                 <span class="s2">&quot;# If you need to start from scratch:   rm -rf </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                 <span class="s2">&quot;#</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">(),</span><span class="n">dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dirs</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># If we&#39;re processing only one FITS cube, let the user specify a</span>
        <span class="c1"># different one on the command line.</span>
        <span class="n">tcube</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">_depsmap</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s1">&#39;Ingest_AT&#39;</span><span class="p">:</span> <span class="n">tcube</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tcube</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">tcube</span> <span class="o">=</span> <span class="n">tcube</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">py</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# This flow processes a single data cube. &quot;</span>
                   <span class="s2">&quot;To process other cubes in the same</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;# way, call this script with another cube file &quot;</span>
                   <span class="s2">&quot;as the command line argument:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;# </span><span class="si">%%</span><span class="s2"> admit0.py CUBEFILE</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;#</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;import os, sys</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;import admit</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;# Command line processing.</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;argv = admit.utils.casa_argv(sys.argv)</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;if len(argv) &lt; 2:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;  cubefile = &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;  projdir = &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;else:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;  cubefile = argv[1]</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;  projdir = os.path.splitext(argv[1])[0] + &#39;.admit&#39;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;# Master project.</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;p = admit.Project(projdir, commit=False)</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">tcube</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">),</span> <span class="n">dirs</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">tcube</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="n">py</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;import admit</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;# Master project.</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;p = admit.Project(&#39;</span><span class="si">%s</span><span class="s2">&#39;, commit=False)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dirs</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="n">tcube</span><span class="o">=</span><span class="n">tcube</span><span class="p">)</span>

        <span class="n">py</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Update project.</span><span class="se">\n</span><span class="s2">&quot;</span>
                 <span class="s2">&quot;p.run()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">py</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">pyfile</span><span class="p">,</span> <span class="mo">0o755</span><span class="p">);</span></div>


<div class="viewcode-block" id="Admit.show"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Prints project state.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            Currently only display FlowManager contents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;==== ADMIT(</span><span class="si">%s</span><span class="s2">) ====&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Admit.browse"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.browse">[docs]</a>    <span class="k">def</span> <span class="nf">browse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a web browser tab with the URL of this admit project&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">webbrowser</span><span class="o">.</span><span class="n">open_new_tab</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_url</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t open URL &#39;</span><span class="si">%s</span><span class="s2">&#39; because </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_url</span><span class="p">,</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="Admit.showsetkey"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.showsetkey">[docs]</a>    <span class="k">def</span> <span class="nf">showsetkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Show current keys for tasks</span>
<span class="sd">            For now on screen, but meant to aid writing a template file for rerun </span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            outfile : str</span>
<span class="sd">                The name of the output file</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">showsetkey</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="Admit.set"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets keys and values in userData.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            kwargs : dictionary like</span>
<span class="sd">                Command line arguments for the function, can be a=x,b=y or</span>
<span class="sd">                \*\*{a:x, b:y} format</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">userData</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Admit.check"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check all project BDPs for name collisions.</span>
<span class="sd">        Also identifies orphaned branches of the tree.</span>
<span class="sd">        A topological sort is needed as well, if they are not in the correct</span>
<span class="sd">        execution order.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        UNIX tsort(1) program.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Admit.get"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a global ADMIT parameter.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           key : str</span>
<span class="sd">               User-defined data keyword.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           str</span>
<span class="sd">               User-defined (userData) keyword value.</span>

<span class="sd">           Notes</span>
<span class="sd">           -----</span>
<span class="sd">           .. todo::</span>
<span class="sd">               This method should mirror the way we do this in the AT</span>
<span class="sd">               (setkey/getkey)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">userData</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">userData</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ADMIT: </span><span class="si">%s</span><span class="s2"> not a valid userData key&quot;</span> <span class="o">%</span> <span class="n">key</span></div>

<div class="viewcode-block" id="Admit.has"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.has">[docs]</a>    <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query if a global user key exists for this admit project.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           key : str</span>
<span class="sd">               User-defined data keyword.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           bool</span>
<span class="sd">              True if keyword is present in userData, else False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">userData</span></div>

<div class="viewcode-block" id="Admit.print_methods"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.print_methods">[docs]</a>    <span class="k">def</span> <span class="nf">print_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print all the methods of this object and their doc string(s).</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">* Methods *&#39;</span>
        <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                <span class="nb">print</span> <span class="n">names</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">__doc__</span></div>

<div class="viewcode-block" id="Admit.print_attributes"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.print_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">print_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print all the attributes of this object and their value(s).</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="s1">&#39;* Attributes *&#39;</span>
        <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                <span class="nb">print</span> <span class="n">names</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">attr</span></div>

<div class="viewcode-block" id="Admit.print_all"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.print_all">[docs]</a>    <span class="k">def</span> <span class="nf">print_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calls all the methods of this object.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">names</span> <span class="o">!=</span> <span class="s1">&#39;print_all&#39;</span> <span class="ow">and</span> <span class="n">names</span> <span class="o">!=</span> <span class="s1">&#39;__init__&#39;</span><span class="p">:</span>
                <span class="n">attr</span><span class="p">()</span> <span class="c1"># calling the method</span></div>

<div class="viewcode-block" id="Admit.discover"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.discover">[docs]</a>    <span class="k">def</span> <span class="nf">discover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rootdir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Project data discovery.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           mode : TBD</span>
<span class="sd">               Discovery mode.</span>

<span class="sd">           rootdir : str, optional</span>
<span class="sd">               Search root directory.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           list</span>
<span class="sd">               Search results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;query_dir() and find_files() are the worker functions&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;discover not implemented yet&quot;</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">pp</span></div>

    <span class="c1">#def query_dir(self,here=None):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Drill down and find directories in which ADMIT exists.</span>

    <span class="c1">#    Parameters</span>
    <span class="c1">#    ----------</span>
    <span class="c1">#    here : str, optional</span>
    <span class="c1">#        Directory to begin search; defaults to current directory.</span>

    <span class="c1">#    Returns</span>
    <span class="c1">#    -------</span>
    <span class="c1">#    list</span>
    <span class="c1">#        Search results.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    dlist = []</span>
    <span class="c1">#    if here == None:</span>
    <span class="c1">#        path = &quot;.&quot;</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        path = here</span>
    <span class="c1">#    n = 0</span>
    <span class="c1">#    for path, dirs, files in os.walk(path):</span>
    <span class="c1">#        # better not to loop, but os.path() for existence</span>
    <span class="c1">#        n = n + 1</span>
    <span class="c1">#        for f in files:</span>
    <span class="c1">#            if f == self.parfile: dlist.append(path)</span>
    <span class="c1">#    logging.debug(&quot;Queried &quot; + str(n) + &quot; directories, found &quot; + </span>
    <span class="c1">#        str(len(dlist)) + &quot; with a parfile&quot;)</span>
    <span class="c1">#    return dlist</span>

<div class="viewcode-block" id="Admit.find_bdp"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.find_bdp">[docs]</a>    <span class="k">def</span> <span class="nf">find_bdp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all bdp&#39;s in the current admit.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           None</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           list</span>
<span class="sd">               All \*.bdp files within the admit hierarchy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">len1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">())</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="s1">&#39;*.bdp&#39;</span><span class="p">):</span>
                <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">)[</span><span class="n">len1</span><span class="p">:])</span>
        <span class="c1">#print &quot;BDPs:&quot;,matches</span>
        <span class="k">return</span> <span class="n">matches</span></div>

<div class="viewcode-block" id="Admit.find_files"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.find_files">[docs]</a>    <span class="k">def</span> <span class="nf">find_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*.fits&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find files containing a wildcard pattern.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pattern : str, optional</span>
<span class="sd">            File name wildcard pattern.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            File names matching the pattern.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#@todo this should call util.find_files instead.</span>
        <span class="n">flist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flist</span></div>

<div class="viewcode-block" id="Admit.setdir"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.setdir">[docs]</a>    <span class="k">def</span> <span class="nf">setdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes current working directory. The directory is</span>
<span class="sd">        assumed to contain parameter file.</span>

<span class="sd">        .. note:: Deprecated.</span>
<span class="sd">            See pushd()/popd() for a better version.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dirname : str</span>
<span class="sd">            Directory to work in.</span>

<span class="sd">        create : bool, optional</span>
<span class="sd">            Whether to create the directory if it doesn&#39;t exist.</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        .. todo::</span>
<span class="sd">          the new mkdir() and self.baseDir are the way to work in ADMIT</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">mkdir_p</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="c1">#if not os.path.isdir(dirname):</span>
            <span class="c1">#    os.makedirs(dirname)</span>
            <span class="c1">#</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span> <span class="c1"># Python &gt;2.5</span>
                <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">dirname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ADMIT::setdir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dirname</span><span class="p">)</span></div>

<div class="viewcode-block" id="Admit.tesdir"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.tesdir">[docs]</a>    <span class="k">def</span> <span class="nf">tesdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Revert back from previous setdir (not recursive yet).</span>

<span class="sd">        .. note:: Deprecated.</span>
<span class="sd">            See pushd()/popd() for a better version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currDir</span><span class="p">)</span></div>

    <span class="c1">#def walkdir(self,dlist):</span>
    <span class="c1">#    &quot;&quot;&quot;Walks through directory list, printing what it finds</span>

    <span class="c1">#       Parameters</span>
    <span class="c1">#       ----------</span>
    <span class="c1">#       dlist : list of str</span>
    <span class="c1">#           Directory names to traverse.</span>

    <span class="c1">#       Returns</span>
    <span class="c1">#       -------</span>
    <span class="c1">#       None</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    print &quot;Walkdir &quot;, dlist</span>
    <span class="c1">#    for d in dlist:</span>
    <span class="c1">#        self.setdir(d)</span>
    <span class="c1">#        print &quot;d: &quot;, d</span>
    <span class="c1">#        par = pp.ParFile()</span>
    <span class="c1">#        print par.get(&#39;fits&#39;)</span>
    <span class="c1">#        print par.keys()</span>
    <span class="c1">#        self.tesdir()</span>

<div class="viewcode-block" id="Admit.read"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads a project.</span>

<span class="sd">           Notes</span>
<span class="sd">           -----</span>
<span class="sd">           Not implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare Admit for (archive) export. This means it has to loop over the BDP&#39;s</span>
<span class="sd">        and decide which items are going to copied over to admit.userData{}, as admit.xml</span>
<span class="sd">        is the only file external agents should have to look at.</span>

<span class="sd">        See also the script &quot;admit_export&quot; which is currently doing this work.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mode : str</span>
<span class="sd">            Export mode.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Not implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;Export: &quot;</span><span class="p">,</span> <span class="n">mode</span>


<div class="viewcode-block" id="Admit.write"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Writes out the admit.xml file, admit0.py script and</span>
<span class="sd">            project html files.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeXML</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateHTML</span><span class="p">()</span></div>

<div class="viewcode-block" id="Admit.writeXML"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.writeXML">[docs]</a>    <span class="k">def</span> <span class="nf">writeXML</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Writes out the admit.xml file and admit0.py script.</span>

<span class="sd">            Reading the XML file occurs in the constructor.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For multiflows, rewrite parent project XML files in case</span>
        <span class="c1"># any linked tasks were updated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

        <span class="c1"># get the dtd files, which acts as a guide</span>
        <span class="n">dtdRead</span> <span class="o">=</span> <span class="n">DtdReader</span><span class="p">(</span><span class="s2">&quot;admit.dtd&quot;</span><span class="p">)</span>
        <span class="n">dtd</span> <span class="o">=</span> <span class="n">dtdRead</span><span class="o">.</span><span class="n">getDtd</span><span class="p">()</span>

        <span class="n">dtdlist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># create the root node</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;ADMIT&quot;</span><span class="p">)</span>

        <span class="c1"># write out the each data member</span>
        <span class="n">unode</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;userData&quot;</span><span class="p">)</span>
        <span class="n">unode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">DICT</span><span class="p">)</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">st</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userData</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">nd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">attr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">tolist</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">attr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">unode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;ndarray&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span>
        <span class="n">unode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="p">))</span>
        <span class="n">temptext</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">tlist</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">temptext</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tlist</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">+=</span> <span class="n">l</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">unode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">tt</span>

        <span class="c1"># write out the summary data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summaryData</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

        <span class="n">pnode</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;project_id&quot;</span><span class="p">)</span>
        <span class="n">pnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">INT</span><span class="p">)</span>
        <span class="n">pnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">)</span>

        <span class="n">nnode</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="n">nnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span>
        <span class="n">temptext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">tlist</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">temptext</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tlist</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">+=</span> <span class="n">l</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">nnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">tt</span>

        <span class="n">fnode</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;flowmanager&quot;</span><span class="p">)</span>
        <span class="n">fnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">DICT</span><span class="p">)</span>                      <span class="c1">#HERE</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">)</span>

        <span class="n">pmnode</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;pmode&quot;</span><span class="p">)</span>
        <span class="n">pmnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">INT</span><span class="p">)</span>
        <span class="n">pmnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pmode</span><span class="p">)</span>

        <span class="n">ptnode</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;ptype&quot;</span><span class="p">)</span>
        <span class="n">ptnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">INT</span><span class="p">)</span>
        <span class="n">ptnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptype</span><span class="p">)</span>

        <span class="n">llnode</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;loglevel&quot;</span><span class="p">)</span>
        <span class="n">llnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">INT</span><span class="p">)</span>
        <span class="n">llnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="n">llnode</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;astale&quot;</span><span class="p">)</span>
        <span class="n">llnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">INT</span><span class="p">)</span>
        <span class="n">llnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astale</span><span class="p">)</span>

        <span class="n">lnnode</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;_loggername&quot;</span><span class="p">)</span>
        <span class="n">lnnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span>
        <span class="n">temptext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loggername</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">tlist</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">temptext</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tlist</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">+=</span> <span class="n">l</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">lnnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">tt</span>

        <span class="n">fnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;ndarray&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">([]))</span>
        <span class="n">fnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">([]))</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">{}</span>       <span class="c1"># make a simplified version of the connection map for writing out, it will be reconstructed on read in</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">:</span>
            <span class="n">tasks</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">temptext</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;connmap&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">_connmap</span><span class="p">,</span>
                        <span class="s2">&quot;bdpmap&quot;</span>  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">,</span>
                        <span class="s2">&quot;depsmap&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">_depsmap</span><span class="p">),</span>
                        <span class="s2">&quot;varimap&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">_varimap</span><span class="p">),</span>
                        <span class="s2">&quot;tasklevs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">_tasklevs</span><span class="p">,</span>
                        <span class="s2">&quot;tasks&quot;</span>   <span class="p">:</span> <span class="n">tasks</span><span class="p">})</span>

        <span class="n">tt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">tlist</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">temptext</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tlist</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">+=</span> <span class="n">l</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">fnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">tt</span>


        <span class="n">pmnode</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;projmanager&quot;</span><span class="p">)</span>
        <span class="n">pmnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">DICT</span><span class="p">)</span>
        <span class="n">pmnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;ndarray&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">([]))</span>
        <span class="n">pmnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">([]))</span>
        <span class="n">temptext</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">_baseDirs</span><span class="p">)</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">tlist</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">temptext</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tlist</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">+=</span> <span class="n">l</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">pmnode</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">tt</span>


        <span class="c1">#print &#39;Flow&#39;,fnode.text</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">:</span>
            <span class="n">root</span><span class="p">,</span> <span class="n">tdtd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="n">dtdlist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdtd</span>
        <span class="c1"># generate a string from the nodes</span>
        <span class="n">rough_string</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="c1"># make the text human readable</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">rough_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;/&quot;</span><span class="p">)</span>

        <span class="c1"># open the output file</span>
        <span class="n">outFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">+</span> <span class="s2">&quot;admit.xml&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="c1"># write out the header</span>
        <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;?xml version=</span><span class="se">\&quot;</span><span class="s2">1.0</span><span class="se">\&quot;</span><span class="s2"> ?&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># write out the dtd info at the top</span>
        <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;!DOCTYPE ADMIT [</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dtd</span><span class="p">:</span>
            <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dtdlist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">dtdlist</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>
                <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;]&gt;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># write out the data</span>
        <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

        <span class="n">outFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">script</span><span class="p">:</span>
            <span class="c1"># Don&#39;t name script &#39;admit.py&#39; to avoid confusing &#39;import admit&#39;.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;admit0.py&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Admit.clean"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to delete orphan bdp&#39;s (files and underlying data)</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">getFiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">delfiles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bdp</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">_bdp_out</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bdp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">bdp</span><span class="o">.</span><span class="n">xmlFile</span> <span class="o">+</span> <span class="s2">&quot;.bdp&quot;</span><span class="p">):</span>
                        <span class="n">delfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">delfiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>    
            <span class="n">delfiles</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">delfiles</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">files</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">bdp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">getBDP</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;DELETING&quot;</span><span class="p">,</span><span class="n">bdp</span><span class="o">.</span><span class="n">xmlFile</span>
            <span class="n">bdp</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">bdp</span></div>

<div class="viewcode-block" id="Admit.startDataServer"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.startDataServer">[docs]</a>    <span class="k">def</span> <span class="nf">startDataServer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts the data HTTP server.</span>
<span class="sd">           On a separate thread, start the http server on localhost:_data_browser_port</span>
<span class="sd">           that will allow web browsing of data products.   Also attempt</span>
<span class="sd">           to open a browser window at that URL. When this method returns,</span>
<span class="sd">           the variable self._data_browser_port will have the value of</span>
<span class="sd">           the port returned by the OS.  </span>
<span class="sd">           See util.AdmitHTTP.AdmitHTTPServer</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           None</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;A data server for this Admit object is already running on localhost:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_browser_port</span>
            <span class="k">return</span>

        <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_browser_port</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">AdmitHTTP</span><span class="o">.</span><span class="n">AdmitHTTPServer</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">docroot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">postcallback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onpost</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_browser_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">server_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Failed to get a port for the data browser.&quot;</span>
            <span class="k">return</span>

        <span class="n">threadName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_browser_port</span><span class="p">)</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">threadName</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_serveforever</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="c1"># create the attribute but we don&#39;t wish to save it in admit.xml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_browser_port</span>
        <span class="nb">print</span> <span class="s2">&quot;Your data server is started on </span><span class="si">%s</span><span class="s2">. Attempting to open a browser page with that URL. </span><span class="se">\n</span><span class="s2">The data server will halt when you quit your CASA session or otherwise destroy this ADMIT object.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_url</span>
        <span class="c1"># open page in new tab if possible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span></div>

<div class="viewcode-block" id="Admit.url"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.url">[docs]</a>    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the URL for the data browser</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        String representing localhost url on which data can be viewed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_url</span></div>

<div class="viewcode-block" id="Admit.export"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">casa</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1">#   &quot;&quot;&quot;export this Project to a gzipped tar file&quot;&quot;&quot;</span>
       <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_defaulttarfile</span><span class="p">()</span></div>
    
    <span class="k">def</span> <span class="nf">_defaulttarfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;return an export file name baseDir.tar.gz for this project</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span><span class="o">+</span><span class="s2">&quot;.tar.gz&quot;</span>  <span class="c1"># option for ZIP?</span>

    <span class="c1">#def runqueue(self):</span>
    <span class="c1">#    try:</span>
    <span class="c1">#        print &quot;callback queue get&quot;</span>
    <span class="c1">#        callback = self.queue.get(False)</span>
    <span class="c1">#    except Queue.Empty:</span>
    <span class="c1">#        pass</span>
    <span class="c1">#    print &quot;got&quot;</span>
    <span class="c1">#    callback()</span>

    <span class="k">def</span> <span class="nf">_onpost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is the callback function when a user edits ADMIT key words</span>
<span class="sd">        via form.html.  It will cycle through the tasks and call setkeys,</span>
<span class="sd">        then call admit.run().</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        payload: dict</span>
<span class="sd">            The data coming from the server.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None (maybe should return boolean if something failed?)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Should not be called directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#@todo: make this method a dictionary of methods?</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got command </span><span class="si">%s</span><span class="s2"> from browser&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span>
            <span class="c1">#print &quot;got command run&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]:</span>
                   <span class="n">taskid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;taskid&quot;</span><span class="p">])</span>
                   <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                       <span class="c1"># skip the hidden form inputs, which are only to</span>
                       <span class="c1"># sort out what task this is, and any other non-matching keys</span>
                       <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">haskey</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                          <span class="k">continue</span>
                       
                       <span class="c1"># Everything coming back from the web form is unicode.</span>
                       <span class="c1"># ast.literal_eval solves this, except for strings!</span>
                       <span class="c1"># (which would need nested quotes).  </span>
                       <span class="c1"># So first decode the value to a string. We don&#39;t need to</span>
                       <span class="c1"># decode the key to a string because python dictionaries</span>
                       <span class="c1"># with support unicode key access.</span>
                       <span class="n">value_enc</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
                       <span class="c1"># Then do type-checking</span>
                       <span class="c1"># of the AT&#39;s key to decide whether to invoke ast.literal_eval.  </span>
                       <span class="c1"># Note this may also be useful if the web form serialization </span>
                       <span class="c1"># is ever upgraded to preserve types (requires use of :types </span>
                       <span class="c1"># in form)</span>
                       <span class="c1"># See https://github.com/marioizquierdo/jquery.serializeJSON</span>
                       
                       <span class="c1">#print &quot;key=%s, val=%s type:%s&quot; % (key,t[key],type(t[key])) </span>
                        
                       <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value_enc</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">_keys</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                           <span class="c1">#print &quot;straight setkey&quot;</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value_enc</span><span class="p">)</span>
                       <span class="k">else</span><span class="p">:</span>
                           <span class="c1">#print &quot;AST key=%s, val=%s&quot; % (key,ast.literal_eval(t[key]) )</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
               <span class="nb">print</span> <span class="s2">&quot;Bummer, got exception </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
               <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
               <span class="k">return</span>
            
            <span class="k">try</span><span class="p">:</span>
               <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Re-running admit...&quot;</span><span class="p">)</span>
               <span class="nb">print</span> <span class="s2">&quot;[you may have hit return here]&quot;</span>
               <span class="c1">#self.queue.put(self.run)</span>
               <span class="c1">#self.runqueue()</span>
               <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">,</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">)</span>
               <span class="c1">#self.run(write=True)</span>
               <span class="c1">#formurl = self._data_url+&quot;/form.html&quot;</span>
               <span class="c1">#webbrowser.open(url=formurl,new=0)</span>
               <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;firefox&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                   <span class="c1">#print &quot;Damn you, Firefox!&quot;</span>
                   <span class="n">formurl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_url</span><span class="o">+</span><span class="s2">&quot;/form.html&quot;</span>
                   <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">formurl</span><span class="p">,</span><span class="n">new</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
               <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
               <span class="nb">print</span> <span class="s2">&quot;got exception on run </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
               <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;dryrun&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]:</span>
                   <span class="n">taskid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;taskid&quot;</span><span class="p">])</span>
                   <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                       <span class="c1"># skip the hidden form inputs, which are only to</span>
                       <span class="c1"># sort out what task this is, and any other non-matching keys</span>
                       <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">haskey</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                          <span class="k">continue</span>
                       
                       <span class="n">value_enc</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
                       <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value_enc</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">_keys</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                           <span class="c1">#print &quot;straight setkey&quot;</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value_enc</span><span class="p">)</span>
                       <span class="k">else</span><span class="p">:</span>
                           <span class="c1">#print &quot;AST key=%s, val=%s&quot; % (key,ast.literal_eval(t[key]) )</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="c1"># update all downstream stale flags, so that they</span>
            <span class="c1"># get marked in the HTML file.</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">connectInputs</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
               <span class="nb">print</span> <span class="s2">&quot;Bummer, got exception </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
               <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
               <span class="k">return</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1">#self.fm.dryrun()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;firefox&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1">#print &quot;damn you, Firefox!&quot;</span>
                    <span class="n">formurl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_url</span><span class="o">+</span><span class="s2">&quot;/form.html&quot;</span>
                    <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">formurl</span><span class="p">,</span><span class="n">new</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;got exception on dryrun </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;linelistbdp&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">taskid</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;taskid&quot;</span><span class="p">]</span>
                <span class="c1"># replace the data in the Linelist bdp table</span>
                <span class="n">llbdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">_bdp_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># this is an array of LineData objects</span>
                <span class="n">llbdp</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">]</span>
                <span class="c1"># @TODO the spectral image may no longer be correct,</span>
                <span class="c1"># if we are forcing or rejecting lines</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;disposition&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;reject&#39;</span><span class="p">:</span>
                       <span class="c1">#print &#39;keeping %s&#39; % t[&#39;uid&#39;]</span>
                       <span class="c1"># add the columns in order as a single array.</span>
                       <span class="c1"># Note the contents of t[] are all unicode strings so</span>
                       <span class="c1"># we have to convert to regular strings and floats</span>
                       <span class="c1"># as appropriate</span>
                       <span class="c1">#print float(t[&quot;frequency&quot;]), t[&quot;uid&quot;].encode(&quot;utf8&quot;), t[&quot;formula&quot;].encode(&quot;utf8&quot;), t[&quot;name&quot;].encode(&quot;utf8&quot;), t[&quot;transition&quot;].encode(&quot;utf8&quot;), float(t[&quot;velocity_raw&quot;]), float(t[&quot;elower&quot;]), float(t[&quot;eupper&quot;]), float(t[&quot;linestrength&quot;]), float(t[&quot;peakintensity_raw&quot;]), float(t[&quot;peakoffset_raw&quot;]), float(t[&quot;fwhm_raw&quot;]), t[&quot;startchan&quot;], t[&quot;endchan&quot;], float(t[&quot;peakrms&quot;]), t[&quot;blend&quot;]</span>

                       <span class="n">llbdp</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">LineData</span><span class="p">(</span>
                            <span class="n">frequency</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]),</span> 
                            <span class="n">uid</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> 
                            <span class="n">formula</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> 
                            <span class="n">transition</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;transition&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> 
                            <span class="n">velocity</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;velocity_raw&quot;</span><span class="p">]),</span>
                            <span class="n">energies</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;elower&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;eupper&quot;</span><span class="p">])],</span> 
                            <span class="n">linestrength</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;linestrength&quot;</span><span class="p">]),</span> 
                            <span class="n">peakintensity</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;peakintensity_raw&quot;</span><span class="p">]),</span>
                            <span class="n">peakoffset</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;peakoffset_raw&quot;</span><span class="p">]),</span> 
                            <span class="n">fwhm</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;fwhm_raw&quot;</span><span class="p">]),</span> 
                            <span class="n">chans</span><span class="o">=</span><span class="p">[</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;startchan&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;endchan&quot;</span><span class="p">])],</span> 
                            <span class="n">peakrms</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;peakrms&quot;</span><span class="p">]),</span> 
                            <span class="n">blend</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;blend&quot;</span><span class="p">])))</span>
                <span class="n">llbdp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span><span class="o">+</span><span class="n">llbdp</span><span class="o">.</span><span class="n">xmlFile</span><span class="p">)</span>

                <span class="c1"># all tasks following LineID_AT are now stale.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_markstalefrom</span><span class="p">(</span><span class="n">taskid</span><span class="p">)</span>

                <span class="c1"># replace the data table in the summary</span>
                <span class="n">titems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summaryData</span><span class="o">.</span><span class="n">getItemsByTaskID</span><span class="p">(</span><span class="n">taskid</span><span class="p">);</span>
                <span class="n">the_item</span> <span class="o">=</span> <span class="n">titems</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linelist&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">the_item</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                   <span class="n">the_item</span><span class="o">.</span><span class="n">getValue</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">llbdp</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
            
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;got exception on LineList_BDP write: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;view&quot;</span><span class="p">:</span>
            <span class="c1">#print &quot;got command view&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fullpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span><span class="o">+</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Opening file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fullpath</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">casa</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">:</span><span class="s1">&#39;z&#39;</span><span class="p">}</span>
                <span class="n">casa</span><span class="o">.</span><span class="n">imview</span><span class="p">(</span><span class="n">raster</span><span class="o">=</span><span class="n">fullpath</span><span class="p">,</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;got exception on viewer launch: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;forcereject&quot;</span><span class="p">:</span>
                <span class="n">taskid</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;taskid&quot;</span><span class="p">]</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">]</span>
                <span class="c1">#if &quot;uuid&quot; in payload:</span>
                <span class="c1">#    uid = payload[&quot;uuid&quot;]</span>
                <span class="c1">#else:</span>
                <span class="c1">#    print &quot;couldn&#39;t find uuid&quot;</span>
                <span class="c1">#    uid=None</span>
                <span class="c1"># @TODO the spectral image may no longer be correct,</span>
                <span class="c1"># if we are forcing or rejecting lines</span>

                <span class="c1"># these are a lists of tuples</span>
                <span class="n">currentforce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s1">&#39;force&#39;</span><span class="p">)</span>
                <span class="n">currentreject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s1">&#39;reject&#39;</span><span class="p">)</span>

                <span class="c1"># we append the submitted force/reject to the existing keyword</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;disposition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;force&#39;</span><span class="p">:</span>
                       <span class="n">currentforce</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]),</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span>\
                                    <span class="n">t</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;transition&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> \
                                    <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;velocity_raw&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;startchan&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;endchan&quot;</span><span class="p">])))</span>
                    <span class="k">elif</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;disposition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reject&#39;</span><span class="p">:</span>
                       <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                           <span class="n">currentreject</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
                       <span class="k">else</span><span class="p">:</span>
                           <span class="n">currentreject</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])))</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># for &#39;accept&#39; do nothing</span>
                       <span class="k">continue</span>

                <span class="c1"># remove duplicates</span>
                <span class="n">currentforce</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">currentforce</span><span class="p">))</span>
                <span class="n">currentreject</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">currentreject</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;force&#39;</span><span class="p">,</span><span class="n">currentforce</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;reject&#39;</span><span class="p">,</span><span class="n">currentreject</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_markstalefrom</span><span class="p">(</span><span class="n">taskid</span><span class="p">)</span>
                <span class="c1"># in this case the root task is also stale</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">markChanged</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentforce</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set force = </span><span class="si">%s</span><span class="s2"> for task </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s1">&#39;force&#39;</span><span class="p">),</span><span class="n">taskid</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentreject</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set reject = </span><span class="si">%s</span><span class="s2"> for task </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">taskid</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s1">&#39;reject&#39;</span><span class="p">),</span><span class="n">taskid</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeXML</span><span class="p">()</span>
                <span class="c1"># don&#39;t rewrite the lineIDeditor file because we just want to update the JSON</span>
                <span class="c1"># and not lose the user&#39;s edits</span>
                <span class="c1">#if uid == -1 or uid == &#39;-1&#39;: uid = None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">summaryData</span><span class="o">.</span><span class="n">html</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dotdiagram</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atToHTML</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logToHTML</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;exportfits&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">casaimage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;casaimage&quot;</span><span class="p">]))</span>
                <span class="n">fitsimage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;fitsimage&quot;</span><span class="p">]))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exporting CASA image </span><span class="si">%s</span><span class="s2"> to FITS </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">casaimage</span><span class="p">,</span><span class="n">fitsimage</span><span class="p">))</span>
                <span class="c1"># @todo add a checkbox or something to html to select overwrite </span>
                <span class="c1"># this requires some customization of the input tag, e.g.</span>
                <span class="c1">#http://duckranger.com/2012/06/pretty-file-input-field-in-bootstrap/</span>
                <span class="c1">#http://www.abeautifulsite.net/whipping-file-inputs-into-shape-with-bootstrap-3/ [bootstrap 3 only]</span>
                <span class="c1">#http://stackoverflow.com/questions/11235206/twitter-bootstrap-form-file-element-upload-button</span>
                <span class="kn">import</span> <span class="nn">casa</span>
                <span class="n">casa</span><span class="o">.</span><span class="n">exportfits</span><span class="p">(</span><span class="n">casaimage</span><span class="p">,</span><span class="n">fitsimage</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;got exception on exportfits: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Unrecognized command </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">command</span>


    <span class="k">def</span> <span class="nf">_dotdiagram</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the default dot diagram file name.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;admit.png&#39;</span>

    <span class="k">def</span> <span class="nf">_markstalefrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">taskid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark as stale all tasks downstream from given taskid, not including</span>
<span class="sd">           the root task.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           taskid: int</span>
<span class="sd">               The task ID of the root task.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           None </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nowstale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">downstream</span><span class="p">(</span><span class="n">taskid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">nowstale</span><span class="p">:</span>
            <span class="c1"># don&#39;t mark the root LineID_AT as stale</span>
            <span class="k">if</span> <span class="n">tid</span> <span class="o">==</span> <span class="n">taskid</span><span class="p">:</span>
               <span class="k">continue</span>
            <span class="c1"># but mark all it&#39;s children as stale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">markChanged</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_serveforever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method passed to thread by startDataServer.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Should not be called directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>

<div class="viewcode-block" id="Admit.setAstale"><a class="viewcode-back" href="../../module/admit/Admit.html#admit.Admit.Admit.setAstale">[docs]</a>    <span class="k">def</span> <span class="nf">setAstale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">astale</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dryrun</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to toggle the stale flags on all tasks based on a global admit stale</span>
<span class="sd">        for the sole purpose of admit_export to work.  It is dangerous to call this</span>
<span class="sd">        routine when not all tasks are either stale or not stale.</span>

<span class="sd">        This function needs to be called with True first, so it makes a stale backup,</span>
<span class="sd">        then during the 2nd False call, the stale backup is pushed back.</span>
<span class="sd">        </span>
<span class="sd">        @todo This is a patch solution for admit 1.1 - general solution needed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cnt0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">cnt1</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># stale</span>
        <span class="n">cnt2</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># running? (if it did, those crashed)</span>
        <span class="n">cnt3</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># enabled</span>
        <span class="k">if</span> <span class="n">astale</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">isstale</span><span class="p">():</span>  <span class="n">cnt1</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>  <span class="n">cnt2</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span><span class="p">():</span>  <span class="n">cnt3</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">astale</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">isstale</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ADMIT_STALE: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> were stale ; </span><span class="si">%d</span><span class="s2"> running, </span><span class="si">%d</span><span class="s2"> enabled, current setting is </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cnt1</span><span class="p">,</span><span class="n">cnt0</span><span class="p">,</span><span class="n">cnt2</span><span class="p">,</span><span class="n">cnt3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">astale</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ADMIT_STALE: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> were stale ; setting to </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cnt1</span><span class="p">,</span><span class="n">cnt0</span><span class="p">,</span><span class="n">astale</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">astale</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">astale</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">markChanged</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">astale</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">markChanged</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">markUpToDate</span><span class="p">()</span></div></div>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">&quot;MAIN not active yet, but this is where it will go&quot;</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ADMIT 1.0.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, The ADMIT Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>