<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>admit.at.LineID_AT &#8212; ADMIT 1.0.6 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="top" title="ADMIT 1.0.6 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">ADMIT 1.0.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for admit.at.LineID_AT</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; .. _Line-at-api:</span>

<span class="sd">   **LineID_AT** --- Identifies molecular lines in spectra.</span>
<span class="sd">   --------------------------------------------------------</span>

<span class="sd">   This module defines the LineID_AT class.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># system imports</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>

<span class="c1"># ADMIT imports</span>
<span class="kn">import</span> <span class="nn">admit</span>
<span class="kn">from</span> <span class="nn">admit.AT</span> <span class="k">import</span> <span class="n">AT</span>
<span class="kn">from</span> <span class="nn">admit.Summary</span> <span class="k">import</span> <span class="n">SummaryEntry</span>
<span class="kn">from</span> <span class="nn">admit.util</span> <span class="k">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">specutil</span>
<span class="kn">import</span> <span class="nn">admit.util.bdp_types</span> <span class="k">as</span> <span class="nn">bt</span>
<span class="kn">from</span> <span class="nn">admit.bdp.LineList_BDP</span> <span class="k">import</span> <span class="n">LineList_BDP</span>
<span class="kn">from</span> <span class="nn">admit.bdp.CubeSpectrum_BDP</span> <span class="k">import</span> <span class="n">CubeSpectrum_BDP</span>
<span class="kn">from</span> <span class="nn">admit.bdp.CubeStats_BDP</span> <span class="k">import</span> <span class="n">CubeStats_BDP</span>
<span class="kn">from</span> <span class="nn">admit.bdp.PVCorr_BDP</span> <span class="k">import</span> <span class="n">PVCorr_BDP</span>
<span class="kn">import</span> <span class="nn">admit.util.filter.Filter1D</span> <span class="k">as</span> <span class="nn">Filter1D</span>
<span class="kn">from</span> <span class="nn">admit.util</span> <span class="k">import</span> <span class="n">APlot</span>
<span class="kn">from</span> <span class="nn">admit.util.Image</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">admit.util.Tier1DB</span> <span class="k">import</span> <span class="n">Tier1DB</span>
<span class="kn">from</span> <span class="nn">admit.util.AdmitLogging</span> <span class="k">import</span> <span class="n">AdmitLogging</span> <span class="k">as</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">admit.util</span> <span class="k">import</span> <span class="n">SpectralLineSearch</span>
<span class="kn">from</span> <span class="nn">admit.util</span> <span class="k">import</span> <span class="n">LineData</span>
<span class="kn">from</span> <span class="nn">admit.util</span> <span class="k">import</span> <span class="n">Segments</span>


<span class="c1"># @todo  this code does not check upon exit that the LineID list is uniq, the U lines,</span>
<span class="c1">#        where we only used 3 digits (i.e. 1 MHz accuracy) it would too often find</span>
<span class="c1">#        duplicate frequencies to 3 digits. 4 would be better, but despite that these</span>
<span class="c1">#        cases have identical channel ranges, U freq still different.</span>
<span class="c1">#        Note there were 3 places where %.3f -&gt; %.4f now</span>
<span class="c1">#        The real fix is a) not allow same interval (U) lines</span>
<span class="c1">#                        b) double check on exit linelist is unique</span>
<span class="c1">#        See code around duplicate_lines[] where method b) is applied in 1.0.4.</span>

<span class="c1">#(see :ref:`tier-one-lineid`).</span>
<div class="viewcode-block" id="LineID_AT"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT">[docs]</a><span class="k">class</span> <span class="nc">LineID_AT</span><span class="p">(</span><span class="n">AT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Task for detecting and identifying spectral lines from input spectra. All</span>
<span class="sd">        input spectra are assumed to be from the same data set.</span>

<span class="sd">        See also :ref:`LineID-AT-design` for design documentation.</span>

<span class="sd">        The produced LineList_BDP contains a list of all spectral lines,</span>
<span class="sd">        possible identifications, and channel ranges, found in the input spectra.</span>
<span class="sd">        Additionally a spectral plot with overlayed lines is produced for each input</span>
<span class="sd">        spectrum.</span>

<span class="sd">        The line identification algorithm first looks for segments of spectral</span>
<span class="sd">        line emission. Spectral peaks are then searched for within these regions.</span>
<span class="sd">        Once spectral peaks are located, patterns are searched for (specifically</span>
<span class="sd">        patterns of rotation, expansion, and collapse). Each peak is then matched</span>
<span class="sd">        to ADMIT&#39;s *Tier 1* list, which contains the more common molecules and transitions.</span>
<span class="sd">        If no match is found then the CASA</span>
<span class="sd">        task *slsearch* or the *splatalogue* database is used to generate a potential</span>
<span class="sd">        line list based on the peak&#39;s frequency and line width. This list is narrowed down</span>
<span class="sd">        to a single identification by comparing the transition energies,</span>
<span class="sd">        constituent atoms, and line strength.</span>

<span class="sd">        If slsearch finds no results then the line is labeled as unidentified.</span>

<span class="sd">        **Keywords**</span>
<span class="sd">          **vlsr**: float</span>
<span class="sd">            VLSR of the source (km/s). Default: -999999.99.</span>

<span class="sd">          **numsigma**: float</span>
<span class="sd">            Minimum intensity, in terms of the rms noise of the individual sepctra, to consider a</span>
<span class="sd">            given channel to not be noise. In the case of CubeStats, where the units of the spectra</span>
<span class="sd">            are sigma, this refers to the rms noise of the sigma spectra (noise of the noise).</span>
<span class="sd">            Default: 5.0.</span>

<span class="sd">          **minchan**: int</span>
<span class="sd">            Minimum number of consecutive channels above numsigma to consider them</span>
<span class="sd">            part of a line. Default: 4.</span>

<span class="sd">          **maxgap**: int</span>
<span class="sd">            The maximum gap to allow between clusters of channels to consider</span>
<span class="sd">            them to be separate lines. Default: 3.</span>

<span class="sd">          **identifylines**: boolean</span>
<span class="sd">            If True then attempt to identify any detected spectral lines. If False, then just locate</span>
<span class="sd">            regions of line emission and stop. False is useful if the rest frequency/vlsr are not</span>
<span class="sd">            known.</span>
<span class="sd">            Default: True.</span>

<span class="sd">          **allowexotics**: bool</span>
<span class="sd">            If True then do not limit the molecules that can be detected. If False, do not allow</span>
<span class="sd">            transitions from molecules with &quot;exotic&quot; atoms to be included in lists. In</span>
<span class="sd">            this case an exotic atom is one that is uncommon, but possible to be</span>
<span class="sd">            detected in the right environment. The current list of &quot;exotic&quot; atoms is:</span>
<span class="sd">            &quot;Al&quot;, &quot;Cl&quot;, &quot;Mg&quot;, &quot;Mn&quot;, &quot;F&quot;, &quot;Li&quot;, &quot;Na&quot;, &quot;K&quot;, and &quot;Ti&quot;.</span>
<span class="sd">            Default: False.</span>

<span class="sd">          **recomblevel**: string</span>
<span class="sd">            What level of recombination line searching is requested. Three</span>
<span class="sd">            levels are available</span>

<span class="sd">            + `off`      no recombination lines are allowed in the results.</span>
<span class="sd">            + `shallow`  only H and He, alpha and beta lines are allowed in the results.</span>
<span class="sd">            + `deep`     any recombination line is allowed in the results.</span>

<span class="sd">            Default: &quot;shallow&quot;.</span>

<span class="sd">          **segment**: string</span>
<span class="sd">            The name of the segment finder algorithm to use; choices are: ASAP</span>
<span class="sd">            and ADMIT. (see :ref:`asapsegment` and :ref:`admitsegment` for</span>
<span class="sd">            details of each)</span>
<span class="sd">            Default: &quot;ADMIT&quot;.</span>

<span class="sd">          **online**: bool</span>
<span class="sd">            If True then use the online splatalogue interface for searching for transitions. If</span>
<span class="sd">            False the use the internal CASA slsearch. You must have an internet connection to use</span>
<span class="sd">            the splatalogue interface.</span>
<span class="sd">            Default: False.</span>

<span class="sd">          **smooth**: list</span>
<span class="sd">            Use this parameter to smooth the input spectrum.  Format is a list containing the name of the</span>
<span class="sd">            smoothing algorithm followed by the parameters for</span>
<span class="sd">            the algorithm, given in the order they are defined in the documentation.</span>
<span class="sd">            The algorithms are: boxcar, gaussian, hanning, savgol, triangle, and welch.</span>
<span class="sd">            All but savgol take a single integer parameter for the width. See :ref:`filter1D` for</span>
<span class="sd">            details on the individual algorithms and their keywords.</span>
<span class="sd">            To do no smoothing, set the value to []. Example: [&quot;boxcar&quot;, 7] will do</span>
<span class="sd">            a boxcar smooth with a width of 7.</span>
<span class="sd">            Default: [].</span>

<span class="sd">          **recalcnoise**: bool</span>
<span class="sd">            A boolean to indicate whether the noise should be recalculated after smoothing. True</span>
<span class="sd">            indicates that the noise should be recalculated, False indicates that the noise of the</span>
<span class="sd">            unsmoothed spectrum should be used.</span>
<span class="sd">            Default: False.</span>

<span class="sd">          **method**: dictionary</span>
<span class="sd">            A dictionary containing the peak finding algorithm(s) to use as the</span>
<span class="sd">            keys (string) and dictionary containing the keyword/value arguments</span>
<span class="sd">            for the algorithm as the value. Available methods are: PeakUtils,</span>
<span class="sd">            FindPeaksCWT, and PeakFinder (see :ref:`peakutils`, :ref:`findpeaks`,</span>
<span class="sd">            and :ref:`peakfinder` for the specifics of each). If more than one</span>
<span class="sd">            algorithm is given then each will be used in turn.</span>
<span class="sd">            Default: {&quot;PeakFinder&quot; : {&quot;thres&quot;    : 0.0,</span>
<span class="sd">            &quot;min_sep&quot;   : self.minchan,</span>
<span class="sd">            &quot;min_width&quot; : self.minchan}.</span>

<span class="sd">          **pattern**: str</span>
<span class="sd">            String indicating if pattern detection is done. Patterns are defined as sets of peaks</span>
<span class="sd">            which have the same separation which is caused by cloud rotation, expansion, etc. A</span>
<span class="sd">            detailed explanation is given in the design documentation. Pattern detection works well</span>
<span class="sd">            so long as there are not too many lines in the spectra. The code can determine whether</span>
<span class="sd">            this criteria has been met. Available modes are:</span>

<span class="sd">            + &#39;ON&#39;   Force pattern find to be on no matter what</span>
<span class="sd">            + &#39;AUTO&#39; Run pattern detection as long as there are not too many lines</span>
<span class="sd">            + &#39;OFF&#39;  No pattern detection</span>

<span class="sd">            Default: &quot;AUTO&quot;.</span>

<span class="sd">          **mode**: string</span>
<span class="sd">            If more than one peak finding algorithms is given in **method**, how</span>
<span class="sd">            should the results be interpreted. Available modes are:</span>

<span class="sd">            + `ONE` Consider a peak to be valid if it was found by any of the</span>
<span class="sd">                    given methods</span>
<span class="sd">            + `TWO` Consider a peak to be valid if it was found by at least two</span>
<span class="sd">                    of the methods. (if only 1 method is specified then this</span>
<span class="sd">                    choice is ignored)</span>
<span class="sd">            + `ALL` Consider a peak to be valid if it was detected by all given</span>
<span class="sd">                    methods.(if only 1 method is specified then this choice is ignored)</span>

<span class="sd">            Default: &quot;ONE&quot;.</span>

<span class="sd">          **tier1width**: float</span>
<span class="sd">            The width over which to search for Tier 1 lines in km/s. Any lines</span>
<span class="sd">            detected within this distance of a Tier 1 line will be identified</span>
<span class="sd">            as that line. Defaults to 300.0 for sources with a VLSR of 150 km/s</span>
<span class="sd">            and above, and 40.0 for sources with a VLSR below 150 km/s.</span>

<span class="sd">          **csub**: list</span>
<span class="sd">            The polynomial order to use for fitting the continuum of CubeStats</span>
<span class="sd">            and CubeSpec based spectra. All CubeStats based spectra must be</span>
<span class="sd">            continuum subtracted in order to obtain proper fits (peak, fwhm),</span>
<span class="sd">            but continuum subtraction for CubeSpectrum based spectra is optional.</span>
<span class="sd">            The first argument in the list is the order of polynomial to use for</span>
<span class="sd">            the CubeStats based spectrum and the second is the order of fit to</span>
<span class="sd">            use for CubeSpec based spectra.</span>
<span class="sd">            Default: [1, None]  (1st order for CubeStat and no fitting for</span>
<span class="sd">            Cubespec based spectra).</span>

<span class="sd">          **references**: str</span>
<span class="sd">            The filename of a references list for optional overplotting in the</span>
<span class="sd">            LineID plots. This is an ASCII file containing two columns:</span>
<span class="sd">            one column of frequencies (a float), and one column of a reference</span>
<span class="sd">            (line, a string). You can specify file references relative to</span>
<span class="sd">            `$ADMIT`, e.g., references=&quot;etc/ngc253_lines.list&quot;</span>
<span class="sd">            this is preferred to keep scripts portable, but an absolute filename</span>
<span class="sd">            is perfectly legal.</span>
<span class="sd">            Default: &quot;&quot;.</span>

<span class="sd">          **iterate**: bool</span>
<span class="sd">            If True then iterate for both the segment finder and the peak finder</span>
<span class="sd">            to make them both sensitive to wide and strong narrow lines.</span>
<span class="sd">            Default: True.</span>

<span class="sd">          **force**: list of tuples or LineData objects</span>
<span class="sd">            Force a given channel interval to be a specific line identification.</span>
<span class="sd">            If force is given, LineID_AT will not try to find any lines in the</span>
<span class="sd">            specified channel range, but rather take your input as correct.</span>
<span class="sd">            Format:</span>
<span class="sd">            [(frequency, UID, formula, name, transition, velocity, startchan, endchan)]</span>
<span class="sd">            Examples:</span>
<span class="sd">            [(115.2712, &#39;CO&#39;, &#39;CO(1-0)&#39;, &#39;carbon monoxide&#39;, &#39;J=1-0&#39;, 123.456, 23, 87)]</span>

<span class="sd">            [(342.998, &#39;Fred&#39;, &#39;Flintsone&#39;, &#39;unknown&#39;, &#39;unknown&#39;, 0, 64, 128),</span>
<span class="sd">             (238.012, &#39;My Favorite Molecule&#39;, &#39;N/A&#39;, &#39;N/A&#39;, &#39;N/A&#39;, 0, 4, 39)]</span>

<span class="sd">            [LineData(frequency=115.271, name=&#39;Carbon Monoxide&#39;, formula=&#39;CO&#39;,</span>
<span class="sd">                      uid=&#39;CO_115.271&#39;, transition=&#39;1-0&#39;, velocity=225.3,</span>
<span class="sd">                      chans=[25, 119])]</span>

<span class="sd">            Note uid is what is the label used in the plots that LineID_AT creates.</span>
<span class="sd">            LineData objects can be used instead of a tuple, as the contents of the tuple</span>
<span class="sd">            is converted to a LineData object internally anyway.</span>
<span class="sd">            Default: [].</span>

<span class="sd">          **reject**: list of tuples</span>
<span class="sd">            Reject a specific line identification.  Format: [(name, frequency)],</span>
<span class="sd">            e.g., [(&quot;carbon monoxide&quot;, 115.2712), (&quot;carbon monosulfide&quot;, 97.981)].</span>
<span class="sd">            Name is case insensitive. Frequency should be given to enough</span>
<span class="sd">            precision that it uniquely identifies a line (a comparison is made at the</span>
<span class="sd">            1 part in 10^6 for matching).</span>
<span class="sd">            If frequency is None, all lines from the given molecule</span>
<span class="sd">            will be rejected, i.e. [(&quot;carbon monoxide&quot;, None)] rejects all</span>
<span class="sd">            CO transitions, including isotopomers: 12CO, 13CO, C18O etc.</span>

<span class="sd">            Default: [].</span>

<span class="sd">        **Input BDPs**</span>
<span class="sd">          At least one of the following BDPs must be specified.</span>

<span class="sd">          **CubeSpectrum_BDP**: count: 1 (optional)</span>
<span class="sd">            Input spectrum, may contain several spectra. Typically the output</span>
<span class="sd">            of a `CubeSpectrum_AT &lt;CubeSpectrum_AT.html&gt;`_ or</span>
<span class="sd">            `GenerateSpectrum_AT &lt;GenerateSpectrum_AT.html&gt;`_.</span>

<span class="sd">          **CubeStats_BDP**: count: 1 (optional)</span>
<span class="sd">            Alternative input spectrum, as from a</span>
<span class="sd">            `CubeStats_AT &lt;CubeStats_AT.html&gt;`_.</span>

<span class="sd">          **PVCorr_BDP**: count: 1 (optional)</span>
<span class="sd">            Spectrum based on the output of `PVCorr_AT &lt;PVCorr_AT.html&gt;`_.</span>

<span class="sd">        **Output BDPs**</span>

<span class="sd">          **LineList_BDP**: count: 1</span>
<span class="sd">            List of spectral lines.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">keyval</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;vlsr&quot;</span>         <span class="p">:</span> <span class="o">-</span><span class="mf">999999.99</span><span class="p">,</span>
                <span class="s2">&quot;numsigma&quot;</span>     <span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
                <span class="s2">&quot;minchan&quot;</span>      <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s2">&quot;maxgap&quot;</span>       <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;identifylines&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;allowexotics&quot;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;recomblevel&quot;</span>  <span class="p">:</span> <span class="s2">&quot;shallow&quot;</span><span class="p">,</span>
                <span class="s2">&quot;segment&quot;</span>      <span class="p">:</span> <span class="s2">&quot;ADMIT&quot;</span><span class="p">,</span>
                <span class="s2">&quot;online&quot;</span>       <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;smooth&quot;</span>       <span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;recalcnoise&quot;</span>  <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;method&quot;</span>       <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;PeakFinder&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thresh&quot;</span>   <span class="p">:</span> <span class="mf">0.0</span><span class="p">}},</span>
                <span class="s2">&quot;pattern&quot;</span>      <span class="p">:</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mode&quot;</span>         <span class="p">:</span> <span class="s2">&quot;ONE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tier1width&quot;</span>   <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;csub&quot;</span>         <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="s2">&quot;references&quot;</span>   <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;iterate&quot;</span>      <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;force&quot;</span>        <span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;reject&quot;</span>       <span class="p">:</span> <span class="p">[]</span>
               <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxcar</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">AT</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">keyval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="s2">&quot;1.0.4&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bdp_in</span><span class="p">([(</span><span class="n">CubeSpectrum_BDP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">OPTIONAL</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">CubeStats_BDP</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">OPTIONAL</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">PVCorr_BDP</span><span class="p">,</span>       <span class="mi">1</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">OPTIONAL</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bdp_out</span><span class="p">([(</span><span class="n">LineList_BDP</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">_taskargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; generate a task argument string for the summary taskbar &quot;&quot;&quot;</span>
        <span class="n">taskargs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">identifylines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;identifylines&quot;</span><span class="p">)</span>
        <span class="n">vlsr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;vlsr&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vlsr</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">identifylines</span> <span class="ow">and</span> <span class="n">vlsr</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">999998</span><span class="p">:</span>
            <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; vlsr=</span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vlsr</span>
        <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; numsigma=&quot;</span>    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">))</span>
        <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; minchan=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">))</span>
        <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; maxgap=&quot;</span>  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;maxgap&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;smooth&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
           <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; smooth=&quot;</span>  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;smooth&quot;</span><span class="p">))</span>
           <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; recalcnoise=&quot;</span>  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;recalcnoise&quot;</span><span class="p">))</span>
        <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; csub=&quot;</span>    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;csub&quot;</span><span class="p">))</span>
        <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; iterate=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;iterate&quot;</span><span class="p">))</span>
        <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; tier1width=&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;tier1width&quot;</span><span class="p">))</span>
        <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; identifylines=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifylines</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;allowexotics&quot;</span><span class="p">):</span>
            <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; allowexotics=True&quot;</span>
        <span class="n">taskargs</span> <span class="o">=</span> <span class="n">taskargs</span> <span class="o">+</span> <span class="s2">&quot; recomb=&quot;</span>  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;recomblevel&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">taskargs</span>

<div class="viewcode-block" id="LineID_AT.integritycheck"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.integritycheck">[docs]</a>    <span class="k">def</span> <span class="nf">integritycheck</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to make sure all data have the same frequency axis. This is necessary since</span>
<span class="sd">            this AT works in both channel and frequency space, thus it must be ensured that the</span>
<span class="sd">            frequency of channel 1 is the same for all input spectra. This method will throw an</span>
<span class="sd">            exception if a mismatch is found, as further analysis might be compromised. The</span>
<span class="sd">            comparison of the frequencies is done at the 1 part in 10^6 level in case they are</span>
<span class="sd">            recorded at differing precisions.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get a list of all good (unmasked) channels in each input spectra</span>
        <span class="n">chans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">:</span>
            <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">sspec</span><span class="o">.</span><span class="n">spec</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sspec</span><span class="o">.</span><span class="n">freq</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">:</span>
            <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">spec</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">())</span>
        <span class="c1"># if there is only 1 input spectrum, the all is ok by default</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chans</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># first check the nearest channel</span>
        <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chans</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">chans</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">chan</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chans</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">issameinfreq</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">chan</span><span class="p">]):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Frequency axis are not the same in nearest channel.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="c1"># now check the farthest channel</span>
        <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chans</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">chans</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">chan</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chans</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">issameinfreq</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">chan</span><span class="p">]):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Frequency axis are not the same in farthest channel.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="LineID_AT.removepeaks"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.removepeaks">[docs]</a>    <span class="k">def</span> <span class="nf">removepeaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pks</span><span class="p">,</span> <span class="n">segments</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to remove peak points from a list if they are not inside of</span>
<span class="sd">            a segment and merge those that are close to each other</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            pks : list</span>
<span class="sd">                List of peak points, any units</span>

<span class="sd">            segments : list</span>
<span class="sd">                List of segment end points (two for each segment), must have</span>
<span class="sd">                same units as pks</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            List of peak points that are inside of the segments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
                <span class="c1"># only keep peaks that are inside of a segment</span>
                <span class="c1"># also remove any peaks that are in the first or last channel</span>
                <span class="c1"># of the spectra, as they are likely false peaks</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pk</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pk</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pk</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="n">npeaks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">peaks</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">peaks</span>
        <span class="c1"># now go through the remaining peaks and combine any that are within tol of each other</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span> \
                       <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="n">npeaks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">npeaks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="n">npeaks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">npeaks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="n">npeaks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">npeaks</span><span class="p">)</span></div>

<div class="viewcode-block" id="LineID_AT.findpatterns"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.findpatterns">[docs]</a>    <span class="k">def</span> <span class="nf">findpatterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">segments</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to search for patterns in the peaks. Specifically it is</span>
<span class="sd">            looking for pairs of peaks that are the same distance apart (within</span>
<span class="sd">            the tolerance). These can be an indicator of rotation/infall/etc.</span>
<span class="sd">            Only two patterns are allowed to overlap. See the design documentation</span>
<span class="sd">            for specifics</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            spec : array like</span>
<span class="sd">                The spectrum that is currently being worked on.</span>

<span class="sd">            points : numpy array</span>
<span class="sd">                Listing of peak points</span>

<span class="sd">            segments : list</span>
<span class="sd">                List of the segments for the current spectrum</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            A Peaks class containing the spectra, segments, peaks and patterns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialize the data class</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">Peaks</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">segments</span><span class="o">=</span><span class="n">segments</span><span class="p">)</span>
        <span class="n">delfrq</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">veltofreq</span><span class="p">(</span><span class="mi">650</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">maxsep</span> <span class="o">=</span> <span class="n">delfrq</span> <span class="o">/</span> <span class="n">spec</span><span class="o">.</span><span class="n">delta</span><span class="p">()</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="c1"># make a copy of the input points which will be modified as groups are located</span>
        <span class="n">singles</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="c1"># create a 2D array to catalog the distances between every peak</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)))</span>
        <span class="c1"># calculate the distance between every peak</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
                <span class="n">diffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="c1"># look for pairs of peaks that are a common distance apart (within the</span>
        <span class="c1"># given tolerance)</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)):</span>
                <span class="c1"># get each distance one at a time and compare it to the rest</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">diffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">dlist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># if this is the first time this distance has been found</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)):</span>
                        <span class="c1"># compare to all other points, skipping itself</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">l</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span> <span class="ow">or</span> <span class="n">diffs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">/</span> <span class="mf">3.0</span> \
                           <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">()[</span><span class="n">points</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">()[</span><span class="n">points</span><span class="p">[</span><span class="n">l</span><span class="p">]])</span>\
                           <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">()[</span><span class="n">points</span><span class="p">[</span><span class="n">l</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">()[</span><span class="n">points</span><span class="p">[</span><span class="n">k</span><span class="p">]]):</span>
                            <span class="k">continue</span>
                        <span class="c1"># if the distances from two pairs of points are close enough</span>
                        <span class="c1"># add it to the list of clusters</span>
                        <span class="k">if</span> <span class="n">maxsep</span> <span class="o">&gt;</span> <span class="n">diffs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">diff</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">&lt;</span> <span class="n">diffs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">diff</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">):</span>
                            <span class="c1"># if this is the first time for this distance then add</span>
                            <span class="c1"># both to the list</span>
                            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                                <span class="n">dlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                            <span class="n">dlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">])</span>
                            <span class="c1"># mark the current point as processed (i.e. set to 0.0)</span>
                            <span class="n">diffs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># if groups of points were detected then add them to the dictionary</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">clusters</span><span class="p">[</span><span class="n">diff</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlist</span>
        <span class="c1"># get the actual peak points rather then just indexes</span>
        <span class="n">clens</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">tl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">tl</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
            <span class="n">clusters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tl</span>
            <span class="n">clens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tl</span><span class="p">)</span>
        <span class="c1"># sort the list to make it easier to process</span>
        <span class="n">clist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">clens</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">clens</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="n">clist</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="n">spoints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">clist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">spoints</span><span class="p">:</span>
                    <span class="n">spoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">spoints</span><span class="p">:</span>
                    <span class="n">spoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># single spectral lines</span>
        <span class="c1"># spectral lines that appear to be in a pattern</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">spoints</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">clist</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># collect those that are very close together</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">):</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="c1"># reduce each of these to a single instance</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clist</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">&lt;</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span> <span class="ow">or</span> \
                           <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">&lt;</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">):</span>
                            <span class="k">del</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">clist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># remove any that appear multiple times</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                    <span class="n">multi</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">multi</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                    <span class="n">multi</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">multi</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">multi</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">ratios</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">/</span> \
                           <span class="nb">min</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                    <span class="n">ratios</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span>
                <span class="n">best</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">ratios</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">best</span> <span class="o">!=</span> <span class="n">v1</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">clusters</span><span class="p">[</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">k1</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="k">pass</span>
        <span class="c1"># only allow the two closest patterns for any given point</span>
        <span class="n">remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newcounts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">counts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
            <span class="n">counts</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                <span class="n">remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newcounts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">singles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># report the results</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s2">&quot; a&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Found </span><span class="si">%s</span><span class="s2"> potential pattern</span><span class="si">%s</span><span class="s2"> with</span><span class="si">%s</span><span class="s2"> separation</span><span class="si">%s</span><span class="s2"> of&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">),</span> <span class="n">exp</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">summary</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">%.1f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="p">])))</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; km/s&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="n">summary</span><span class="p">)</span>

        <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span> <span class="o">=</span> <span class="n">singles</span>
        <span class="n">peaks</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="n">clusters</span>
        <span class="n">peaks</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="n">newcounts</span>
        <span class="k">return</span> <span class="n">peaks</span></div>

<div class="viewcode-block" id="LineID_AT.narrowpossibles"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.narrowpossibles">[docs]</a>    <span class="k">def</span> <span class="nf">narrowpossibles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">possible</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to take the possible identifications of a spectral line and</span>
<span class="sd">            narrow it down to one possibility. This is done by comparing the</span>
<span class="sd">            upper state energies of the transitions, masses, and isotope counts.</span>
<span class="sd">            NEED DETAILS</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            possibles : list</span>
<span class="sd">                A list containing all of the possible identifications for the</span>
<span class="sd">                line</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            The listing of the most likely identification</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># now sort through the contents, find the one with the lowest upper state</span>
        <span class="c1"># energy</span>
        <span class="c1"># if we have too many non-standard isotopes then we should reconsider</span>
        <span class="c1"># for C the standard isotope is 12 and the non-standard ones are 13 and 14</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># one non-standard iostope is ok for higher mass molecules</span>
            <span class="k">if</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">50.0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># two non-standard isotopes is ok for middle weight molecules</span>
            <span class="k">elif</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">31.0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># three or more non-standard isotopes is only ok for the smallest molecules</span>
            <span class="k">elif</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">14.0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># defaults for searches</span>
        <span class="n">peakmass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lowmass</span> <span class="o">=</span> <span class="mi">100000000</span>
        <span class="n">lmindx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">lowen</span> <span class="o">=</span> <span class="mf">100000.0</span>
        <span class="n">leindx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># find out which one(s) have the lowest energy, and highest and lowest mass</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getupperenergy</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">lowen</span><span class="p">:</span>
                <span class="n">lowen</span> <span class="o">=</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getupperenergy</span><span class="p">()</span>
                <span class="n">leindx</span> <span class="o">=</span> <span class="n">j</span>
            <span class="k">if</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">peakmass</span><span class="p">:</span>
                <span class="n">peakmass</span> <span class="o">=</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lowmass</span><span class="p">:</span>
                <span class="n">lowmass</span> <span class="o">=</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">)</span>
                <span class="n">lmindx</span> <span class="o">=</span> <span class="n">j</span>

        <span class="c1"># if mass is too big compared to others, then we likely have another candidate</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">possible</span><span class="p">[</span><span class="n">leindx</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.6</span> <span class="o">*</span> <span class="n">possible</span><span class="p">[</span><span class="n">lmindx</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">))</span>\
           <span class="ow">and</span> <span class="p">(</span><span class="n">possible</span><span class="p">[</span><span class="n">lmindx</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="c1"># ignore ions</span>
            <span class="k">if</span> <span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="n">possible</span><span class="p">[</span><span class="n">lmindx</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lowen</span> <span class="o">=</span> <span class="n">possible</span><span class="p">[</span><span class="n">lmindx</span><span class="p">]</span><span class="o">.</span><span class="n">getupperenergy</span><span class="p">()</span>
                <span class="n">leindx</span> <span class="o">=</span> <span class="n">lmindx</span>

        <span class="c1"># otherwise we just go with lowest energy one</span>
        <span class="n">lname</span> <span class="o">=</span> <span class="n">possible</span><span class="p">[</span><span class="n">leindx</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span>
        <span class="n">qnum</span> <span class="o">=</span> <span class="n">possible</span><span class="p">[</span><span class="n">leindx</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span>
        <span class="c1"># loop through all possibilities and eliminate those with much different</span>
        <span class="c1"># energy and name (this collects transitions with hyperfine components)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">leindx</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">iscloseinE</span><span class="p">(</span><span class="n">lowen</span><span class="p">,</span> <span class="n">possible</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getupperenergy</span><span class="p">())</span> <span class="ow">and</span> <span class="n">possible</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">lname</span><span class="p">))</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="n">lowen</span> <span class="o">==</span> <span class="n">possible</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getupperenergy</span><span class="p">()</span> <span class="ow">and</span> <span class="n">possible</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">lname</span> <span class="ow">and</span> <span class="n">possible</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">qnum</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">possible</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">peakls</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">lsindx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># of the remaining ones (all from the same molecule), pick the one with</span>
        <span class="c1"># the highest line strength</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">peakls</span><span class="p">:</span>
                <span class="n">peakls</span> <span class="o">=</span> <span class="n">possible</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span>
                <span class="n">lsindx</span> <span class="o">=</span> <span class="n">j</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">possible</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">possible</span><span class="p">[</span><span class="n">lsindx</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">possible</span><span class="p">[</span><span class="n">lsindx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">possible</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blendcount</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">blendcount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">possible</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">possible</span></div>

<div class="viewcode-block" id="LineID_AT.checkreject"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.checkreject">[docs]</a>    <span class="k">def</span> <span class="nf">checkreject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to check possible lines against the list of rejected lines. Returns</span>
<span class="sd">            an edited version of the input data, removing those that match the reject list.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            lines : list or dict</span>
<span class="sd">                The line identifications to check for rejects.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Data in the same form as input, with rejected lines removed</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">rej</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">rej</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">rej</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">issameinfreq</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">rej</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">lines</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">tempr</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">rej</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">rej</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">rej</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">break</span>
                                <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">issameinfreq</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">rej</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">break</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                            <span class="n">tempr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">rej</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">rej</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">rej</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">issameinfreq</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">rej</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Impproper format for input lines, it must be a list or dictionary not a </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">lines</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="LineID_AT.generatepossibles"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.generatepossibles">[docs]</a>    <span class="k">def</span> <span class="nf">generatepossibles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to generate a list of possible molecular identifications</span>
<span class="sd">            given a frequency range. The methold calls slsearch and converts</span>
<span class="sd">            the output into a list.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            frq : list, length 2</span>
<span class="sd">                The frequency range to search, it is just passed to slsearch,</span>
<span class="sd">                and no error checking is done.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            A list containing the possible identifications. Each item in the</span>
<span class="sd">            list is a list itself containing the chemical formula, chemical</span>
<span class="sd">            name, rest frequency, transition quantum numbers, line strength,</span>
<span class="sd">            lower state energy, and upper state energy, in this order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkforcefreqs</span><span class="p">(</span><span class="n">frq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">sls</span> <span class="o">=</span> <span class="n">SpectralLineSearch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;online&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tier1freq</span><span class="p">)</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;exclude&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;atmospheric&quot;</span><span class="p">,</span> <span class="s2">&quot;potential&quot;</span><span class="p">,</span> <span class="s2">&quot;probable&quot;</span><span class="p">],</span>
              <span class="s2">&quot;include_only_nrao&quot;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
              <span class="s2">&quot;line_strengths&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ls1&quot;</span><span class="p">,</span> <span class="s2">&quot;ls2&quot;</span><span class="p">],</span>
              <span class="s2">&quot;energy_levels&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;el2&quot;</span><span class="p">,</span> <span class="s2">&quot;el4&quot;</span><span class="p">],</span>
              <span class="s2">&quot;fel&quot;</span> <span class="p">:</span> <span class="kc">True</span>
             <span class="p">}</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">sls</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">frq</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frq</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;recomblevel&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;allowexotics&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkreject</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;PJT&quot;</span><span class="p">,</span><span class="n">r</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="LineID_AT.gettier1"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.gettier1">[docs]</a>    <span class="k">def</span> <span class="nf">gettier1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to get the Tier 1 transitions that may be in the window.</span>
<span class="sd">            These transitions are stored in a small sqlite3 database inside of</span>
<span class="sd">            Admit. The molecules in the database are:</span>

<span class="sd">            CO      all transitions</span>

<span class="sd">            13CO    all transitions</span>

<span class="sd">            C18O    all transitions</span>

<span class="sd">            C17O    all transitions</span>

<span class="sd">            HCO+    all transitions</span>

<span class="sd">            H13CO+  all transitions</span>

<span class="sd">            DCO+    all transitions</span>

<span class="sd">            HDO     all transitions</span>

<span class="sd">            CCH     all transitions</span>

<span class="sd">            CN      excluding weakest lines</span>

<span class="sd">            13CN    excluding weakest lines</span>

<span class="sd">            HCN     all transitions</span>

<span class="sd">            DCN     all transitions</span>

<span class="sd">            H13CN   all transitions</span>

<span class="sd">            HN13C   all transitions</span>

<span class="sd">            HNC     all transitions</span>

<span class="sd">            N2H+    all transitions</span>

<span class="sd">            H2CO    excluding weakest lines</span>

<span class="sd">            CS      all transitions</span>

<span class="sd">            SiO     all transitions</span>

<span class="sd">            SO      all transitions</span>

<span class="sd">            HC3N    excluding weakest lines</span>


<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            tuple of dictionaries</span>
<span class="sd">                The first contains a list of single transitions and the</span>
<span class="sd">                strongest component of any lines with hyperfine splitting, the</span>
<span class="sd">                second contains a listing of all possible hyperfine components,</span>
<span class="sd">                lined with the main components in the first list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># connect to the database via the handler class</span>
        <span class="c1"># and get all possibilities based on the frequency end points of the window</span>
        <span class="n">t1db</span> <span class="o">=</span> <span class="n">Tier1DB</span><span class="p">()</span>
        <span class="n">t1db</span><span class="o">.</span><span class="n">searchtransitions</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="p">[</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">),</span> <span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)])</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">t1db</span><span class="o">.</span><span class="n">getall</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># go through the main results</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
            <span class="c1"># if the line has additional hyperfine components then get them from the</span>
            <span class="c1"># database and add them to the list</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hfs</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">t1db</span><span class="o">.</span><span class="n">searchhfs</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">))</span>
                <span class="n">hfsresults</span> <span class="o">=</span> <span class="n">t1db</span><span class="o">.</span><span class="n">getall</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">hfr</span> <span class="ow">in</span> <span class="n">hfsresults</span><span class="p">:</span>
                    <span class="n">hline</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">hline</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="n">hfr</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                    <span class="n">hline</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">getplain</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">hfr</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                    <span class="n">hline</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">,</span> <span class="n">hfr</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">))</span>
                    <span class="n">hline</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">hfr</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)))</span>
                    <span class="n">hfs</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hline</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># close the handle</span>
        <span class="n">t1db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># return the main components and the associated hyperfine lines</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkreject</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">hfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkreject</span><span class="p">(</span><span class="n">hfs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span><span class="p">,</span> <span class="n">hfs</span></div>

<div class="viewcode-block" id="LineID_AT.getpeaks"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.getpeaks">[docs]</a>    <span class="k">def</span> <span class="nf">getpeaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to get the peaks from the input spectrum. It calls the requested</span>
<span class="sd">            peak finder and can iterate over the inputs to find both wider weaker lines as</span>
<span class="sd">            well as stronger narrower ones. The iteration is done by conserving the product of</span>
<span class="sd">            numsigma * minchan. The first run keeps both values as they were input, subsequent</span>
<span class="sd">            runs decrease the minchan by 1 and increase numsigma so that the product is conserved.</span>
<span class="sd">            This is repeated as long as minchan &gt; 1. The results of the iterations are merged together</span>
<span class="sd">            and a single list of peaks is returned.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            method : str</span>
<span class="sd">                The peak finding method to use</span>

<span class="sd">            args : dict</span>
<span class="sd">                The arguments to send to the peak finder</span>

<span class="sd">            spec : array like</span>
<span class="sd">                The input spectrum which is searched for peaks</span>

<span class="sd">            segments : list</span>
<span class="sd">                A list of the previously detected segments</span>

<span class="sd">            iterate : bool</span>
<span class="sd">                If True then iterate over the minchan ans threshold to detect narrow strong lines.</span>
<span class="sd">                Default : False</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            List of the peak points in channel space</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wdth</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">area</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;min_width&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;thresh&quot;</span><span class="p">]</span>
        <span class="n">initwidth</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;min_width&quot;</span><span class="p">]</span>
        <span class="n">initthresh</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;thresh&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">wdth</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
            <span class="n">temppks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;min_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initwidth</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;thresh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initthresh</span>
            <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">curpk</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="c1"># only run the boxcar smoothing if the segment is wide enough, this avoids suppressing</span>
            <span class="c1"># narrow lines</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcar</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wdth</span><span class="p">)):</span>
                    <span class="n">fltr</span> <span class="o">=</span> <span class="n">Filter1D</span><span class="o">.</span><span class="n">Filter1D</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;boxcar&quot;</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">wdth</span><span class="p">[</span><span class="n">i</span><span class="p">]})</span>
                    <span class="n">spec3</span> <span class="o">=</span> <span class="n">fltr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                    <span class="n">spec3</span> <span class="o">*=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">wdth</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">newpk</span> <span class="o">=</span> <span class="n">spec3</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">newpk</span> <span class="o">&gt;</span> <span class="n">curpk</span> <span class="ow">and</span> <span class="n">wdth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">curpk</span> <span class="o">=</span> <span class="n">newpk</span>
                        <span class="n">last</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">fltr</span> <span class="o">=</span> <span class="n">Filter1D</span><span class="o">.</span><span class="n">Filter1D</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;boxcar&quot;</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">wdth</span><span class="p">[</span><span class="n">last</span><span class="p">]})</span>
                <span class="n">spec3</span> <span class="o">=</span> <span class="n">fltr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec3</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;min_width&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">iterate</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;min_width&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">iterate</span><span class="p">):</span>
                <span class="n">pf</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">getClass</span><span class="p">(</span><span class="s2">&quot;util.peakfinder&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">pk</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pk</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">temppks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">iterate</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;min_width&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;thresh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span> <span class="o">/</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;min_width&quot;</span><span class="p">]</span>
            <span class="n">drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temppks</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temppks</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">temppks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">temppks</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">initwidth</span><span class="p">:</span>
                        <span class="n">drop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temppks</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop</span><span class="p">:</span>
                    <span class="n">pks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temppks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">pks</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pks</span></div>

<div class="viewcode-block" id="LineID_AT.counthfclines"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.counthfclines">[docs]</a>    <span class="k">def</span> <span class="nf">counthfclines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">hflines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to count the number of hyperfine lines that match a given offset.</span>
<span class="sd">            The offsets are determined by the wings of a cluster. This returns</span>
<span class="sd">            the number of hyperfine components that match emission features.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            chfc : dict</span>
<span class="sd">                Dictionary containing the channel ranges and other line attributes</span>
<span class="sd">                of clusters</span>

<span class="sd">            shfc : dict</span>
<span class="sd">                Dictionary containing the channel ranges and other line attributes</span>
<span class="sd">                of single lines</span>

<span class="sd">            peak : Peaks instance</span>
<span class="sd">                Peaks instance used to calculate channel ranges</span>

<span class="sd">            wiggle : float</span>
<span class="sd">                The amount of wiggle room to allow for a match in channel space</span>

<span class="sd">            offset : float</span>
<span class="sd">                The offset to use for the calculations</span>

<span class="sd">            hflines : list</span>
<span class="sd">                List of all possible hyperfine components</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Int, the number of matches</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">hfl</span> <span class="ow">in</span> <span class="n">hflines</span><span class="p">:</span>
            <span class="c1"># get the expected channel range for the hyperfine component for the</span>
            <span class="c1"># given wiggle room and offset</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">hfl</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">wiggle</span> <span class="o">-</span> <span class="n">offset</span><span class="p">),</span> <span class="n">peak</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">hfl</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">wiggle</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)]</span>
            <span class="n">low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># now look for matches in clusters</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">chfc</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">hi</span> <span class="ow">or</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">hi</span> <span class="ow">or</span> \
                    <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="c1"># if the current hyperfine component is already located then stop searching</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># now search the single lines</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">shfc</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">hi</span> <span class="ow">or</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">hi</span> <span class="ow">or</span> \
                    <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>
            <span class="c1"># return the results</span>
        <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="LineID_AT.taghfclines"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.taghfclines">[docs]</a>    <span class="k">def</span> <span class="nf">taghfclines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">hflines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to identify hyperfine components in a given spectrum. If components</span>
<span class="sd">            are blended then the strongest line (based on transition line strength)</span>
<span class="sd">            is added to the transitions and all others are added to the blended lines.</span>
<span class="sd">            All are connected by the blend number.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            chfc : dict</span>
<span class="sd">                Dictionary containing the channel ranges and other line attributes</span>
<span class="sd">                of clusters</span>

<span class="sd">            shfc : dict</span>
<span class="sd">                Dictionary containing the channel ranges and other line attributes</span>
<span class="sd">                of single lines</span>

<span class="sd">            peak : Peaks instance</span>
<span class="sd">                Peaks instance used to calculate channel ranges</span>

<span class="sd">            wiggle : float</span>
<span class="sd">                The amount of wiggle room to allow for a match in channel space</span>

<span class="sd">            offset : float</span>
<span class="sd">                The offset to use for the calculations</span>

<span class="sd">            hflines : list</span>
<span class="sd">                List of all possible hyperfine components</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Tuple containing the identification(s) and blend(s)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifications</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">blends</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">possibleblends</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># combine the input dictionaries</span>
        <span class="n">combhfc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">combhfc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chfc</span><span class="p">)</span>
        <span class="n">combhfc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shfc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">hfl</span> <span class="ow">in</span> <span class="n">hflines</span><span class="p">:</span>
            <span class="c1"># get the channel ranges for the given offset and wiggle room</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">hfl</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">wiggle</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">peak</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">hfl</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">wiggle</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)]</span>
            <span class="n">low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
            <span class="c1"># look to see if any match, if one does add it to the dictionary</span>
            <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">combhfc</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">hi</span> <span class="ow">or</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">hi</span> <span class="ow">or</span> \
                    <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">hfline</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">hfl</span><span class="p">)</span>
                    <span class="n">hfline</span><span class="o">.</span><span class="n">setfreqs</span><span class="p">([</span><span class="n">peak</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">peak</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
                    <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">possibleblends</span><span class="p">:</span>
                        <span class="n">possibleblends</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfline</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">possibleblends</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">hfline</span><span class="p">]</span>
                    <span class="k">break</span>
        <span class="c1"># need to find where main line belongs</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">possibleblends</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="c1"># if there is only 1 line then just add it to the identifications</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">hfline</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">hfline</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">freq</span> <span class="o">-</span> <span class="n">hfline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                               <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])]],</span>
                               <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])]],</span>
                               <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                               <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span>
                               <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">3</span><span class="p">]),</span>
                               <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">freq</span> <span class="o">-</span> <span class="n">hfline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))),</span>
                               <span class="s2">&quot;blend&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
                <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">hfline</span>
            <span class="c1"># if there are several then find the strongest and add the rest to the blends</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxstr</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">mindx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="c1"># find the strongest</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ident</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">ident</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxstr</span><span class="p">:</span>
                        <span class="n">maxstr</span> <span class="o">=</span> <span class="n">ident</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span>
                        <span class="n">mindx</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">mindx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">mindx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">hfl</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="n">mindx</span><span class="p">])</span>
                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">freq</span> <span class="o">-</span> <span class="n">hfl</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                <span class="c1"># add the strongest to the identifications, connect it to the other(s) via</span>
                <span class="c1"># the blendcount parameter</span>
                <span class="n">hfl</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                            <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])]],</span>
                            <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])]],</span>
                            <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span>
                            <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">3</span><span class="p">]),</span>
                            <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span>
                            <span class="s2">&quot;blend&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">blendcount</span><span class="p">})</span>
                <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">hfl</span>
                <span class="k">del</span> <span class="n">ident</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span>
                <span class="c1"># add the others to the blends</span>
                <span class="k">for</span> <span class="n">hfl</span> <span class="ow">in</span> <span class="n">ident</span><span class="p">:</span>
                    <span class="n">hfline</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">hfl</span><span class="p">)</span>
                    <span class="n">hfline</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">freq</span> <span class="o">-</span> <span class="n">hfline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                                   <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])]],</span>
                                   <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">combhfc</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])]],</span>
                                   <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                   <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                   <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                   <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span>
                                   <span class="s2">&quot;blend&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">blendcount</span><span class="p">})</span>
                    <span class="n">blends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hfline</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blendcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># remove any identified lines from the peaks instance</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peak</span><span class="o">.</span><span class="n">fcenters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">idn</span> <span class="ow">in</span> <span class="n">ident</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">idn</span><span class="o">.</span><span class="n">getfstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="n">idn</span><span class="o">.</span><span class="n">getfend</span><span class="p">():</span>
                        <span class="n">fc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">idn</span><span class="o">.</span><span class="n">getfstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">idn</span><span class="o">.</span><span class="n">getfend</span><span class="p">():</span>
                        <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="n">idn</span><span class="o">.</span><span class="n">getfstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">idn</span><span class="o">.</span><span class="n">getfend</span><span class="p">():</span>
                        <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peak</span><span class="o">.</span><span class="n">fcenters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">peak</span><span class="o">.</span><span class="n">fsingles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">fc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">peak</span><span class="o">.</span><span class="n">fsingles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">fc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">fsingles</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">idn</span> <span class="ow">in</span> <span class="n">ident</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">idn</span><span class="o">.</span><span class="n">getfstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">peak</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">idn</span><span class="o">.</span><span class="n">getfend</span><span class="p">():</span>
                        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># remove any already identified clusters and peaks</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fc</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">peak</span><span class="o">.</span><span class="n">fcenters</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
            <span class="n">peak</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="n">identifications</span><span class="p">,</span> <span class="n">blends</span></div>

<div class="viewcode-block" id="LineID_AT.gettier1line"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.gettier1line">[docs]</a>    <span class="k">def</span> <span class="nf">gettier1line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chans</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to return a line from the detected tier1 list. The line is found</span>
<span class="sd">            by looking for an entry which is between the end points of the input segment.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            chans : list</span>
<span class="sd">                Two element list of the start and end channels to search over</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            A listing of any tier1 line which overlaps with the segment.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">t1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tier1list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t1</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">t1</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="ow">and</span> <span class="n">t1</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">t1</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span></div>

<div class="viewcode-block" id="LineID_AT.checkforcefreqs"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.checkforcefreqs">[docs]</a>    <span class="k">def</span> <span class="nf">checkforcefreqs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to check that detected segments do not overlap with any force segments in</span>
<span class="sd">            frequency space</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            segs : list</span>
<span class="sd">                List of the segments (in channel space) to check</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            List of segments that do not overlap with force segments</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefreqs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">frq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">frq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">frq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                    <span class="n">frq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">frq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">frq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                    <span class="n">frq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.0001</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">frq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.0001</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frq</span></div>

<div class="viewcode-block" id="LineID_AT.checkforcesegs"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.checkforcesegs">[docs]</a>    <span class="k">def</span> <span class="nf">checkforcesegs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to check that detected segments do not overlap with any force segments in</span>
<span class="sd">            channel space</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            segs : list</span>
<span class="sd">                List of the segments (in channel space) to check</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            List of Segments objects that do not overlap with force segments</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">finalsegs</span> <span class="o">=</span> <span class="n">Segments</span><span class="p">(</span><span class="n">nchan</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">segs</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcechans</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">finalsegs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">finalsegs</span></div>

<div class="viewcode-block" id="LineID_AT.checkforcechans"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.checkforcechans">[docs]</a>    <span class="k">def</span> <span class="nf">checkforcechans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">chs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to check that no non-force segments overlap with force segments</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            peaks : Peaks instance</span>
<span class="sd">                Instance of the Peaks class containing all of the line peaks</span>

<span class="sd">            chs : list</span>
<span class="sd">                List containing a pair of entries for the beginning and ending</span>
<span class="sd">                channel numbers for the segment.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            List, containing a pair of entries, the start and end channels for the</span>
<span class="sd">            segment, modified so that it does not overlap any tier1 segments.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chans</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">chs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcechans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chans</span></div>

<div class="viewcode-block" id="LineID_AT.checktier1chans"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.checktier1chans">[docs]</a>    <span class="k">def</span> <span class="nf">checktier1chans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">chs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to check that no non-tier1 segments overlap with tier1 segments</span>
<span class="sd">            in the same spectrum.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            peaks : Peaks instance</span>
<span class="sd">                Instance of the Peaks class containing all of the line peaks</span>

<span class="sd">            chs : list</span>
<span class="sd">                List containing a pair of entries for the beginning and ending</span>
<span class="sd">                channel numbers for the segment.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            List, containing a pair of entries, the start and end channels for the</span>
<span class="sd">            segment, modified so that it does not overlap any tier1 segments.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chans</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">chs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tier1chans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chans</span></div>

<div class="viewcode-block" id="LineID_AT.checkfit"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.checkfit">[docs]</a>    <span class="k">def</span> <span class="nf">checkfit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">segment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to determine if the given Gaussian fit paramters exceed 1.5 times the intensity</span>
<span class="sd">            of the peak channel, and are contained within the encompassing segment. Adjustments are</span>
<span class="sd">            are made if necessary.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            peaks : Peaks instance</span>
<span class="sd">                The Peaks instance used to supply the spectrum and segments</span>

<span class="sd">            peak : float</span>
<span class="sd">                The peak intensity within the segment</span>

<span class="sd">            params : array like</span>
<span class="sd">                The list of Gaussian parameters from a fit (peak, center (offset from freq), FWHM)</span>

<span class="sd">            freq : float</span>
<span class="sd">                The central frequency of the fit.</span>

<span class="sd">            segment : list</span>
<span class="sd">                Segment containing the peak</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Tuple containing the corrected fit parameters</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peak</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">freq</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="ow">or</span>\
           <span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">freq</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">]))):</span>
            <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="LineID_AT.identify"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.identify">[docs]</a>    <span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">tier1</span><span class="p">,</span> <span class="n">hfs</span><span class="p">,</span> <span class="n">isstats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ispvcorr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to identify lines, given their peak locations. This is a</span>
<span class="sd">            complex method that works as follows:</span>

<span class="sd">            - search for any Tier 1 lines in the spectrum</span>

<span class="sd">              + start with any detected patterns</span>
<span class="sd">              + then search for individual lines</span>
<span class="sd">              + any peak detected within &#39;tier1width&#39; of the expected rest</span>
<span class="sd">                frequency of the Tier 1 line will be marked as being from that</span>
<span class="sd">                transition (defaults to 300 km/s for a source vlsr &gt; 150 and 40 km/s</span>
<span class="sd">                for a source vlsr &lt;= 150 km/s)</span>
<span class="sd">              + if an identified line has hyperfine components, search for them</span>
<span class="sd">                before proceeding to the next transition in the Tier 1 list</span>

<span class="sd">            - search for any remaining transitions in the spectrum</span>

<span class="sd">              + start with any detected patterns</span>
<span class="sd">              + then search any remaining single peaks</span>

<span class="sd">            - when working with detected (really suspected) patterns both the</span>
<span class="sd">              emission/absorption peaks and the central frequency are searched</span>
<span class="sd">              for, since the pattern may not be due to rotation, but may be</span>
<span class="sd">              due to emission from multiple related transitions (internal molecular</span>
<span class="sd">              rotation)</span>
<span class="sd">            - any detected lines in a given spectrum will be compared to detected peaks</span>
<span class="sd">              of any other spectra. Specifically this helps to identify transitions</span>
<span class="sd">              due to source rotation where the CubeStats spectrum see all of the emission</span>
<span class="sd">              (both red and blue shifted peaks), but a CubeSpectrum may ony see the red peak,</span>
<span class="sd">              this red only peak will be correctly identified because it matches part of the</span>
<span class="sd">              pattern from the CubeStats input.</span>


<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            peaks : Peaks instance</span>
<span class="sd">                A class containing both the sinlge peaks and those which may be</span>
<span class="sd">                grouped by a common offset</span>

<span class="sd">            noise : float</span>
<span class="sd">                The rms noise of the root spectrum</span>

<span class="sd">            tier1 : dict</span>
<span class="sd">                Dictionary containing any Tier 1 lines located in the band, rest</span>
<span class="sd">                frequency is the key, transition data are the values</span>

<span class="sd">            hfs : dict</span>
<span class="sd">                Dictionary of hyperfine components that correspond to any lines</span>
<span class="sd">                in tier1.</span>

<span class="sd">            isstats : bool</span>
<span class="sd">                Whether or not a CubeStats based spectrum is being processed.</span>
<span class="sd">                Default : False</span>

<span class="sd">            ispvcorr : bool</span>
<span class="sd">                Whether or not a PVCorr based spectrum is being processed.</span>
<span class="sd">                Specifically this disables the use of velocity offsets.</span>
<span class="sd">                Default: False</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            List of the line identifications</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifications</span> <span class="o">=</span> <span class="p">{}</span>              <span class="c1"># list for all identified lines</span>
        <span class="n">blends</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">foundcomplex</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">slen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">)</span>
        <span class="n">fwidth</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="c1"># do the Tier 1 search first</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tier1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hfs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># first generate channel ranges for all lines and clusters</span>
                <span class="n">chfc</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">shfc</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">100000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1000000</span><span class="p">]],</span>
                                  <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]],</span>
                                  <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]]}</span>

                    <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
                    <span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getchannels</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">cid</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">chan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">peak</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">)]</span>
                    <span class="n">pkrms</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="n">noise</span>
                    <span class="k">if</span> <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">chan</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">chan</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">popt</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">chan</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">chan</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">fwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                        <span class="c1"># get a better number for the FWHM</span>
                        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fitgauss1D</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">chan</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq</span><span class="p">,</span>
                                                      <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">chan</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                                      <span class="n">par</span><span class="o">=</span><span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">fwidth</span><span class="p">)</span>
                        <span class="n">popt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfit</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">popt</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">)))</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                     <span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">))]</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">mpk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                  <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

                        <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                            <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span> <span class="o">/</span> <span class="n">noise</span>
                        <span class="n">tfwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">2.355</span><span class="p">)</span>
                        <span class="n">chfc</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">peak</span><span class="p">,</span> <span class="n">tfwhm</span><span class="p">,</span> <span class="n">pkrms</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="n">peakw</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])]</span>
                        <span class="n">seg</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">seg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                                <span class="n">popt</span> <span class="o">=</span> <span class="p">[</span><span class="n">peakw</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="p">[</span><span class="n">st</span><span class="p">,</span> <span class="n">en</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>
                                <span class="k">if</span> <span class="n">st</span><span class="o">==</span><span class="n">en</span><span class="p">:</span>
                                    <span class="n">fwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">]</span><span class="o">-</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                                
                                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fitgauss1D</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                                              <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                                              <span class="n">par</span><span class="o">=</span><span class="p">[</span><span class="n">peakw</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">fwidth</span><span class="p">)</span>
                                <span class="n">popt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfit</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">peakw</span><span class="p">,</span> <span class="n">popt</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])))</span>
                            <span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">peakw</span><span class="p">,</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                                 <span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]))]</span>
                            <span class="n">tfwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">2.355</span><span class="p">)</span>
                            <span class="n">pkrms</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                                <span class="n">pkrms</span> <span class="o">/=</span> <span class="n">noise</span>

                            <span class="n">chfc</span><span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">tfwhm</span><span class="p">,</span> <span class="n">pkrms</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">:</span>
                    <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getchannels</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">chans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">))</span>
                    <span class="n">en</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">))</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">en</span><span class="p">))</span>
                    <span class="n">peak</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">st</span><span class="o">==</span><span class="n">en</span><span class="p">:</span>
                        <span class="n">fwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">]</span><span class="o">-</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                        <span class="nb">print</span> <span class="s2">&quot;PJT1&quot;</span><span class="p">,</span><span class="n">fwidth</span>

                    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fitgauss1D</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq</span><span class="p">,</span>
                                                  <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">par</span><span class="o">=</span><span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                                                                    <span class="n">width</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">fwidth</span><span class="p">)</span>
                    <span class="n">fcenter</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">+</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="n">pkrms</span> <span class="o">=</span> <span class="n">peak</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                        <span class="n">pkrms</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="n">noise</span>
                    <span class="n">shfc</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">)),</span> <span class="n">peak</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">pkrms</span><span class="p">)</span>
            <span class="c1"># determine what width to use for uncertainty</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">150.0</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="mf">300.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="mf">40.0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;tier1width&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;tier1width&quot;</span><span class="p">)</span>
            <span class="n">fwidth</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">veltofreq</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">centerfreq</span><span class="p">())</span>
            <span class="c1"># go through each possible transition and see if we have a line that is a possibility</span>
            <span class="k">for</span> <span class="n">trans</span><span class="p">,</span> <span class="n">t1</span> <span class="ow">in</span> <span class="n">tier1</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">todel</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># go through all detected clusters</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">noskip</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">doskip</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fwidth</span> <span class="o">&lt;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwidth</span><span class="p">:</span>
                        <span class="n">doskip</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">noskip</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))]</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">skip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">noskip</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">minval</span> <span class="o">=</span> <span class="n">noskip</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">noskip</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">noskip</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">minval</span><span class="p">:</span>
                            <span class="n">skip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="c1"># search though the clusters first</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span> <span class="ow">or</span> <span class="p">(</span><span class="n">doskip</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="c1"># center peak</span>
                    <span class="n">centerpeak</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">wings</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">cent</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="p">{},</span>
                            <span class="s2">&quot;blend&quot;</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="p">{},</span>
                            <span class="s2">&quot;blend&quot;</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="p">{},</span>
                             <span class="s2">&quot;blend&quot;</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="n">ccount</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">lcount</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="c1"># parameters hold the values of line fits and start and end channels</span>
                    <span class="c1"># peak intensity, frequency offset, width in GHz, start chan, end chan</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                                  <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]],</span>
                                  <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]]}</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">-</span>
                                <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="c1"># frequencies of offset lines</span>
                    <span class="c1"># rought width</span>
                    <span class="n">twidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">twidth</span>

                    <span class="k">if</span> <span class="n">centerpeak</span><span class="p">:</span>
                        <span class="c1"># calculate starting and ending channels to extract for the line fitting</span>
                        <span class="c1"># cut will will trace the entire line, down to the cutoff level,</span>
                        <span class="c1"># keeping in mind the window edges</span>
                        <span class="n">seg</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">seg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
                            <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="p">[</span><span class="n">st</span><span class="p">,</span> <span class="n">en</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>
                            <span class="n">peak</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
                            <span class="n">hpk</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="mf">2.0</span>
                            <span class="k">if</span> <span class="n">st</span><span class="o">==</span><span class="n">en</span><span class="p">:</span>
                                <span class="n">fwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">]</span><span class="o">-</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                                
                            <span class="c1"># get a better number for the FWHM</span>
                            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fitgauss1D</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span>
                                                          <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                                          <span class="n">par</span><span class="o">=</span><span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">fwidth</span><span class="p">)</span>

                            <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                             <span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">k</span><span class="p">))]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="n">peakw</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                        <span class="n">seg</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">seg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="p">[</span><span class="n">st</span><span class="p">,</span> <span class="n">en</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>
                            <span class="k">if</span> <span class="n">st</span><span class="o">==</span><span class="n">en</span><span class="p">:</span>
                                <span class="n">fwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">]</span><span class="o">-</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                            
                            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fitgauss1D</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                          <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                                          <span class="n">par</span><span class="o">=</span><span class="p">[</span><span class="n">peakw</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">twidth</span><span class="p">],</span> <span class="n">width</span> <span class="o">=</span> <span class="n">fwidth</span><span class="p">)</span>
                            <span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">peakw</span><span class="p">,</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                                 <span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">]))]</span>

                    <span class="c1"># check the center frequency first</span>
                    <span class="n">closest</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="mf">100000.</span>
                    <span class="k">for</span> <span class="n">frq</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fwidth</span> <span class="o">&lt;=</span> <span class="n">frq</span> <span class="o">&lt;=</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwidth</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">frq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="p">:</span>
                                <span class="n">closest</span> <span class="o">=</span> <span class="n">frq</span>
                                <span class="n">distance</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">frq</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">closest</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">closest</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># if the line has hyperfine components then there is a lot of work to do</span>
                        <span class="k">if</span> <span class="n">trans</span> <span class="ow">in</span> <span class="n">hfs</span><span class="p">:</span>
                            <span class="c1"># how much jitter do we allow  ##### should be a parameter of the AT</span>
                            <span class="n">wiggle</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">fwidth</span>
                            <span class="n">offset</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                            <span class="n">hflines</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hfs</span><span class="p">[</span><span class="n">trans</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                            <span class="n">hflines</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                            <span class="c1"># figure out all the possible main offsets</span>
                            <span class="n">ldiff</span> <span class="o">=</span> <span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                            <span class="n">rdiff</span> <span class="o">=</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                            <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                            <span class="n">mpk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                      <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                                <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span> <span class="o">/</span> <span class="n">noise</span>
                            <span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">en</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">tfwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">abs</span><span class="p">((</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span>
                                                           <span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])))</span>

                            <span class="n">ccount</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="c1"># see what we get if we assume wing 0 is the main line</span>
                            <span class="k">if</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fwidth</span> <span class="o">&lt;</span> <span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwidth</span><span class="p">:</span>
                                <span class="n">lcount</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">counthfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span> <span class="n">ldiff</span><span class="p">,</span>
                                                                 <span class="n">hflines</span><span class="p">)</span>

                            <span class="c1"># see what we get if wing 1 is the main line</span>
                            <span class="k">if</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fwidth</span> <span class="o">&lt;</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwidth</span><span class="p">:</span>
                                <span class="n">rcount</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">counthfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span> <span class="n">rdiff</span><span class="p">,</span>
                                                                 <span class="n">hflines</span><span class="p">)</span>

                            <span class="c1"># see what we get if the center is the main line</span>
                            <span class="c1"># if there is no central peak</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">centerpeak</span><span class="p">:</span>
                                <span class="c1"># see who had the best matches</span>
                                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">lcount</span><span class="p">,</span> <span class="n">rcount</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                      <span class="n">offset</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="k">elif</span> <span class="n">lcount</span> <span class="o">==</span> <span class="n">rcount</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ldiff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rdiff</span><span class="p">):</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">ldiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">rdiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="k">elif</span> <span class="n">lcount</span> <span class="o">&gt;</span> <span class="n">rcount</span><span class="p">:</span>
                                    <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                      <span class="n">ldiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                      <span class="n">rdiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="n">cent</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tempid</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">cent</span><span class="p">[</span><span class="s2">&quot;blend&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tblend</span>
                            <span class="c1"># if there is a center peak</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ccount</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counthfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                                                             <span class="n">hflines</span><span class="p">)</span>
                                <span class="n">m</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ccount</span><span class="p">,</span> <span class="n">lcount</span><span class="p">,</span> <span class="n">rcount</span><span class="p">)</span>    <span class="c1"># highest number of matches</span>
                                <span class="n">offset</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                                <span class="c1"># minimum offset value</span>
                                <span class="n">mo</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ldiff</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rdiff</span><span class="p">))</span>
                                <span class="c1"># if all have only 1 possible, then go with the center</span>
                                <span class="k">if</span> <span class="n">ccount</span> <span class="o">==</span> <span class="n">rcount</span> <span class="o">==</span> <span class="n">lcount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                      <span class="n">offset</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="c1"># if all have the same number of possibles, then go with the one that is closest to</span>
                                <span class="c1"># the expected rest frequency</span>
                                <span class="k">elif</span> <span class="n">ccount</span> <span class="o">==</span> <span class="n">rcount</span> <span class="o">==</span> <span class="n">lcount</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">mo</span> <span class="o">==</span> <span class="n">offset</span><span class="p">:</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">offset</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="k">elif</span> <span class="n">mo</span> <span class="o">==</span> <span class="n">rdiff</span><span class="p">:</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">rdiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">ldiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="c1"># if the center has the most possibilities</span>
                                <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="n">ccount</span><span class="p">:</span>
                                    <span class="c1"># if it has the same as wing 1 then decide by offset</span>
                                    <span class="k">if</span> <span class="n">ccount</span> <span class="o">==</span> <span class="n">rcount</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">rdiff</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">rdiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="c1"># if it has the same as wing 0 then decide by offset</span>
                                    <span class="k">elif</span> <span class="n">ccount</span> <span class="o">==</span> <span class="n">lcount</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">ldiff</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">ldiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="c1"># otherwise just go with the center</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">offset</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="c1"># if wing 1 has the most possibles</span>
                                <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="n">rcount</span><span class="p">:</span>
                                    <span class="c1"># if it has the same as the center then decide by offset</span>
                                    <span class="k">if</span> <span class="n">ccount</span> <span class="o">==</span> <span class="n">rcount</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">rdiff</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">rdiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="c1"># if it has the same as wing 0 then decide by offset</span>
                                    <span class="k">elif</span> <span class="n">rcount</span> <span class="o">==</span> <span class="n">lcount</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">rdiff</span> <span class="o">&lt;</span> <span class="n">ldiff</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">rdiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">ldiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="c1"># otherwise just go with wing 1</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">rdiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="c1"># if wing 0 has the most possibles</span>
                                <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="n">lcount</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">lcount</span> <span class="o">==</span> <span class="n">rcount</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">ldiff</span> <span class="o">&lt;</span> <span class="n">rdiff</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">ldiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">rdiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="k">elif</span> <span class="n">ccount</span> <span class="o">==</span> <span class="n">lcount</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">ldiff</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">ldiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">ldiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This should never happen&quot;</span><span class="p">)</span>
                                <span class="n">cent</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tempid</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">cent</span><span class="p">[</span><span class="s2">&quot;blend&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tblend</span>

                        <span class="c1"># the easy case of no hyperfine components</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                            <span class="n">mpk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                      <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                                <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span> <span class="o">/</span> <span class="n">noise</span>
                            <span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">en</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">tfwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">abs</span><span class="p">((</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span>
                                                           <span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])))</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
                            <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                                         <span class="s2">&quot;peakintensity&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">mpk</span><span class="p">),</span>
                                         <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span><span class="p">),</span>
                                         <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">tfwhm</span><span class="p">),</span>
                                         <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">st</span><span class="p">)],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">en</span><span class="p">)]],</span>
                                         <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">st</span><span class="p">)],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">en</span><span class="p">)]],</span>
                                         <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkrms</span><span class="p">),</span>
                                         <span class="s2">&quot;blend&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
                            <span class="n">identifications</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1chans</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">st</span><span class="p">,</span> <span class="n">en</span><span class="p">])</span>
                            <span class="n">frq</span> <span class="o">=</span> <span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">st</span><span class="p">),</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">en</span><span class="p">)]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1freq</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">frq</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frq</span><span class="p">)])</span>
                            <span class="n">todel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="c1"># wing 0</span>
                    <span class="n">closest</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="mf">100000.</span>
                    <span class="k">for</span> <span class="n">frq</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="n">wng</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fwidth</span> <span class="o">&lt;=</span> <span class="n">wng</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwidth</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">wng</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="p">:</span>
                                <span class="n">closest</span> <span class="o">=</span> <span class="n">frq</span>
                                <span class="n">distance</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">wng</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">closest</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">closest</span>
                        <span class="n">wings</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="p">[</span><span class="n">closest</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># if the line has hyperfine components then there is a lot of work to do</span>
                        <span class="k">if</span> <span class="n">trans</span> <span class="ow">in</span> <span class="n">hfs</span><span class="p">:</span>
                            <span class="c1"># how much jitter do we allow  ##### should be a parameter of the AT</span>
                            <span class="n">rlen</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">llen</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">wiggle</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">fwidth</span>
                            <span class="n">poffset</span> <span class="o">=</span> <span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                            <span class="n">ldiff</span> <span class="o">=</span> <span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                            <span class="n">rdiff</span> <span class="o">=</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                            <span class="n">hflines</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hfs</span><span class="p">[</span><span class="n">trans</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                            <span class="n">hflines</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                            <span class="n">mpk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                      <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                                <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span> <span class="o">/</span> <span class="n">noise</span>
                            <span class="n">tfwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">abs</span><span class="p">((</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span>
                                                           <span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])))</span>

                            <span class="c1"># figure out all the possible main offsets</span>
                            <span class="n">rdiff</span> <span class="o">=</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                            <span class="n">st</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">en</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">llen</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">counthfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span> <span class="n">ldiff</span><span class="p">,</span> <span class="n">hflines</span><span class="p">)</span>
                            <span class="c1"># see what we get if wing 1 is the main line</span>
                            <span class="n">tempid</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">if</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fwidth</span> <span class="o">&lt;</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwidth</span><span class="p">:</span>
                                <span class="n">rlen</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">counthfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span> <span class="n">rdiff</span><span class="p">,</span>
                                                               <span class="n">hflines</span><span class="p">)</span>
                            <span class="c1"># see what we get if the center is the main line</span>
                            <span class="c1"># if there is no central peak</span>
                                <span class="n">m</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lcount</span><span class="p">,</span> <span class="n">rcount</span><span class="p">)</span>    <span class="c1"># highest number of matches</span>
                                <span class="n">offset</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                                <span class="n">ldiff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ldiff</span><span class="p">)</span>
                                <span class="c1"># minimum offset value</span>
                                <span class="n">mo</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ldiff</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rdiff</span><span class="p">))</span>
                                <span class="c1"># if all have only 1 possible, then go with the center</span>
                                <span class="k">if</span> <span class="n">rlen</span> <span class="o">==</span> <span class="n">llen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                      <span class="n">rdiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>

                                <span class="c1"># if all have the same number of possibles, then go with the one that is closest to</span>
                                <span class="c1"># the expected rest frequency</span>
                                <span class="k">elif</span> <span class="n">rlen</span> <span class="o">==</span> <span class="n">llen</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">mo</span> <span class="o">==</span> <span class="n">offset</span><span class="p">:</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">rdiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">ldiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="n">rlen</span><span class="p">:</span>
                                    <span class="c1"># if it has the same as the center then decide by offset</span>
                                    <span class="k">if</span> <span class="n">rlen</span> <span class="o">==</span> <span class="n">llen</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">rdiff</span> <span class="o">&lt;</span> <span class="n">ldiff</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">rdiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">ldiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="c1"># otherwise just go with wing 1</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">rdiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="c1"># if wing 0 has the most possibles</span>
                                <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="n">llen</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">llen</span> <span class="o">==</span> <span class="n">rlen</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">ldiff</span> <span class="o">&lt;</span> <span class="n">rdiff</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">ldiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span>
                                                                              <span class="n">wiggle</span><span class="p">,</span> <span class="n">rdiff</span><span class="p">,</span>
                                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span>
                                                                          <span class="n">ldiff</span><span class="p">,</span> <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This should never happen&quot;</span><span class="p">)</span>
                            <span class="n">left</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tempid</span><span class="p">)</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">left</span><span class="p">[</span><span class="s2">&quot;blend&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tblend</span>
                        <span class="c1"># the easy case of no hyperfine components</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                            <span class="n">mpk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                      <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                                <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span> <span class="o">/</span> <span class="n">noise</span>
                            <span class="n">rdiff</span> <span class="o">=</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>

                            <span class="n">tfwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">abs</span><span class="p">((</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span>
                                                           <span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])))</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
                            <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                                         <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">mpk</span><span class="p">),</span>
                                         <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span><span class="p">),</span>
                                         <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">tfwhm</span><span class="p">),</span>
                                         <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]],</span>
                                         <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]],</span>
                                         <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkrms</span><span class="p">),</span>
                                         <span class="s2">&quot;blend&quot;</span> <span class="p">:</span> <span class="mi">0</span>
                                        <span class="p">})</span>
                            <span class="n">identifications</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1chans</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                            <span class="n">frq</span> <span class="o">=</span> <span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                   <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1freq</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">frq</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frq</span><span class="p">)])</span>

                            <span class="n">todel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

                    <span class="n">closest</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="mf">100000.</span>
                    <span class="k">for</span> <span class="n">frq</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="n">wng</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fwidth</span> <span class="o">&lt;=</span> <span class="n">wng</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwidth</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">wng</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="p">:</span>
                                <span class="n">closest</span> <span class="o">=</span> <span class="n">frq</span>
                                <span class="n">distance</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">wng</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">closest</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">wings</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="p">[</span><span class="n">closest</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># if the line has hyperfine components then there is a lot of work to do</span>
                        <span class="k">if</span> <span class="n">trans</span> <span class="ow">in</span> <span class="n">hfs</span><span class="p">:</span>
                            <span class="n">poffset</span> <span class="o">=</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                            <span class="n">wings</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="c1"># how much jitter do we allow  ##### should be a parameter of the AT</span>
                            <span class="n">wiggle</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">fwidth</span>
                            <span class="n">offset</span> <span class="o">=</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                            <span class="n">hflines</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hfs</span><span class="p">[</span><span class="n">trans</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                            <span class="n">hflines</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                            <span class="n">mpk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                      <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                                <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span> <span class="o">/</span> <span class="n">noise</span>
                            <span class="n">tfwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">abs</span><span class="p">((</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span>
                                                           <span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])))</span>
                            <span class="n">rdiff</span> <span class="o">=</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                            <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">wiggle</span><span class="p">,</span> <span class="n">rdiff</span><span class="p">,</span>
                                                              <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                            <span class="n">right</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tempid</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">right</span><span class="p">[</span><span class="s2">&quot;blend&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tblend</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                            <span class="n">mpk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                      <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                                <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span> <span class="o">/</span> <span class="n">noise</span>

                            <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                            <span class="n">tfwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">abs</span><span class="p">((</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span>
                                                           <span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])))</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
                            <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                                         <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">mpk</span><span class="p">),</span>
                                         <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span><span class="p">),</span>
                                         <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">tfwhm</span><span class="p">),</span>
                                         <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]],</span>
                                         <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]],</span>
                                         <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkrms</span><span class="p">),</span>
                                         <span class="s2">&quot;blend&quot;</span> <span class="p">:</span> <span class="mi">0</span>
                                        <span class="p">})</span>
                            <span class="n">identifications</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1chans</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                            <span class="n">frq</span> <span class="o">=</span> <span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1freq</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">frq</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frq</span><span class="p">)])</span>

                            <span class="n">todel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">trans</span> <span class="ow">in</span> <span class="n">hfs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">identifications</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">cent</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">tier1list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tier1chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">))</span>
                                <span class="n">frq</span> <span class="o">=</span> <span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()),</span>
                                       <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tier1freq</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">frq</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frq</span><span class="p">)])</span>
                                <span class="n">blends</span> <span class="o">+=</span> <span class="n">cent</span><span class="p">[</span><span class="s2">&quot;blend&quot;</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]):</span>
                            <span class="n">identifications</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">left</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">left</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tier1list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">))</span>
                            <span class="n">frq</span> <span class="o">=</span> <span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">left</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()),</span>
                                   <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">left</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1freq</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">frq</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frq</span><span class="p">)])</span>
                            <span class="n">blends</span> <span class="o">+=</span> <span class="n">left</span><span class="p">[</span><span class="s2">&quot;blend&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">identifications</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">right</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">right</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tier1list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">))</span>
                            <span class="n">frq</span> <span class="o">=</span> <span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">right</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()),</span>
                                   <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">right</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tier1freq</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">frq</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frq</span><span class="p">)])</span>
                            <span class="n">blends</span> <span class="o">+=</span> <span class="n">right</span><span class="p">[</span><span class="s2">&quot;blend&quot;</span><span class="p">]</span>

                    <span class="n">chanrange</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">freqs</span> <span class="o">=</span> <span class="n">identifications</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="n">chans</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
                        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                    <span class="n">temppeak</span> <span class="o">=</span> <span class="n">Peaks</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">fsingles</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">singles</span><span class="o">=</span><span class="n">chans</span><span class="p">,</span> <span class="n">segments</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">segments</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getchannels</span><span class="p">(</span><span class="n">temppeak</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">ident</span><span class="p">),</span> <span class="n">asfreq</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">chanrange</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">chanrange</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">ch</span> <span class="o">=</span> <span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">chanrange</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">chanrange</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">setstart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="nb">min</span><span class="p">(</span><span class="n">ch</span><span class="p">)))])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">setend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ch</span><span class="p">)))])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>
                    <span class="n">delcent</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">chanrange</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">delcent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                                <span class="k">break</span>
                    <span class="n">delsingle</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">delsingle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">chanrange</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">delsingle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">delsingle</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">delcent</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">delsingle</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># if no hits then check the wings</span>
                <span class="c1"># now do the single peaks</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">closest</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="mf">1000000.</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">)):</span>
                        <span class="n">seg</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span><span class="c1"># or haveit:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fwidth</span> <span class="o">&lt;</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwidth</span> <span class="ow">or</span>\
                           <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fwidth</span> <span class="o">&lt;</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwidth</span> <span class="ow">or</span>\
                           <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="p">:</span>
                                <span class="n">distance</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                <span class="n">closest</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">if</span> <span class="n">closest</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># get the start and end channels</span>
                        <span class="n">seg</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">]))</span>
                        <span class="n">fseg</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfsegment</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">])</span>

                        <span class="k">if</span> <span class="n">seg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="c1"># cannot just go with first peak, must find closest peak</span>
                        <span class="p">[</span><span class="n">st</span><span class="p">,</span> <span class="n">en</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>

                        <span class="k">if</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fwidth</span> <span class="o">&lt;</span> <span class="n">fseg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwidth</span> <span class="ow">or</span>\
                           <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fwidth</span> <span class="o">&lt;</span> <span class="n">fseg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwidth</span> <span class="ow">or</span>\
                           <span class="n">fseg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fseg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">trans</span> <span class="ow">in</span> <span class="n">hfs</span><span class="p">:</span>
                                <span class="c1"># allow some uncertainty in the widths</span>
                                <span class="n">wiggle</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">fwidth</span>
                                <span class="n">hflines</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hfs</span><span class="p">[</span><span class="n">trans</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">hflines</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                                <span class="n">offset</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                                <span class="n">tempid</span><span class="p">,</span> <span class="n">tblend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taghfclines</span><span class="p">(</span><span class="n">chfc</span><span class="p">,</span> <span class="n">shfc</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                                                                  <span class="n">hflines</span> <span class="o">+</span> <span class="p">[</span><span class="n">t1</span><span class="p">])</span>
                                <span class="n">identifications</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tempid</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">tempid</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">tier1list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tier1chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempid</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">))</span>
                                <span class="n">frq</span> <span class="o">=</span> <span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">tempid</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()),</span>
                                       <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">tempid</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tier1freq</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">frq</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frq</span><span class="p">)])</span>
                                <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                                <span class="n">blends</span> <span class="o">+=</span> <span class="n">tblend</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">],</span>
                                                          <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">peak</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">])]</span>
                                <span class="n">maxwidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">veltofreq</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">])</span>
                                <span class="n">breakpoint</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">closest</span><span class="p">]]</span>
                                                <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">closest</span><span class="p">]]</span>
                                                <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">st</span><span class="o">==</span><span class="n">en</span><span class="p">:</span>
                                    <span class="n">fwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">]</span><span class="o">-</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                                    
                                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fitgauss1D</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">],</span>
                                                              <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                                              <span class="n">par</span><span class="o">=</span><span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">fwidth</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                                    <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1.17741</span>
                                <span class="n">fcenter</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span> <span class="o">+</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">*</span> <span class="mf">1.17741</span>
                                <span class="n">pkrms</span> <span class="o">=</span> <span class="n">peak</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                                    <span class="n">pkrms</span> <span class="o">/=</span> <span class="n">noise</span>
                                <span class="n">delta</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">],</span> <span class="n">delta</span><span class="p">)</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
                                <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                                             <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">peak</span><span class="p">),</span>
                                             <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span><span class="p">),</span>
                                             <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">),</span>
                                             <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">st</span><span class="p">)],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">en</span><span class="p">)]],</span>
                                             <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">st</span><span class="p">)],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">en</span><span class="p">)]],</span>
                                             <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkrms</span><span class="p">),</span>
                                             <span class="s2">&quot;blend&quot;</span> <span class="p">:</span> <span class="mi">0</span>
                                            <span class="p">})</span>
                                <span class="n">identifications</span><span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tier1list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tier1chans</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">st</span><span class="p">,</span> <span class="n">en</span><span class="p">])</span>
                                <span class="n">frq</span> <span class="o">=</span> <span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">st</span><span class="p">),</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">en</span><span class="p">)]</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tier1freq</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">frq</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frq</span><span class="p">)])</span>
                                <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">chanrange</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">freqs</span> <span class="o">=</span> <span class="n">identifications</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="n">chans</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
                            <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                        <span class="n">temppeak</span> <span class="o">=</span> <span class="n">Peaks</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> <span class="n">fsingles</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">singles</span><span class="o">=</span><span class="n">chans</span><span class="p">,</span> <span class="n">segments</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">segments</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
                            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getchannels</span><span class="p">(</span><span class="n">temppeak</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">ident</span><span class="p">),</span> <span class="n">asfreq</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">chanrange</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">chanrange</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">ch</span> <span class="o">=</span> <span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">chanrange</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">chanrange</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
                            <span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">setstart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="nb">min</span><span class="p">(</span><span class="n">ch</span><span class="p">)))])</span>
                            <span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">setend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ch</span><span class="p">)))])</span>
                            <span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">identifications</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">delcent</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">freqs</span> <span class="o">=</span> <span class="n">identifications</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">chanrange</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">chanrange</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">delcent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="n">delsingle</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">delsingle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">chanrange</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">delsingle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">delsingle</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">delcent</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">delsingle</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">slen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">)</span>
        <span class="c1"># now process anything that is not Tier 1</span>
        <span class="c1"># start with the complex sets</span>
        <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fcenters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="c1"># central frequency and channel spacing</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                          <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]],</span>
                          <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]]}</span>
            <span class="n">centerpeak</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">)]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="c1"># frequencies of offset lines</span>
            <span class="n">wings</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># rought width</span>
            <span class="n">twidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">twidth</span>
            <span class="c1"># if there is a central peak in the cluster</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">centerpeak</span><span class="p">:</span>
                <span class="c1"># calculate starting and ending channels to extract for the line fitting</span>
                <span class="c1"># cut will will be center +- 3*FWHM, keeping in mind the window edges</span>
                <span class="n">st</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">twidth</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="p">)))</span>
                <span class="n">en</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">twidth</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">st</span><span class="o">==</span><span class="n">en</span><span class="p">:</span>
                    <span class="n">fwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">]</span><span class="o">-</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                
                <span class="n">peak</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">)]</span>
                <span class="n">hpk</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="mf">2.0</span>
                <span class="c1"># get a better number for the FWHM</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fitgauss1D</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq</span><span class="p">,</span>
                                              <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                              <span class="n">par</span><span class="o">=</span><span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">fwidth</span><span class="p">)</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getchannels</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">cid</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">chans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">chans</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">peakw</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                <span class="n">st</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">twidth</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="p">)))</span>
                <span class="n">en</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> \
                  <span class="nb">int</span><span class="p">(</span><span class="n">twidth</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">st</span><span class="o">==</span><span class="n">en</span><span class="p">:</span>
                    <span class="n">fwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">]</span><span class="o">-</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

                <span class="c1"># get a better number for the FWHM</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fitgauss1D</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                              <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                              <span class="n">par</span><span class="o">=</span><span class="p">[</span><span class="n">peakw</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">twidth</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">fwidth</span><span class="p">)</span>
                <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getchannels</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">cid</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">chans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">peakw</span><span class="p">,</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">chans</span><span class="p">]</span>
            <span class="n">clow</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">chigh</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">possibilities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">wpossibles</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># search around the central frequency</span>
            <span class="n">width</span> <span class="o">*=</span> <span class="mf">1.05</span>
            <span class="n">possibilities</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatepossibles</span><span class="p">([</span><span class="n">freq</span> <span class="o">-</span> <span class="n">width</span><span class="p">,</span> <span class="n">freq</span> <span class="o">+</span> <span class="n">width</span><span class="p">])</span>
            <span class="c1"># if there is a central peak then search around all possible offsets</span>
            <span class="c1"># in case this is not a true cluster but just random coincidence</span>
            <span class="k">if</span> <span class="n">centerpeak</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">off</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">offsets</span><span class="p">:</span>
                    <span class="n">possibilities</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatepossibles</span><span class="p">([</span><span class="n">freq</span> <span class="o">-</span> <span class="n">width</span> <span class="o">-</span> <span class="n">off</span><span class="p">,</span>
                                                             <span class="n">freq</span> <span class="o">+</span> <span class="n">width</span> <span class="o">-</span> <span class="n">off</span><span class="p">])</span>
                    <span class="n">possibilities</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatepossibles</span><span class="p">([</span><span class="n">freq</span> <span class="o">-</span> <span class="n">width</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span>
                                                             <span class="n">freq</span> <span class="o">+</span> <span class="n">width</span> <span class="o">+</span> <span class="n">off</span><span class="p">])</span>
            <span class="c1"># take care of the wings</span>
            <span class="n">wpeak</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">wfwhm</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">wwidth</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">wpossibles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># calculate starting and ending channels to extract for the line fitting</span>
                <span class="c1"># cut will will be center +- 3*FWHM, keeping in mind the window edges</span>
                <span class="n">st</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">twidth</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="p">)))</span>
                <span class="n">en</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">twidth</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">en</span> <span class="o">-</span> <span class="n">st</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="p">(</span><span class="n">en</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">st</span> <span class="o">-=</span> <span class="n">df</span>
                    <span class="n">en</span> <span class="o">+=</span> <span class="n">df</span>
                    <span class="k">if</span> <span class="n">st</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">en</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
                        <span class="n">st</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">en</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">en</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span>
                        <span class="n">st</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">st</span> <span class="o">-</span> <span class="n">df</span><span class="p">)</span>
                        <span class="n">en</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">wpeak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span>
                <span class="c1"># get a better value for the FWHM</span>
                <span class="k">if</span> <span class="n">st</span><span class="o">==</span><span class="n">en</span><span class="p">:</span>
                    <span class="n">fwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">]</span><span class="o">-</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fitgauss1D</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq</span><span class="p">,</span>
                                              <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">par</span><span class="o">=</span><span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">fwidth</span><span class="p">)</span>

                <span class="n">wwidth</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
                <span class="n">wfwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
                <span class="c1"># search around the central frequency of the line</span>
                <span class="n">wpossibles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatepossibles</span><span class="p">([</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">wwidth</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                         <span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">wwidth</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                <span class="c1"># search as if this line is offset in case this is a single line and not a cluster</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ispvcorr</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">off</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">offsets</span><span class="p">:</span>
                        <span class="n">wpossibles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatepossibles</span><span class="p">([</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">wwidth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">off</span><span class="p">,</span>
                                                                 <span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">wwidth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">off</span><span class="p">])</span>
                        <span class="n">wpossibles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatepossibles</span><span class="p">([</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">wwidth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span>
                                                                 <span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">wwidth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">off</span><span class="p">])</span>

            <span class="c1"># if we have no results from all searches then we have U lines</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibilities</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">wpossibles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">wpossibles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
                <span class="n">qn</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">linestr</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">eu</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">el</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">centerpeak</span><span class="p">:</span>
                    <span class="n">species</span> <span class="o">=</span> <span class="s2">&quot;U_</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">freq</span><span class="p">)</span>
                    <span class="n">frq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
                    <span class="n">winner</span> <span class="o">=</span> <span class="n">LineData</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">frq</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                                      <span class="n">energies</span><span class="o">=</span><span class="p">[</span><span class="n">el</span><span class="p">,</span> <span class="n">eu</span><span class="p">],</span> <span class="n">linestrength</span><span class="o">=</span><span class="n">linestr</span><span class="p">,</span> <span class="n">transition</span><span class="o">=</span><span class="n">qn</span><span class="p">,</span>
                                      <span class="n">plain</span><span class="o">=</span><span class="n">species</span><span class="p">)</span>
                    <span class="n">pkrms</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                        <span class="n">pkrms</span> <span class="o">/=</span> <span class="n">noise</span>
                    <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checktier1chans</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="n">chans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettier1line</span><span class="p">([</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                                   <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]])</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">winner</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vel</span><span class="p">),</span>
                                       <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                       <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])),</span>
                                       <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                       <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                       <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkrms</span><span class="p">),</span>
                                       <span class="s2">&quot;blend&quot;</span> <span class="p">:</span> <span class="mi">0</span>
                                      <span class="p">})</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">winner</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">species</span> <span class="o">=</span> <span class="s2">&quot;U_</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">frq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">wpeak</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                    <span class="n">winner</span> <span class="o">=</span> <span class="n">LineData</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">frq</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                                      <span class="n">energies</span><span class="o">=</span><span class="p">[</span><span class="n">el</span><span class="p">,</span> <span class="n">eu</span><span class="p">],</span> <span class="n">linestrength</span><span class="o">=</span><span class="n">linestr</span><span class="p">,</span> <span class="n">transition</span><span class="o">=</span><span class="n">qn</span><span class="p">,</span>
                                      <span class="n">plain</span><span class="o">=</span><span class="n">species</span><span class="p">)</span>
                    <span class="n">pkrms</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                        <span class="n">pkrms</span> <span class="o">/=</span> <span class="n">noise</span>
                    <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checktier1chans</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="n">chans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettier1line</span><span class="p">([</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                                   <span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">winner</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vel</span><span class="p">),</span>
                                       <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                       <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])),</span>
                                       <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                       <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                       <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkrms</span><span class="p">),</span>
                                       <span class="s2">&quot;blend&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">wings</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">winner</span>
            <span class="c1"># otherwise narrow it down for each one</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wblends</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">w1blends</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">w2blends</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibilities</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># eliminate doubles before proceeding</span>
                    <span class="n">drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">poss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">possibilities</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibilities</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">poss</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="n">possibilities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span> <span class="ow">and</span> \
                               <span class="n">poss</span><span class="o">.</span><span class="n">transition</span> <span class="o">==</span> <span class="n">possibilities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transition</span> <span class="ow">and</span> \
                               <span class="n">poss</span><span class="o">.</span><span class="n">formula</span> <span class="o">==</span> <span class="n">possibilities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">formula</span><span class="p">:</span>
                                <span class="n">drop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">drop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">drop</span><span class="p">)</span>
                    <span class="n">drop</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="n">drop</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drop</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">possibilities</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">narrowpossibles</span><span class="p">(</span><span class="n">possibilities</span><span class="p">)</span>
                    <span class="n">winner</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                        <span class="n">wblends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">winner</span> <span class="o">=</span> <span class="n">LineData</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wpossibles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">poss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wpossibles</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wpossibles</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                            <span class="k">if</span> <span class="n">poss</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="n">wpossibles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span> <span class="ow">and</span> \
                               <span class="n">poss</span><span class="o">.</span><span class="n">transition</span> <span class="o">==</span> <span class="n">wpossibles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transition</span> <span class="ow">and</span> \
                               <span class="n">poss</span><span class="o">.</span><span class="n">formula</span> <span class="o">==</span> <span class="n">wpossibles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">formula</span><span class="p">:</span>
                                <span class="n">drop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">drop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">drop</span><span class="p">)</span>
                    <span class="n">drop</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="n">drop</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drop</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">wpossibles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">d</span><span class="p">]</span>

                    <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">narrowpossibles</span><span class="p">(</span><span class="n">wpossibles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">w1winner</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                        <span class="n">w1blends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">w1winner</span> <span class="o">=</span> <span class="n">LineData</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wpossibles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">poss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wpossibles</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wpossibles</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                            <span class="k">if</span> <span class="n">poss</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="n">wpossibles</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span> <span class="ow">and</span> \
                               <span class="n">poss</span><span class="o">.</span><span class="n">transition</span> <span class="o">==</span> <span class="n">wpossibles</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transition</span> <span class="ow">and</span> \
                               <span class="n">poss</span><span class="o">.</span><span class="n">formula</span> <span class="o">==</span> <span class="n">wpossibles</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">formula</span><span class="p">:</span>
                                <span class="n">drop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">drop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">drop</span><span class="p">)</span>
                    <span class="n">drop</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="n">drop</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drop</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">wpossibles</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">d</span><span class="p">]</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">narrowpossibles</span><span class="p">(</span><span class="n">wpossibles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">w2winner</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                        <span class="n">w2blends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">w2winner</span> <span class="o">=</span> <span class="n">LineData</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">winner</span> <span class="o">=</span> <span class="n">w2winner</span>  <span class="c1"># work around</span>
                <span class="k">if</span> <span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w1winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">winner</span> <span class="o">=</span> <span class="n">w2winner</span>
                <span class="k">if</span> <span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w2winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">winner</span> <span class="o">=</span> <span class="n">w1winner</span>
                <span class="c1"># compare species and QN, if they all match then delcare them all as one line</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w1winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w2winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w1winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w2winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                   <span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> \
                   <span class="p">(</span><span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w1winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w1winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">))</span> <span class="ow">or</span>\
                   <span class="p">(</span><span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w2winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w2winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">))</span> <span class="ow">or</span>\
                   <span class="p">(</span><span class="n">w1winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w2winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">w1winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">w2winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">w1winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                    <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">freq</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)))</span>
                    <span class="n">mpk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                              <span class="nb">abs</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                        <span class="n">pkrms</span> <span class="o">=</span> <span class="n">mpk</span> <span class="o">/</span> <span class="n">noise</span>
                    <span class="n">tfwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="nb">abs</span><span class="p">((</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wwidth</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
                                                      <span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wwidth</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checktier1chans</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="p">[</span><span class="n">clow</span><span class="p">,</span> <span class="n">chigh</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">chans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettier1line</span><span class="p">([</span><span class="n">clow</span><span class="p">,</span> <span class="n">chigh</span><span class="p">])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">clow</span><span class="p">)],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chigh</span><span class="p">)]])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">clow</span><span class="p">)],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chigh</span><span class="p">)]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">winner</span><span class="p">)</span>
                        <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                                     <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">mpk</span><span class="p">),</span>
                                     <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span><span class="p">),</span>
                                     <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="n">tfwhm</span><span class="p">),</span>
                                     <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                     <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                     <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkrms</span><span class="p">)</span>
                                    <span class="p">})</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                    <span class="n">blends</span> <span class="o">+=</span> <span class="n">wblends</span>
                    <span class="n">wings</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="n">foundcomplex</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">wings</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">winner</span><span class="p">)))</span>
                <span class="c1"># otherwise proceed as they are different lines</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">centerpeak</span><span class="p">:</span>
                        <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">freq</span> <span class="o">-</span> <span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                        <span class="n">pkrms</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                            <span class="n">pkrms</span> <span class="o">/=</span> <span class="n">noise</span>
                        <span class="n">fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checktier1chans</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                             <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="k">if</span> <span class="n">chans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettier1line</span><span class="p">([</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                                       <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                            <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]])</span>
                            <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">winner</span><span class="p">)</span>
                            <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                                         <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">peak</span><span class="p">),</span>
                                         <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span><span class="p">),</span>
                                         <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="n">tfwhm</span><span class="p">),</span>
                                         <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                         <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                         <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkrms</span><span class="p">)</span>
                                        <span class="p">})</span>

                            <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                        <span class="n">blends</span> <span class="o">+=</span> <span class="n">wblends</span>

                    <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">w1winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                    <span class="n">pkrms</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                        <span class="n">pkrms</span> <span class="o">/=</span> <span class="n">noise</span>
                    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checktier1chans</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="n">chans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettier1line</span><span class="p">([</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                                   <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">w1winner</span><span class="p">)</span>
                        <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                                     <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">wpeak</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                     <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span><span class="p">),</span>
                                     <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">),</span>
                                     <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                     <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                     <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkrms</span><span class="p">)</span>
                                    <span class="p">})</span>

                        <span class="n">identifications</span><span class="p">[</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span>
                    <span class="n">blends</span> <span class="o">+=</span> <span class="n">w1blends</span>
                    <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">w2winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                    <span class="n">pkrms</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                        <span class="n">pkrms</span> <span class="o">/=</span> <span class="n">noise</span>
                    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checktier1chans</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="n">chans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettier1line</span><span class="p">([</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                                   <span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">w2winner</span><span class="p">)</span>
                        <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                                     <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">wpeak</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                     <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span><span class="p">),</span>
                                     <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">),</span>
                                     <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                     <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                     <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkrms</span><span class="p">)</span>
                                    <span class="p">})</span>

                        <span class="n">identifications</span><span class="p">[</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span>
                    <span class="n">blends</span> <span class="o">+=</span> <span class="n">w2blends</span>
        <span class="c1"># now do the single points</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">slen</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">foundcomplex</span><span class="p">:</span>
                <span class="n">wing</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">win</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">wing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">wing</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">slen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">maxwidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">veltofreq</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">breakpoint</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span>
                                        <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span>
                                        <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">slen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">maxwidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
                                               <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                        <span class="n">breakpoint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
                                             <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])))</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span>
                                    <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">maxwidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="n">breakpoint</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])),</span> <span class="mi">5</span><span class="p">)</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span>
                                    <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">maxwidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="n">breakpoint</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])),</span> <span class="mi">5</span><span class="p">)</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span>
                                    <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">slen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">st</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">10</span><span class="p">))</span>
                        <span class="n">en</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)))</span>
                        <span class="n">en</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">st</span><span class="o">==</span><span class="n">en</span><span class="p">:</span>
                        <span class="n">fwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">]</span><span class="o">-</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fitgauss1D</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                  <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">par</span><span class="o">=</span><span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">fwidth</span><span class="p">)</span>
                    <span class="n">fcenter</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">endpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getchannels</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">endpoints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">fcenter</span><span class="p">,</span> <span class="n">fcenter</span> <span class="o">-</span> <span class="n">win</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">peak</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                    <span class="n">hpk</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="mf">2.0</span>
                    <span class="n">pkrms</span> <span class="o">=</span> <span class="n">hpk</span> <span class="o">*</span> <span class="mf">2.0</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                        <span class="n">pkrms</span> <span class="o">/=</span> <span class="n">noise</span>

                    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checktier1chans</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="p">[</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="n">chans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettier1line</span><span class="p">([</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">])]])</span>
                        <span class="n">identifications</span><span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">])]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>
                        <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                                     <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">peak</span><span class="p">),</span>
                                     <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span><span class="p">),</span>
                                     <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">),</span>
                                     <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                     <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                                     <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">hpk</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">pkrms</span><span class="p">)</span>
                                    <span class="p">})</span>

                        <span class="n">identifications</span><span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span>

                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># determine rough limits on the width of the lines both in frequency space and channel space</span>
            <span class="c1"># calculate the width of each channel</span>
            <span class="c1"># also be mindful of the edges of the window</span>
            <span class="k">if</span> <span class="n">slen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">maxwidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">veltofreq</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">breakpoint</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">st</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">10</span><span class="p">))</span>
                <span class="n">en</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">slen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">maxwidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
                                       <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="n">breakpoint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
                                     <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])))</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">maxwidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">breakpoint</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxwidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">breakpoint</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">endpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getchannels</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">peaks</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">endpoints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># get the spectral peak</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">hpk</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="c1"># calculate a rough FWHM</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">breakpoint</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="nb">max</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">&lt;</span> <span class="n">hpk</span> <span class="ow">or</span> \
                   <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="nb">min</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">slen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">&lt;</span> <span class="n">hpk</span><span class="p">:</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta</span><span class="p">,</span> <span class="n">maxwidth</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="c1"># calculate starting and ending channels to extract for the line fitting</span>
            <span class="c1"># cut will will be center +- 3*FWHM, keeping in mind the window edges</span>
            <span class="k">if</span> <span class="n">slen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)))</span>
                <span class="n">en</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">st</span><span class="o">==</span><span class="n">en</span><span class="p">:</span>
                <span class="n">fwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">]</span><span class="o">-</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># fit the data with a gaussian</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fitgauss1D</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreqs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">peaks</span><span class="o">.</span><span class="n">getspecs</span><span class="p">()[</span><span class="n">st</span><span class="p">:</span><span class="n">en</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">par</span><span class="o">=</span><span class="p">[</span><span class="n">peak</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="n">fwidth</span><span class="p">)</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">fcenter</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">limitwidth</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="p">)</span>
            <span class="c1"># look for an identification around the line</span>
            <span class="n">possibilities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">possibilities</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatepossibles</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span>
            <span class="c1"># look for other identifications in case this line is red/blue shifted due to rotation/collapse</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ispvcorr</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">offsets</span><span class="p">:</span>
                    <span class="n">possibilities</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatepossibles</span><span class="p">([</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span>
                                                             <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">-</span> <span class="n">k</span><span class="p">])</span>

                    <span class="n">possibilities</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatepossibles</span><span class="p">([</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span>
                                                             <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">+</span> <span class="n">k</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibilities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># if none were found the set it as a U line</span>
                <span class="n">species</span> <span class="o">=</span> <span class="s2">&quot;U_</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
                <span class="n">freq</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">qn</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">linestr</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">eu</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">el</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">poffset</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">winner</span> <span class="o">=</span> <span class="n">LineData</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">freq</span><span class="p">),</span> <span class="n">uid</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                                  <span class="n">energies</span><span class="o">=</span><span class="p">[</span><span class="n">el</span><span class="p">,</span> <span class="n">eu</span><span class="p">],</span> <span class="n">linestrength</span><span class="o">=</span><span class="n">linestr</span><span class="p">,</span>
                                  <span class="n">mass</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">getmass</span><span class="p">(</span><span class="n">species</span><span class="p">),</span> <span class="n">transition</span><span class="o">=</span><span class="n">qn</span><span class="p">,</span> <span class="n">plain</span><span class="o">=</span><span class="n">species</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># narrow down the possibilities</span>
                <span class="c1"># eliminate doubles before proceeding</span>
                <span class="n">drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">poss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">possibilities</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibilities</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">poss</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="n">possibilities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span> <span class="ow">and</span> \
                            <span class="n">poss</span><span class="o">.</span><span class="n">transition</span> <span class="o">==</span> <span class="n">possibilities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transition</span> <span class="ow">and</span> \
                           <span class="n">poss</span><span class="o">.</span><span class="n">formula</span> <span class="o">==</span> <span class="n">possibilities</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">formula</span><span class="p">:</span>
                            <span class="n">drop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">drop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">drop</span><span class="p">)</span>
                <span class="n">drop</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">drop</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drop</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">possibilities</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>

                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">narrowpossibles</span><span class="p">(</span><span class="n">possibilities</span><span class="p">)</span>
                <span class="n">winner</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                    <span class="n">blends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

                <span class="c1"># calculate velocity offset</span>
                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">fcenter</span><span class="p">,</span> <span class="n">fcenter</span> <span class="o">-</span> <span class="n">winner</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
            <span class="n">pkrms</span> <span class="o">=</span> <span class="n">hpk</span> <span class="o">*</span> <span class="mf">2.0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isstats</span><span class="p">:</span>
                <span class="n">pkrms</span> <span class="o">/=</span> <span class="n">noise</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">delta</span><span class="p">)</span>
            <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checktier1chans</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="p">[</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">chans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">identifications</span><span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettier1line</span><span class="p">([</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">identifications</span><span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">])]])</span>
                <span class="n">identifications</span><span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">])]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">winner</span><span class="p">)</span>
                <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">({</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">),</span>
                             <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">peak</span><span class="p">),</span>
                             <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">poffset</span><span class="p">),</span>
                             <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">),</span>
                             <span class="s2">&quot;chans&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                             <span class="s2">&quot;freqs&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span>
                             <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">hpk</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">pkrms</span><span class="p">)</span>
                            <span class="p">})</span>

                <span class="n">identifications</span><span class="p">[</span><span class="n">peaks</span><span class="o">.</span><span class="n">fsingles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span>
        <span class="n">badblends</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">blend</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blends</span><span class="p">):</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">identifications</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">ident</span><span class="o">.</span><span class="n">blend</span> <span class="o">==</span> <span class="n">blend</span><span class="o">.</span><span class="n">blend</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">badblends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">badblends</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">badblends</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">blends</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blends</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">identifications</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">blend</span> <span class="o">==</span> <span class="n">line</span><span class="o">.</span><span class="n">blend</span><span class="p">:</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">))</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">))</span>
        <span class="n">peaks</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">identifications</span><span class="p">)</span>
        <span class="n">peaks</span><span class="o">.</span><span class="n">blends</span> <span class="o">+=</span> <span class="n">blends</span></div>

<div class="viewcode-block" id="LineID_AT.getchannels"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.getchannels">[docs]</a>    <span class="k">def</span> <span class="nf">getchannels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">sid</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cid</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">asfreq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to determine the channel ranges for thr given spectral line.</span>
<span class="sd">            First uses the segment to get the maximum extent of the line, then</span>
<span class="sd">            compares the channel range to all other peaks and makes adjustments</span>
<span class="sd">            so that the channel range does not incorporate mote than one peak.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            peaks : Peaks instance</span>
<span class="sd">                The peaks instance which lists all peaks in the spectrum</span>

<span class="sd">            noise : float</span>
<span class="sd">                The noise level of the spectrum</span>

<span class="sd">            sid : int</span>
<span class="sd">                Center channel of the spectrum to find the channel ranges for.</span>
<span class="sd">                Default: -1</span>

<span class="sd">            cid : int</span>
<span class="sd">                Center channel of the cluster to find the channel ranges for.</span>
<span class="sd">                Default: -1</span>

<span class="sd">            asfreq : bool</span>
<span class="sd">                Whether to return the end poitns in frequency units (True) or</span>
<span class="sd">                channel numbers (False).</span>
<span class="sd">                Defult : False (channel numbers)</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            List containing both the start and end channels for the given peak</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            Both sid and cid are mutually exclusive.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sid</span> <span class="o">==</span> <span class="n">cid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;An id index must be given, sid or cid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sid</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">cid</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only one of sid or cid can be given&quot;</span><span class="p">)</span>
        <span class="c1"># if we are given a single line to trace</span>
        <span class="k">if</span> <span class="n">sid</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># get the initial trace</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sid</span><span class="p">)))</span>
            <span class="c1"># now see if it encompases other peaks, if it does then move the endpoint(s)</span>
            <span class="c1"># so that they do not overlap</span>
            <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">spk</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spk</span> <span class="o">==</span> <span class="n">sid</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">spk</span> <span class="o">&lt;</span> <span class="n">sid</span><span class="p">:</span>
                    <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sid</span> <span class="o">+</span> <span class="n">spk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">spk</span> <span class="o">&gt;</span> <span class="n">sid</span><span class="p">:</span>
                    <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sid</span> <span class="o">+</span> <span class="n">spk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># do the same for the clusters</span>
            <span class="k">for</span> <span class="n">chan</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">centers</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">sid</span><span class="p">:</span>
                        <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sid</span> <span class="o">+</span> <span class="n">chan</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">chan</span> <span class="o">&gt;</span> <span class="n">sid</span><span class="p">:</span>
                        <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sid</span> <span class="o">+</span> <span class="n">chan</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">sid</span><span class="p">:</span>
                        <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sid</span> <span class="o">+</span> <span class="n">ch</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ch</span> <span class="o">&gt;</span> <span class="n">sid</span><span class="p">:</span>
                        <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sid</span> <span class="o">+</span> <span class="n">ch</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># if frequency units are requested</span>
            <span class="k">if</span> <span class="n">asfreq</span><span class="p">:</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
                <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">points</span>
        <span class="c1"># if we are given a cluster to trace</span>
        <span class="k">if</span> <span class="n">cid</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># get the initial trace</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cid</span><span class="p">)))</span>
            <span class="c1"># now see if it encompases other peaks, if it does then move the endpoint(s)</span>
            <span class="c1"># so that they do not overlap</span>
            <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">spk</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">singles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">spk</span> <span class="o">&lt;</span> <span class="n">cid</span><span class="p">:</span>
                    <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">cid</span> <span class="o">+</span> <span class="n">spk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">spk</span> <span class="o">&gt;</span> <span class="n">cid</span><span class="p">:</span>
                    <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">cid</span> <span class="o">+</span> <span class="n">spk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># do the same for the clusters</span>
            <span class="k">for</span> <span class="n">chan</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">centers</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">chan</span> <span class="o">==</span> <span class="n">cid</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">cid</span><span class="p">:</span>
                        <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">cid</span> <span class="o">+</span> <span class="n">chan</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">chan</span> <span class="o">&gt;</span> <span class="n">cid</span><span class="p">:</span>
                        <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">cid</span> <span class="o">+</span> <span class="n">chan</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">cid</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">cid</span><span class="p">:</span>
                        <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">cid</span> <span class="o">+</span> <span class="n">ch</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ch</span> <span class="o">&gt;</span> <span class="n">cid</span><span class="p">:</span>
                        <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">cid</span> <span class="o">+</span> <span class="n">ch</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># if frequency units are requested</span>
            <span class="k">if</span> <span class="n">asfreq</span><span class="p">:</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
                <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">points</span></div>

<div class="viewcode-block" id="LineID_AT.checkcount"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.checkcount">[docs]</a>    <span class="k">def</span> <span class="nf">checkcount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to determine if there are too many peaks for the pattern finder to be of use. If</span>
<span class="sd">            there are too many points then false patterns can be found. The threshold has been</span>
<span class="sd">            experimentally determined to be a second order poynolmial based on the number of</span>
<span class="sd">            of channels. See the design documentation for specifics and details.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            counts : dict</span>
<span class="sd">                Dictionary containing the peaks for each input spectrum.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Bool, True if there are too many peaks for the pattern finder to be of use, False</span>
<span class="sd">            otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="p">[</span><span class="mf">42.96712785</span><span class="p">,</span> <span class="o">-</span><span class="mf">777.04366254</span><span class="p">,</span> <span class="mf">3892.90652112</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">peaks</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">*</span><span class="mf">48.07692308</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Too many peaks in CubeStats for pattern finding to be useful, turning it off.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">count</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">count</span> <span class="o">+</span> <span class="n">fit</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Too many peaks in CubeStats for pattern finding to be useful, turning it off.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">peaks</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">]:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">*</span><span class="mf">48.07692308</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Too many peaks in CubeSpectrum for pattern finding to be useful, turning it off.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">count</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">count</span> <span class="o">+</span> <span class="n">fit</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Too many peaks in CubeSpectrum for pattern finding to be useful, turning it off.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LineID_AT.run"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The run method, locates lines, attempts to identify them, and</span>
<span class="sd">            creates the BDP</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Dtime</span><span class="p">(</span><span class="s2">&quot;LineID&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxcar</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Boxcar smoothing turned off.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">taskargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taskargs</span><span class="p">()</span>
        <span class="n">statbdp</span> <span class="o">=</span> <span class="kc">None</span>                   <span class="c1"># for the CubeStats BDP</span>
        <span class="n">pvbdp</span> <span class="o">=</span> <span class="kc">None</span>                     <span class="c1"># for the PVCorr BDP</span>
        <span class="n">specbdp</span> <span class="o">=</span> <span class="kc">None</span>                   <span class="c1"># for the CubeSpectrum BDP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specs</span> <span class="o">=</span> <span class="p">[]</span>                  <span class="c1"># to hold the input CubeSpectrum based spectra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statspec</span> <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># to hold the input CubeStats based spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvseg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statseg</span> <span class="o">=</span> <span class="p">[]</span>                <span class="c1"># to hold the detected segments from statspec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specseg</span> <span class="o">=</span> <span class="p">[]</span>                <span class="c1"># to hold the detected segments from specs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="p">[]</span>                   <span class="c1"># to hold the channel numbers for each channel for specs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statcutoff</span> <span class="o">=</span> <span class="p">[]</span>             <span class="c1"># cutoff for statspec line finding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speccutoff</span> <span class="o">=</span> <span class="p">[]</span>             <span class="c1"># cutoff for specs line finding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infile</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blendcount</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tier1chans</span> <span class="o">=</span> <span class="p">[]</span>             <span class="c1"># to hold lists of Tier1 channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tier1freq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tier1list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcechans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcefreqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;reject&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;pattern&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rej</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rej</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Rejecting all transitions of </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rej</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rejecting </span><span class="si">%s</span><span class="s2"> at </span><span class="si">%f</span><span class="s2"> GHz.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rej</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rej</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;minchan must be a positive integer.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;iterate&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;iterate=True is not allowed for minchan=1, setting iterate to False&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;iterate&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">havesomething</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ident</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;force&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="n">LineData</span><span class="p">):</span>
                <span class="n">ident</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;force&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">ident</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">,</span><span class="n">isent</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;F</span><span class="si">%02i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Forcing: </span><span class="si">%s</span><span class="s2">  @  </span><span class="si">%f</span><span class="s2"> GHz  chans[</span><span class="si">%i</span><span class="s2">, </span><span class="si">%i</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ident</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                                                         <span class="n">ident</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                                                         <span class="n">ident</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span>
                                                                         <span class="n">ident</span><span class="o">.</span><span class="n">getend</span><span class="p">()))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Incorrect number of items in force entry. See documentation for correct entries, all are required.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LineData</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">ident</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uid</span><span class="o">=</span><span class="n">ident</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;F</span><span class="si">%02i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="n">ident</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                           <span class="n">name</span><span class="o">=</span><span class="n">ident</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">transition</span><span class="o">=</span><span class="n">ident</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                           <span class="n">velocity</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
                                           <span class="n">chans</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">7</span><span class="p">])],</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Forcing: </span><span class="si">%s</span><span class="s2">  @  </span><span class="si">%f</span><span class="s2"> GHz  chans[</span><span class="si">%i</span><span class="s2">, </span><span class="si">%i</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ident</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                         <span class="nb">int</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">7</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Improper format for force list. The list must contain tuples, lists or LineData objects, not </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ident</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcechans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">))</span>
            <span class="n">havesomething</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># get the input bdp</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdp_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">specbdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdp_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">infile</span> <span class="o">=</span> <span class="n">specbdp</span><span class="o">.</span><span class="n">xmlFile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdp_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">statbdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdp_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">infile</span> <span class="o">=</span> <span class="n">statbdp</span><span class="o">.</span><span class="n">xmlFile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdp_in</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pvbdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdp_in</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">infile</span> <span class="o">=</span> <span class="n">pvbdp</span><span class="o">.</span><span class="n">xmlFile</span>
        <span class="c1"># still need to do this check since all are optional inputs</span>
        <span class="k">if</span> <span class="n">specbdp</span> <span class="o">==</span> <span class="n">pvbdp</span> <span class="o">==</span> <span class="n">statbdp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No input BDP&#39;s found.&quot;</span><span class="p">)</span>
        <span class="n">imbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;ll&#39;</span><span class="p">)</span>

        <span class="n">llbdp</span> <span class="o">=</span> <span class="n">LineList_BDP</span><span class="p">(</span><span class="n">imbase</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;vlsr&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifylines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;identifylines&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">999999.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifylines</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">Project</span><span class="o">.</span><span class="n">summaryData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vlsr&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getValue</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set vlsr = </span><span class="si">%.2f</span><span class="s2"> for line identification.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No vlsr found in summary data and none given as an argument, switching identifylines to False.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">identifylines</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># grab any optional references overplotted on the &quot;ll&quot; plots</span>
        <span class="n">line_ref</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_references</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;references&quot;</span><span class="p">))</span>


        <span class="c1"># Default to SVG output (full-size PNG also produced on-the-fly during</span>
        <span class="c1"># thumbnail creation).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_type</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PlotControl</span><span class="o">.</span><span class="n">SVG</span>

        <span class="c1"># instantiate a plotter for all plots made herein</span>
        <span class="n">myplot</span> <span class="o">=</span> <span class="n">APlot</span><span class="p">(</span><span class="n">ptype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_type</span><span class="p">,</span> <span class="n">pmode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_mode</span><span class="p">,</span> <span class="n">abspath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;identifylines&quot;</span><span class="p">):</span>
            <span class="n">vlsr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vlsr</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1">############################################################################</span>
        <span class="c1">#  Smoothing and continuum (baseline) subtraction of input spectra         #</span>
        <span class="c1">############################################################################</span>

        <span class="c1"># get and smooth all input spectra</span>
        <span class="n">basicsegment</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;segment&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;minchan&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;maxgap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;maxgap&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;numsigma&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;iterate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;iterate&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;nomean&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="n">segargsforcont</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span>    <span class="s2">&quot;Line_ID.</span><span class="si">%i</span><span class="s2">.asap&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
                     <span class="s2">&quot;pmin&quot;</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">),</span>
                     <span class="s2">&quot;minchan&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">),</span>
                     <span class="s2">&quot;maxgap&quot;</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;maxgap&quot;</span><span class="p">)}</span>

        <span class="k">if</span> <span class="n">specbdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specs</span> <span class="o">=</span> <span class="n">specutil</span><span class="o">.</span><span class="n">getspectrum</span><span class="p">(</span><span class="n">specbdp</span><span class="p">,</span> <span class="n">vlsr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;smooth&quot;</span><span class="p">),</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;recalcnoise&quot;</span><span class="p">),</span> <span class="n">basicsegment</span><span class="p">)</span>
            <span class="c1"># remove the continuum, if requested</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;csub&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;csub&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting Continuum Subtraction for Input Spectra&quot;</span><span class="p">)</span>
                <span class="n">specutil</span><span class="o">.</span><span class="n">contsub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;segment&quot;</span><span class="p">),</span> <span class="n">segargsforcont</span><span class="p">,</span><span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;PolyFit&quot;</span><span class="p">,</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;deg&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">:</span>
                    <span class="n">spec</span><span class="o">.</span><span class="n">set_contin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="n">specutil</span><span class="o">.</span><span class="n">mergefreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">,</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> <span class="n">spec</span><span class="o">.</span><span class="n">chans</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s2">&quot;getspectrum-cubespecs&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">statbdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statspec</span> <span class="o">=</span> <span class="n">specutil</span><span class="o">.</span><span class="n">getspectrum</span><span class="p">(</span><span class="n">statbdp</span><span class="p">,</span> <span class="n">vlsr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;smooth&quot;</span><span class="p">),</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;recalcnoise&quot;</span><span class="p">),</span> <span class="n">basicsegment</span><span class="p">)</span>
            <span class="c1"># remove the continuum</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;csub&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;csub&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting Continuum Subtraction for Input CubeStats Spectra&quot;</span><span class="p">)</span>
                <span class="n">specutil</span><span class="o">.</span><span class="n">contsub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;segment&quot;</span><span class="p">),</span> <span class="n">segargsforcont</span><span class="p">,</span><span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;PolyFit&quot;</span><span class="p">,</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;deg&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">):</span>
                    <span class="n">spec</span><span class="o">.</span><span class="n">set_contin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="n">specutil</span><span class="o">.</span><span class="n">mergefreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">,</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> <span class="n">spec</span><span class="o">.</span><span class="n">chans</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s2">&quot;getspectrum-cubestats&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pvbdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="o">=</span> <span class="n">specutil</span><span class="o">.</span><span class="n">getspectrum</span><span class="p">(</span><span class="n">pvbdp</span><span class="p">,</span> <span class="n">vlsr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;smooth&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pvsigma</span> <span class="o">=</span> <span class="n">pvbdp</span><span class="o">.</span><span class="n">sigma</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pvbdp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="n">specutil</span><span class="o">.</span><span class="n">mergefreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">chans</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">set_contin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="p">)))</span>

        <span class="c1"># Add spectra to the output BDPs.</span>
        <span class="k">if</span> <span class="n">specbdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">):</span>
                <span class="n">llbdp</span><span class="o">.</span><span class="n">addSpectrum</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;CubeSpectrum_</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indx</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">statbdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">):</span>
                <span class="n">llbdp</span><span class="o">.</span><span class="n">addSpectrum</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;CubeStats_</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indx</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">pvbdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">llbdp</span><span class="o">.</span><span class="n">addSpectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="p">,</span> <span class="s2">&quot;PVCorr&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integritycheck</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="n">force</span><span class="o">.</span><span class="n">getstart</span><span class="p">()],</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="n">force</span><span class="o">.</span><span class="n">getend</span><span class="p">()]]</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">rng</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">rng</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcefreqs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">rng</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">rng</span><span class="p">)])</span>

        <span class="c1"># seach for segments of spectral line emission</span>

        <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;segment&quot;</span><span class="p">)</span> 
        <span class="n">minchan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)</span>
        <span class="n">maxgap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;maxgap&quot;</span><span class="p">)</span> 
        <span class="n">numsigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">)</span>
        <span class="n">iterate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;iterate&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s2">&quot;segment finder&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">specbdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Detecting segments in CubeSpectrum based data&quot;</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">specutil</span><span class="o">.</span><span class="n">findsegments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">minchan</span><span class="p">,</span> <span class="n">maxgap</span><span class="p">,</span> <span class="n">numsigma</span><span class="p">,</span> <span class="n">iterate</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">specseg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkforcesegs</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_noise</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">speccutoff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">statbdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Detecting segments in CubeStats based data&quot;</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">specutil</span><span class="o">.</span><span class="n">findsegments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">minchan</span><span class="p">,</span> <span class="n">maxgap</span><span class="p">,</span> <span class="n">numsigma</span><span class="p">,</span> <span class="n">iterate</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statseg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkforcesegs</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_noise</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>


        <span class="k">if</span> <span class="n">pvbdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Detecting segments in PVCorr based data&quot;</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">specutil</span><span class="o">.</span><span class="n">findsegments</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="p">],</span> <span class="n">method</span><span class="p">,</span> <span class="n">minchan</span><span class="p">,</span> <span class="n">maxgap</span><span class="p">,</span> <span class="n">numsigma</span><span class="p">,</span> <span class="n">iterate</span><span class="p">,</span><span class="n">noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvsigma</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">set_noise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvsigma</span><span class="p">)</span>  <span class="c1"># @TODO: why not values[0][2]?</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pvseg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkforcesegs</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pvcutoff</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># label and captions used immediately below and later in the code.</span>
        <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Peak/Noise&quot;</span><span class="p">,</span> <span class="s2">&quot;Minimum/Noise&quot;</span><span class="p">]</span>
        <span class="n">caption</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Potential lines overlaid on peak intensity plot from CubeStats_BDP.&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;Potential lines overlaid on minimum intensity plot from CubeStats_BDP.&quot;</span><span class="p">]</span>

        <span class="c1"># if we have no vlsr or just want the segments</span>
        <span class="c1"># create the output</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifylines</span><span class="p">:</span>
            <span class="n">segments</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mergesegments</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">statseg</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">specseg</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pvseg</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">))</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">specutil</span><span class="o">.</span><span class="n">linedatafromsegments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">,</span><span class="n">segments</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">)</span>
            <span class="n">duplicate_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">duplicate_lines</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="s2">&quot; Skipping-2 duplicate UID: &quot;</span> <span class="o">+</span> <span class="n">l</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">duplicate_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">))</span>
                <span class="n">llbdp</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">regression</span><span class="p">(</span><span class="s2">&quot;LINEID: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%.5f</span><span class="s2">  </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;NotIdentified&quot;</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="o">.</span><span class="n">chans</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="c1"># @todo  vlsr could now have been taken from Summary, so getkey() is an old value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;vlsr&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">999998.0</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;Rest&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;Sky&quot;</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Frequency (GHz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">):</span>
                <span class="n">freqs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statseg</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                                  <span class="nb">max</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]])])</span>
                <span class="n">mult</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">mult</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
<span class="c1">#                print(&quot;MWP plot cutoff[%d] = %f, contin=%f&quot; % (i, (spec.contin() + mult*(spec.noise() * self.getkey(&quot;numsigma&quot;)))[0], spec.contin()[0] ) )</span>
                <span class="n">myplot</span><span class="o">.</span><span class="n">segplotter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">(</span><span class="n">csub</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                  <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Potential Line Locations&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
                                  <span class="n">ylab</span><span class="o">=</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">figname</span><span class="o">=</span><span class="n">imbase</span> <span class="o">+</span> <span class="s2">&quot;_statspec</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">segments</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
                                  <span class="n">cutoff</span><span class="o">=</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">contin</span><span class="p">()</span> <span class="o">+</span> <span class="n">mult</span> <span class="o">*</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">noise</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">))),</span>
                                  <span class="n">continuum</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">contin</span><span class="p">(),</span> <span class="n">thumbnail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">imname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getFigure</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">thumbnailname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getThumbnail</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="p">{</span><span class="n">bt</span><span class="o">.</span><span class="n">SVG</span><span class="p">:</span> <span class="n">imname</span><span class="p">},</span> <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnailname</span><span class="p">,</span>
                              <span class="n">thumbnailtype</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">PNG</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">caption</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">llbdp</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;statspec</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">llbdp</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">llbdp</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">imname</span><span class="p">,</span>
                                              <span class="n">thumbnailname</span><span class="p">,</span> <span class="n">caption</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">):</span>
                <span class="n">freqs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specseg</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                                  <span class="nb">max</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]])])</span>
                <span class="n">myplot</span><span class="o">.</span><span class="n">segplotter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">(</span><span class="n">csub</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                  <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Potential Line Locations&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
                                  <span class="n">ylab</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">,</span> <span class="n">figname</span><span class="o">=</span><span class="n">imbase</span> <span class="o">+</span> <span class="s2">&quot;_spec</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">segments</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
                                  <span class="n">cutoff</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">contin</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">noise</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">)),</span>
                                  <span class="n">continuum</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">contin</span><span class="p">(),</span> <span class="n">thumbnail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">imname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getFigure</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">thumbnailname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getThumbnail</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span>
                                                    <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">_caption</span> <span class="o">=</span> <span class="s2">&quot;Potential lines overlaid on input spectrum #</span><span class="si">%i</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="p">{</span><span class="n">bt</span><span class="o">.</span><span class="n">SVG</span><span class="p">:</span> <span class="n">imname</span><span class="p">},</span> <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnailname</span><span class="p">,</span>
                              <span class="n">thumbnailtype</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">PNG</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">_caption</span><span class="p">)</span>
                <span class="n">llbdp</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;spec</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">llbdp</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">llbdp</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">imname</span><span class="p">,</span>
                                              <span class="n">thumbnailname</span><span class="p">,</span> <span class="n">_caption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">freqs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvseg</span><span class="p">:</span>
                    <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                                  <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]])])</span>

                <span class="n">myplot</span><span class="o">.</span><span class="n">segplotter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">spec</span><span class="p">(</span><span class="n">csub</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                  <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Potential Line Locations&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
                                  <span class="n">ylab</span><span class="o">=</span><span class="s2">&quot;Corr. Coef.&quot;</span><span class="p">,</span> <span class="n">figname</span><span class="o">=</span><span class="n">imbase</span> <span class="o">+</span> <span class="s2">&quot;_pvspec&quot;</span><span class="p">,</span>
                                  <span class="n">segments</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">noise</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">),</span>
                                  <span class="n">thumbnail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">imname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getFigure</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">thumbnailname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getThumbnail</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span>
                                                    <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">_caption</span> <span class="o">=</span> <span class="s2">&quot;Potential lines overlaid on Correlation plot from PVCorr_BDP.&quot;</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="p">{</span><span class="n">bt</span><span class="o">.</span><span class="n">SVG</span><span class="p">:</span> <span class="n">imname</span><span class="p">},</span> <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnailname</span><span class="p">,</span>
                              <span class="n">thumbnailtype</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">PNG</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">_caption</span><span class="p">)</span>
                <span class="n">llbdp</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;pvspec&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">llbdp</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">llbdp</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span>
                                              <span class="n">imname</span><span class="p">,</span> <span class="n">thumbnailname</span><span class="p">,</span> <span class="n">_caption</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="p">[</span><span class="s2">&quot;linelist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SummaryEntry</span><span class="p">(</span><span class="n">llbdp</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">serialize</span><span class="p">(),</span> <span class="s2">&quot;LineID_AT&quot;</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">taskargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="p">[</span><span class="s2">&quot;spectra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">SummaryEntry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="p">,</span> <span class="s2">&quot;LineID_AT&quot;</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">taskargs</span><span class="p">)]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">addoutput</span><span class="p">(</span><span class="n">llbdp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">tpeaks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># do the peak finding</span>
        <span class="n">spnoise</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># loop over all of the requested methods</span>
        <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">margs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Searching for spectral peaks with method: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">))</span>
            <span class="n">tpeaks</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;stats&quot;</span> <span class="p">:</span> <span class="p">[],</span>
                              <span class="s2">&quot;specs&quot;</span> <span class="p">:</span> <span class="p">[],</span>
                              <span class="s2">&quot;pvc&quot;</span>   <span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="c1"># look for peaks in the statspec data</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching for spectral peaks statspec </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;spec&quot;</span>      <span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">(),</span>
                        <span class="s2">&quot;y&quot;</span>         <span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span>
                        <span class="s2">&quot;min_width&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)}</span>
                <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">margs</span><span class="p">)</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;thresh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">noise</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">))</span>
                <span class="n">pks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpeaks</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">statseg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">iterate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;iterate&quot;</span><span class="p">))</span>
                <span class="n">tpeaks</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="s2">&quot;stats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">removepeaks</span><span class="p">(</span><span class="n">pks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">statseg</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="c1"># look for peaks in the cubespec data</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching for spectral peaks specs </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;spec&quot;</span>      <span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">(),</span>
                        <span class="s2">&quot;y&quot;</span>         <span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span>
                        <span class="s2">&quot;min_width&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)}</span>
                <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">margs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">margs</span><span class="p">[</span><span class="s2">&quot;thresh&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">args</span><span class="p">[</span><span class="s2">&quot;thresh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">noise</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">))</span>
                <span class="n">spnoise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;thresh&quot;</span><span class="p">])</span>
                <span class="n">pks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpeaks</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">specseg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">iterate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;iterate&quot;</span><span class="p">))</span>
                <span class="n">tpeaks</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="s2">&quot;specs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">removepeaks</span><span class="p">(</span><span class="n">pks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specseg</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="c1"># look for peaks in the pvcorr data</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching for spectral peaks pvspec&quot;</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;spec&quot;</span>      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">spec</span><span class="p">(),</span>
                        <span class="s2">&quot;y&quot;</span>         <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span>
                        <span class="s2">&quot;min_width&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)}</span>
                <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">margs</span><span class="p">)</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;thresh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">noise</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">))</span>
                <span class="n">pks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpeaks</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">spec</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvseg</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">tpeaks</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">removepeaks</span><span class="p">(</span><span class="n">pks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvseg</span><span class="p">)</span>

        <span class="c1"># now merge it all together into a single dictionary</span>
        <span class="n">allpeaks</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;stats&quot;</span> <span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;specs&quot;</span> <span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;pvc&quot;</span>   <span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="c1"># must be detected in at least 2 methods or ALL requested methods</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;merging all peaks for mode=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>
        <span class="c1"># do the stats first</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">)):</span>
            <span class="n">fullstats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">statlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tpeaks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">statlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">target</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># add everything that is unique</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;ALL&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">statlist</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;TWO&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">statlist</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">statlist</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">statlist</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">statlist</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">point</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">&lt;</span> <span class="n">stat</span> <span class="o">&lt;</span> <span class="n">point</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
                                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">statlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
                                <span class="k">break</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
                        <span class="n">fullstats</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fullstats</span><span class="p">)</span>
            <span class="n">allpeaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="n">havesomething</span> <span class="o">=</span> <span class="n">havesomething</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="c1"># then the spectra</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="s2">&quot;TWO&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">)):</span>
                <span class="n">fullspec</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">speclist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tpeaks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">speclist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">row</span><span class="p">])</span>
                <span class="k">if</span> <span class="s2">&quot;ALL&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">speclist</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">speclist</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">speclist</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">speclist</span><span class="p">)):</span>
                            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">speclist</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">point</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">&lt;</span> <span class="n">sp</span> <span class="o">&lt;</span> <span class="n">point</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
                                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">speclist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
                                    <span class="k">break</span>
                        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
                            <span class="n">fullspec</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fullspec</span><span class="p">)</span>
                <span class="n">allpeaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                <span class="n">havesomething</span> <span class="o">=</span> <span class="n">havesomething</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fullpvc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">pvclist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tpeaks</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">pvclist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">])</span>
            <span class="n">target</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># add everything that is unique</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;ALL&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvclist</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;TWO&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pvclist</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">pvclist</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvclist</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">pvclist</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">point</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">&lt;</span> <span class="n">pv</span> <span class="o">&lt;</span> <span class="n">point</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
                                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">pvclist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
                                <span class="k">break</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
                        <span class="n">fullpvc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">allpeaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fullpvc</span><span class="p">)</span>
            <span class="n">havesomething</span> <span class="o">=</span> <span class="n">havesomething</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">allpeaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># if nothing was detected</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">havesomething</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No lines detected by LineID.&quot;</span><span class="p">)</span>
            <span class="c1"># regression:  name, freq, ch0, ch1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;vlsr&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">999998.0</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;Rest&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;Sky&quot;</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Frequency (GHz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="c1"># cubestats output</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">):</span>
                <span class="n">mult</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">mult</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
                <span class="n">myplot</span><span class="o">.</span><span class="n">makespec</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">(</span><span class="n">csub</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">chan</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">chans</span><span class="p">(),</span>
                                <span class="n">cutoff</span><span class="o">=</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">contin</span><span class="p">()</span> <span class="o">+</span> <span class="n">mult</span> <span class="o">*</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">noise</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">))),</span>
                                <span class="n">figname</span><span class="o">=</span><span class="n">imbase</span> <span class="o">+</span><span class="s2">&quot;_statspec</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Line ID (vlsr=</span><span class="si">%.2f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">,</span>
                                <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="p">{},</span> <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">blends</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">continuum</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">contin</span><span class="p">(),</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                <span class="n">thumbnail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">line_ref</span><span class="p">)</span>
                <span class="n">imname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getFigure</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">thumbnailname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getThumbnail</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="p">{</span><span class="n">bt</span><span class="o">.</span><span class="n">SVG</span><span class="p">:</span> <span class="n">imname</span><span class="p">},</span> <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnailname</span><span class="p">,</span>
                              <span class="n">thumbnailtype</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">PNG</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">caption</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">llbdp</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;statspec</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">llbdp</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">llbdp</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">imname</span><span class="p">,</span>
                                              <span class="n">thumbnailname</span><span class="p">,</span> <span class="n">caption</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">])</span>
            <span class="c1"># cubespec output (1 for each input spectra, there could be many from a single BDP)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">):</span>
                <span class="n">myplot</span><span class="o">.</span><span class="n">makespec</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">(</span><span class="n">csub</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">chan</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">chans</span><span class="p">(),</span>
                                <span class="n">cutoff</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">contin</span><span class="p">()</span> <span class="o">+</span> <span class="n">spnoise</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                <span class="n">figname</span><span class="o">=</span><span class="n">imbase</span> <span class="o">+</span><span class="s2">&quot;_spec</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Line ID (vlsr=</span><span class="si">%.2f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
                                <span class="n">lines</span><span class="o">=</span><span class="p">{},</span> <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">blends</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">continuum</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">contin</span><span class="p">(),</span> <span class="n">thumbnail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">references</span><span class="o">=</span><span class="n">line_ref</span><span class="p">)</span>
                <span class="n">imname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getFigure</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">thumbnailname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getThumbnail</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span>
                                                    <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">_caption</span> <span class="o">=</span> <span class="s2">&quot;Identified lines overlaid on input spectrum #</span><span class="si">%i</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="p">{</span><span class="n">bt</span><span class="o">.</span><span class="n">SVG</span><span class="p">:</span> <span class="n">imname</span><span class="p">},</span>
                              <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnailname</span><span class="p">,</span> <span class="n">thumbnailtype</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">PNG</span><span class="p">,</span>
                              <span class="n">description</span><span class="o">=</span><span class="n">_caption</span><span class="p">)</span>
                <span class="n">llbdp</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;spec</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">llbdp</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">llbdp</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">imname</span><span class="p">,</span>
                                              <span class="n">thumbnailname</span><span class="p">,</span> <span class="n">_caption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">myplot</span><span class="o">.</span><span class="n">makespec</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">spec</span><span class="p">(</span><span class="n">csub</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">chan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">chans</span><span class="p">(),</span>
                                <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvcutoff</span><span class="p">,</span>
                                <span class="n">figname</span><span class="o">=</span><span class="n">imbase</span> <span class="o">+</span> <span class="s2">&quot;_pvspec&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Line ID (vlsr=</span><span class="si">%.2f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">,</span>
                                <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="p">{},</span> <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">blends</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">continuum</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="p">),</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Corr. Coeff.&quot;</span><span class="p">,</span>
                                <span class="n">thumbnail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">line_ref</span><span class="p">)</span>
                <span class="n">imname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getFigure</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">thumbnailname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getThumbnail</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">_caption</span> <span class="o">=</span> <span class="s2">&quot;Identified lines overlaid on Correlation Coefficient plot from PVCorr_BDP.&quot;</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="p">{</span><span class="n">bt</span><span class="o">.</span><span class="n">SVG</span><span class="p">:</span> <span class="n">imname</span><span class="p">},</span> <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnailname</span><span class="p">,</span>
                              <span class="n">thumbnailtype</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">PNG</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">_caption</span><span class="p">)</span>
                <span class="n">llbdp</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;pvspec&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">llbdp</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">llbdp</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">imname</span><span class="p">,</span>
                                              <span class="n">thumbnailname</span><span class="p">,</span> <span class="n">_caption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="p">[</span><span class="s2">&quot;linelist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SummaryEntry</span><span class="p">(</span><span class="n">llbdp</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">serialize</span><span class="p">(),</span> <span class="s2">&quot;LineID_AT&quot;</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">taskargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="p">[</span><span class="s2">&quot;spectra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">SummaryEntry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="p">,</span> <span class="s2">&quot;LineID_AT&quot;</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">taskargs</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addoutput</span><span class="p">(</span><span class="n">llbdp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s2">&quot;nolines&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="n">Peaks</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="c1"># no lines detected</span>
            <span class="k">return</span>

        <span class="c1"># do pattern matching</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;stats&quot;</span> <span class="p">:</span> <span class="p">[],</span>
                 <span class="s2">&quot;specs&quot;</span> <span class="p">:</span> <span class="p">[],</span>
                 <span class="s2">&quot;pvc&quot;</span>   <span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">toomanypeaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkcount</span><span class="p">(</span><span class="n">allpeaks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="s2">&quot;CubeStat </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;ON&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;AUTO&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">toomanypeaks</span><span class="p">):</span>
                <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">findpatterns</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">allpeaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">statseg</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stpeaks</span> <span class="o">=</span> <span class="n">Peaks</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">stpeaks</span><span class="o">.</span><span class="n">singles</span> <span class="o">=</span> <span class="n">allpeaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">stpeaks</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">stpeaks</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statseg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stpeaks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="s2">&quot;CubeSpec </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;ON&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;AUTO&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">toomanypeaks</span><span class="p">):</span>
                <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">findpatterns</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">allpeaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">specseg</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sppeaks</span> <span class="o">=</span> <span class="n">Peaks</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">sppeaks</span><span class="o">.</span><span class="n">singles</span> <span class="o">=</span> <span class="n">allpeaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">sppeaks</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">sppeaks</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specseg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sppeaks</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pvpeaks</span> <span class="o">=</span> <span class="n">Peaks</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="p">)</span>
            <span class="n">pvpeaks</span><span class="o">.</span><span class="n">singles</span> <span class="o">=</span> <span class="n">allpeaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span>
            <span class="n">pvpeaks</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvseg</span>
            <span class="n">pvpeaks</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvpeaks</span>
        <span class="c1"># now flatten the pattern to remove noise</span>
        <span class="n">mpattern</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">)):</span>
            <span class="n">mpattern</span> <span class="o">+=</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
            <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">)):</span>
            <span class="n">mpattern</span> <span class="o">+=</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
            <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mpattern</span> <span class="o">+=</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
            <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># initialize the output bdp</span>
        <span class="n">llist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">foundsomething</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># for each detected line search for an identity</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;vlsr&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">999998.0</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;Rest&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;Sky&quot;</span>
        <span class="n">tier1</span><span class="p">,</span> <span class="n">hfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettier1</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">)):</span>
            <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">converttofreq</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">])):</span>
            <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">converttofreq</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">converttofreq</span><span class="p">()</span>

        <span class="c1"># start with the statspec</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">)):</span>
            <span class="n">drop</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">noise</span><span class="p">(),</span> <span class="n">tier1</span><span class="p">,</span> <span class="n">hfs</span><span class="p">,</span> <span class="n">isstats</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># if at least 1 line was found, apply the results to the other spectra</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">foundsomething</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getstart</span><span class="p">()):</span>
                    <span class="n">drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> \
                   <span class="n">k</span> <span class="o">&gt;</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getend</span><span class="p">()):</span>
                    <span class="n">drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drop</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
            <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">validatelinesegments</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">noise</span><span class="p">(),</span> <span class="n">tier1</span><span class="p">,</span> <span class="n">hfs</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">foundsomething</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">foundsomething</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">drop</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="ow">and</span> \
                   <span class="n">k</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getstart</span><span class="p">()),</span>
                           <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getend</span><span class="p">())):</span>
                    <span class="n">drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;minchan&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> \
                   <span class="ow">and</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getstart</span><span class="p">()),</span>
                               <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getend</span><span class="p">())):</span>
                    <span class="n">drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drop</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>

            <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">validatelinesegments</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">noise</span><span class="p">(),</span> <span class="n">tier1</span><span class="p">,</span> <span class="n">hfs</span><span class="p">,</span> <span class="n">ispvcorr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">validatelinesegments</span><span class="p">()</span>

        <span class="c1"># check through all lines:</span>
        <span class="c1">#  1. Unidentified lines cannot overlap with identified lines</span>
        <span class="c1">#  2. One line cannot be fully indside of another line, unless forced</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">loopcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span> <span class="ow">and</span> <span class="n">loopcount</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">])):</span>
                        <span class="k">for</span> <span class="n">sline</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="n">lo</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">ro</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">env</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">lo</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">ro</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="ow">and</span>\
                               <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">env</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># Ulines cannot overlap with identified lines</span>
                            <span class="k">if</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;transition&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
                                <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">env</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">))):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;transition&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
                                <span class="n">sline</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">ll</span><span class="p">,</span> <span class="n">sline</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                            <span class="n">lo</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">ro</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">env</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">lo</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">ro</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="ow">and</span>\
                               <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">env</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># Ulines cannot overlap with identified lines</span>
                            <span class="k">if</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;transition&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
                                <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">env</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">))):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;transition&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
                                <span class="n">sline</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sline</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="n">lo</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">ro</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">env</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">lo</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">ro</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="ow">and</span>\
                               <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">env</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># Ulines can overlap</span>
                            <span class="k">if</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;force&quot;</span><span class="p">):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;transition&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
                                <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="p">((</span><span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">env</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">))))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;force&quot;</span><span class="p">):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;transition&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
                                <span class="n">sline</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">])):</span>
                        <span class="k">for</span> <span class="n">sline</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="n">lo</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">ro</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">env</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">lo</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">ro</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="ow">and</span>\
                               <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">env</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># Ulines cannot overlap with identified lines</span>
                            <span class="k">if</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;transition&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
                                <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">env</span>  <span class="ow">and</span> <span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">))):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;transition&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
                                <span class="n">sline</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">sline</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="n">lo</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">ro</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">env</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">lo</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">ro</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="ow">and</span>\
                               <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">env</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># Ulines cannot overlap with identified lines</span>
                            <span class="k">if</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;transition&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
                                <span class="n">line</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">env</span>  <span class="ow">and</span> <span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">))):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;transition&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
                                <span class="n">sline</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sline</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="n">lo</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">ro</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">env</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">lo</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">ro</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="ow">and</span>\
                               <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sline</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">():</span>
                                <span class="n">env</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># Ulines can overlap</span>
                            <span class="k">if</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;force&quot;</span><span class="p">):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
                            <span class="k">elif</span> <span class="p">((</span><span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lo</span> <span class="ow">or</span> <span class="n">ro</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">env</span>  <span class="ow">and</span> <span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">))))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;force&quot;</span><span class="p">):</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">poffset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">freqtovel</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span> <span class="n">sline</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span>
                                <span class="n">vel</span> <span class="o">=</span> <span class="n">poffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;uid&quot;</span>  <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;formula&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;energies&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;energies&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;linestrength&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;frequency&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;mass&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;plain&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;plain&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;isocount&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;isocount&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;hfnum&quot;</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;hfnum&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="n">poffset</span><span class="p">,</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="n">vel</span>
                                       <span class="p">}</span>
            <span class="n">loopcount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">)):</span>
            <span class="n">ulist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mlist</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">v</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;peakrms&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spec</span><span class="p">()[</span><span class="n">v</span><span class="o">.</span><span class="n">getstart</span><span class="p">():</span><span class="n">v</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])))</span>
                <span class="n">v</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;peakintensity&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;peakrms&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">noise</span><span class="p">()))</span>
                <span class="k">if</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
                    <span class="n">ulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="c1"># eliminate very close u lines</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ulist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">frq</span> <span class="o">=</span> <span class="n">ulist</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">tol</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ulist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()]</span> <span class="o">-</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ulist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;</span> <span class="n">frq</span> <span class="o">&lt;</span> <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="n">ulist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()))],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span> <span class="n">ulist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">()))]])</span>
                        <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>
                        <span class="k">del</span> <span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">break</span>
            <span class="c1"># eliminate doubles</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mlist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="n">mlist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span>
                <span class="n">qn</span> <span class="o">=</span> <span class="n">mlist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">qn</span> <span class="o">==</span> <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">):</span>
                        <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="n">mlist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()))],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span> <span class="n">mlist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">()))]])</span>
                        <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>
                        <span class="k">del</span> <span class="n">mlist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">break</span>
            <span class="n">mlist</span> <span class="o">+=</span> <span class="n">ulist</span>

            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Frequency (GHz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">mult</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mult</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
            <span class="n">myplot</span><span class="o">.</span><span class="n">makespec</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spec</span><span class="p">(</span><span class="n">csub</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                            <span class="n">chan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">chans</span><span class="p">(),</span>
                            <span class="n">cutoff</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">contin</span><span class="p">()</span> <span class="o">+</span> <span class="n">mult</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">noise</span><span class="p">()</span> <span class="o">*</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">))),</span>
                            <span class="n">figname</span><span class="o">=</span><span class="n">imbase</span> <span class="o">+</span> <span class="s2">&quot;_statspec</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Line ID (vlsr=</span><span class="si">%.2f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">,</span>
                            <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="n">mlist</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                            <span class="n">blends</span><span class="o">=</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">blends</span><span class="p">,</span> <span class="n">continuum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">contin</span><span class="p">(),</span>
                            <span class="n">ylabel</span><span class="o">=</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">thumbnail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">line_ref</span><span class="p">)</span>
            <span class="n">imname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getFigure</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">thumbnailname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getThumbnail</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="p">{</span><span class="n">bt</span><span class="o">.</span><span class="n">SVG</span><span class="p">:</span> <span class="n">imname</span><span class="p">},</span> <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnailname</span><span class="p">,</span>
                          <span class="n">thumbnailtype</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">PNG</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">caption</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">llbdp</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;statspec</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">llbdp</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">llbdp</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">imname</span><span class="p">,</span> <span class="n">thumbnailname</span><span class="p">,</span>
                                          <span class="n">caption</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">])):</span>
            <span class="n">ulist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mlist</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">v</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;peakintensity&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spec</span><span class="p">()[</span><span class="n">v</span><span class="o">.</span><span class="n">getstart</span><span class="p">():</span><span class="n">v</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])))</span>
                <span class="n">v</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;peakrms&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;peakintensity&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">noise</span><span class="p">()))</span>

                <span class="k">if</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
                    <span class="n">ulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="c1"># eliminate very close u lines</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ulist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">frq</span> <span class="o">=</span> <span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">tol</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()]</span> <span class="o">-</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;</span> <span class="n">frq</span> <span class="o">&lt;</span> <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()),</span>
                                                  <span class="nb">max</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span> <span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())])</span>
                        <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>
                        <span class="k">del</span> <span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">break</span>
            <span class="c1"># eliminate doubles</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mlist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="n">mlist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span>
                <span class="n">qn</span> <span class="o">=</span> <span class="n">mlist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">qn</span> <span class="o">==</span> <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">):</span>
                        <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="n">mlist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()),</span>
                                                  <span class="nb">max</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span> <span class="n">mlist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())])</span>
                        <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>
                        <span class="k">del</span> <span class="n">mlist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">break</span>

            <span class="n">mlist</span> <span class="o">+=</span> <span class="n">ulist</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Frequency (GHz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">myplot</span><span class="o">.</span><span class="n">makespec</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spec</span><span class="p">(</span><span class="n">csub</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                            <span class="n">chan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">chans</span><span class="p">(),</span>
                            <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">contin</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">noise</span><span class="p">()</span> <span class="o">*</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">)),</span>
                            <span class="n">figname</span><span class="o">=</span><span class="n">imbase</span> <span class="o">+</span> <span class="s2">&quot;_spec</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Line ID (vlsr=</span><span class="si">%.2f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="n">mlist</span><span class="p">,</span>
                            <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">blends</span><span class="o">=</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">blends</span><span class="p">,</span>
                            <span class="n">continuum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">contin</span><span class="p">(),</span> <span class="n">thumbnail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">line_ref</span><span class="p">)</span>
            <span class="n">imname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getFigure</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">thumbnailname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getThumbnail</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span>
                                                <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">_caption</span> <span class="o">=</span> <span class="s2">&quot;Identified lines overlaid on input spectrum #</span><span class="si">%i</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="p">{</span><span class="n">bt</span><span class="o">.</span><span class="n">SVG</span><span class="p">:</span> <span class="n">imname</span><span class="p">},</span> <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnailname</span><span class="p">,</span>
                          <span class="n">thumbnailtype</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">PNG</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">_caption</span><span class="p">)</span>
            <span class="n">llbdp</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;spec</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">llbdp</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">llbdp</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">imname</span><span class="p">,</span> <span class="n">thumbnailname</span><span class="p">,</span>
                                          <span class="n">_caption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ulist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">v</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;peakintensity&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">spec</span><span class="p">()[</span><span class="n">v</span><span class="o">.</span><span class="n">getstart</span><span class="p">():</span><span class="n">v</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">])))</span>
                <span class="n">v</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;peakrms&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;peakintensity&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">noise</span><span class="p">()))</span>
                <span class="k">if</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
                    <span class="n">ulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="c1"># eliminate very close u lines</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ulist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">frq</span> <span class="o">=</span> <span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                <span class="n">tol</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()]</span> <span class="o">-</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;</span> <span class="n">frq</span> <span class="o">&lt;</span> <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()),</span>
                                                  <span class="nb">max</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span> <span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())])</span>
                        <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>
                        <span class="k">del</span> <span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">break</span>
            <span class="c1"># eliminate doubles</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mlist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="n">mlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span>
                <span class="n">qn</span> <span class="o">=</span> <span class="n">mlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">qn</span> <span class="o">==</span> <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">):</span>
                        <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="n">mlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()),</span>
                                                  <span class="nb">max</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span> <span class="n">mlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())])</span>
                        <span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mlist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>
                        <span class="k">del</span> <span class="n">mlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">break</span>
            <span class="n">mlist</span> <span class="o">+=</span> <span class="n">ulist</span>


            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Frequency (GHz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">myplot</span><span class="o">.</span><span class="n">makespec</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">freq</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">spec</span><span class="p">(</span><span class="n">csub</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">chan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">chans</span><span class="p">(),</span>
                            <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="o">.</span><span class="n">noise</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;numsigma&quot;</span><span class="p">),</span>
                            <span class="n">figname</span><span class="o">=</span><span class="n">imbase</span> <span class="o">+</span> <span class="s2">&quot;_pvspec&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Line ID (vlsr=</span><span class="si">%.2f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlsr</span><span class="p">,</span>
                            <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="n">mlist</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">,</span> <span class="n">blends</span><span class="o">=</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">blends</span><span class="p">,</span>
                            <span class="n">continuum</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="p">),</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Correlation&quot;</span><span class="p">,</span>
                            <span class="n">thumbnail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">line_ref</span><span class="p">)</span>
            <span class="n">imname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getFigure</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">thumbnailname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getThumbnail</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">_caption</span> <span class="o">=</span> <span class="s2">&quot;Identified lines overlaid on correlation coefficient plot from PVCorr_BDP.&quot;</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="p">{</span><span class="n">bt</span><span class="o">.</span><span class="n">SVG</span><span class="p">:</span> <span class="n">imname</span><span class="p">},</span> <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnailname</span><span class="p">,</span>
                          <span class="n">thumbnailtype</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">PNG</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">_caption</span><span class="p">)</span>
            <span class="n">llbdp</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;pvspec&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">llbdp</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">llbdp</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">imname</span><span class="p">,</span> <span class="n">thumbnailname</span><span class="p">,</span>
                                          <span class="n">_caption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">])</span>

        <span class="n">llist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># merge the results into a single list</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">)):</span>
            <span class="n">keylist</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">keylist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keylist</span><span class="p">:</span>

                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">llist</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                       <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">):</span>
                        <span class="n">tt</span> <span class="o">=</span> <span class="p">[</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span>
                              <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span>
                              <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">()]</span>
                        <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">))],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">))]])</span>
                        <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tt</span><span class="p">))],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">tt</span><span class="p">))]])</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span> <span class="ow">or</span> \
                       <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)):</span>
                        <span class="n">llist</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">llist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">blends</span><span class="p">:</span>
                <span class="n">place</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">llist</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">item</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span> <span class="ow">or</span> \
                       <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)):</span>

                        <span class="n">place</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">place</span><span class="p">:</span>
                    <span class="n">llist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">]:</span>
            <span class="n">blendcheck</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">place</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">llist</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">))</span> <span class="ow">or</span> \
                       <span class="p">(</span><span class="s2">&quot;U&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)):</span>
                        <span class="n">place</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">getstart</span><span class="p">()))],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">getend</span><span class="p">()))]])</span>
                        <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>

                        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">blendcheck</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">))</span>

                    <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span> <span class="ow">or</span> \
                       <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)):</span>
                        <span class="n">llist</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                        <span class="n">place</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">place</span><span class="p">:</span>
                    <span class="n">llist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="c1"># do the same for the blends, keep in mind the blendcheck</span>
            <span class="k">for</span> <span class="n">blend</span> <span class="ow">in</span> <span class="n">ps</span><span class="o">.</span><span class="n">blends</span><span class="p">:</span>
                <span class="n">place</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">llist</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span> <span class="ow">or</span> \
                         <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">blendcheck</span><span class="p">:</span>
                            <span class="n">blend</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">,</span> <span class="n">blendcheck</span><span class="p">[</span><span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)])</span>
                        <span class="n">llist</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">blend</span><span class="p">)</span>
                        <span class="n">place</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># if it is already there then just drop it</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                       <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">mindx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">bqn</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">frq</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="n">bls</span> <span class="o">=</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                                   <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bls</span><span class="p">:</span>
                                    <span class="n">bqn</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span>
                                    <span class="n">frq</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
                                    <span class="n">bls</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">llist</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="n">llist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">bqn</span><span class="p">:</span><span class="c1"># and llist[j].getkey(&quot;frequency&quot;) == frq:</span>
                                    <span class="n">mindx</span> <span class="o">=</span> <span class="n">j</span>
                                    <span class="k">break</span>

                            <span class="k">if</span> <span class="n">mindx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setstart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span>
                                                                                        <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span>
                                                                                        <span class="n">blend</span><span class="o">.</span><span class="n">getstart</span><span class="p">()))])</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span>
                                                                                      <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span>
                                                                                      <span class="n">blend</span><span class="o">.</span><span class="n">getend</span><span class="p">()))])</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>
                                <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">,</span> <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">))</span>

                                <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;blend&quot;</span> <span class="p">:</span> <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">),</span>
                                        <span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>

                                <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mindx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">bqn</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">bls</span> <span class="o">=</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span>
                            <span class="c1"># get the strongest one in the blend</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                                   <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bls</span><span class="p">:</span>
                                    <span class="n">bqn</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span>
                                    <span class="n">bls</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">llist</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="n">llist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">bqn</span><span class="p">:</span>
                                    <span class="n">mindx</span> <span class="o">=</span> <span class="n">j</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="n">mindx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setstart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span>
                                                                                        <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()))])</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span>
                                                                                      <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">()))])</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>

                        <span class="n">place</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">place</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">blendcheck</span><span class="p">:</span>
                        <span class="n">blend</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">,</span> <span class="n">blendcheck</span><span class="p">[</span><span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)])</span>

                    <span class="n">llist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blend</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">blendcheck</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">place</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">llist</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">))</span> <span class="ow">or</span> \
                       <span class="p">(</span><span class="s2">&quot;U&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">)):</span>
                        <span class="n">place</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;chans&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">getstart</span><span class="p">()))],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">getend</span><span class="p">()))]])</span>
                        <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>

                        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">blendcheck</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span> <span class="ow">or</span> \
                       <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)):</span>
                        <span class="n">llist</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

                        <span class="n">place</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">place</span><span class="p">:</span>
                    <span class="n">llist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="c1"># do the same for the blends, keep in mind the blendcheck</span>

            <span class="k">for</span> <span class="n">blend</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">blends</span><span class="p">:</span>
                <span class="n">place</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">llist</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span> <span class="ow">or</span> \
                       <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">blendcheck</span><span class="p">:</span>
                            <span class="n">blend</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">,</span> <span class="n">blendcheck</span><span class="p">[</span><span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)])</span>
                        <span class="n">llist</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">blend</span><span class="p">)</span>

                        <span class="n">place</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># if it is already there then just modify it if necessary</span>
                    <span class="k">if</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                       <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">mindx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">bqn</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">bls</span> <span class="o">=</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span>
                            <span class="c1"># get the strongest one in the blend</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                                   <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bls</span><span class="p">:</span>
                                    <span class="n">bqn</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span>
                                    <span class="n">bls</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">llist</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="n">llist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">bqn</span><span class="p">:</span>
                                    <span class="n">mindx</span> <span class="o">=</span> <span class="n">j</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="n">mindx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setstart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span>
                                                                                        <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span>
                                                                                        <span class="n">blend</span><span class="o">.</span><span class="n">getstart</span><span class="p">()))])</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span>
                                                                                      <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span>
                                                                                      <span class="n">blend</span><span class="o">.</span><span class="n">getend</span><span class="p">()))])</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>
                                <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">,</span> <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">))</span>

                                <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
                                <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;blend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span>
                                <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mindx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">bqn</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">bls</span> <span class="o">=</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span>
                            <span class="c1"># get the strongest one in the blend</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                                   <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bls</span><span class="p">:</span>
                                    <span class="n">bqn</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span>
                                    <span class="n">bls</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;pvc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;linestrength&quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">llist</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="n">llist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">bqn</span><span class="p">:</span>
                                    <span class="n">mindx</span> <span class="o">=</span> <span class="n">j</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="n">mindx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setstart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span>
                                                                                        <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()))])</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">(),</span>
                                                                                      <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">()))])</span>
                                    <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())],</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">())]])</span>
                                <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;velocity&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;peakintensity&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;peakoffset&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;fwhm&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                        <span class="s2">&quot;peakrms&quot;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
                                <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;blend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">llist</span><span class="p">[</span><span class="n">mindx</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span>
                                <span class="n">llist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

                        <span class="n">place</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">place</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">blendcheck</span><span class="p">:</span>
                        <span class="n">blend</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">,</span> <span class="n">blendcheck</span><span class="p">[</span><span class="n">blend</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;blend&quot;</span><span class="p">)])</span>
                    <span class="n">llist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blend</span><span class="p">)</span>
        <span class="n">ulist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">llist</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Ukn&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
                <span class="n">ulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="c1"># eliminate very close u lines</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ulist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">frq</span> <span class="o">=</span> <span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">&lt;</span> <span class="n">frq</span> <span class="o">&lt;</span> <span class="n">ulist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">ulist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">break</span>

        <span class="n">mlist</span> <span class="o">+=</span> <span class="n">ulist</span>
        <span class="k">for</span> <span class="n">frc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="n">mlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frc</span><span class="p">)</span>
        <span class="c1">#mlist[0]</span>
        <span class="n">mlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">)))</span>
        <span class="n">duplicate_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mlist</span><span class="p">:</span>
            <span class="n">addon</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s2">&quot; Found line: &quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;transition&quot;</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s2">&quot; @ &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;GHz, channels &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">getstart</span><span class="p">())</span> <span class="o">+</span>
                        <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">getend</span><span class="p">())</span> <span class="o">+</span> <span class="n">addon</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">duplicate_lines</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="s2">&quot; Skipping duplicate UID: &quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">duplicate_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">))</span>
            <span class="n">llbdp</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">regression</span><span class="p">(</span><span class="s2">&quot;LINEID: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%.5f</span><span class="s2">  </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">),</span>
                                                           <span class="n">m</span><span class="o">.</span><span class="n">getstart</span><span class="p">(),</span> <span class="n">m</span><span class="o">.</span><span class="n">getend</span><span class="p">()))</span>
        <span class="c1"># Need to adjust plot DPI = 72 for SVG; stick to PNG for now...</span>
        <span class="n">myplot</span><span class="o">.</span><span class="n">_plot_type</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PlotControl</span><span class="o">.</span><span class="n">PNG</span>
        <span class="n">myplot</span><span class="o">.</span><span class="n">_plot_mode</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PlotControl</span><span class="o">.</span><span class="n">NONE</span>
        <span class="n">myplot</span><span class="o">.</span><span class="n">summaryspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statspec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvspec</span><span class="p">,</span> <span class="n">imbase</span> <span class="o">+</span> <span class="s2">&quot;_summary&quot;</span><span class="p">,</span> <span class="n">llist</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
        <span class="n">imname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getFigure</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">thumbnailname</span> <span class="o">=</span> <span class="n">myplot</span><span class="o">.</span><span class="n">getThumbnail</span><span class="p">(</span><span class="n">figno</span><span class="o">=</span><span class="n">myplot</span><span class="o">.</span><span class="n">figno</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_caption</span> <span class="o">=</span> <span class="s2">&quot;Identified lines overlaid on Signal/Noise plot of all spectra.&quot;</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="p">{</span><span class="n">bt</span><span class="o">.</span><span class="n">PNG</span><span class="p">:</span> <span class="n">imname</span><span class="p">},</span> <span class="n">thumbnail</span><span class="o">=</span><span class="n">thumbnailname</span><span class="p">,</span>
                      <span class="n">thumbnailtype</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">PNG</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">_caption</span><span class="p">)</span>

        <span class="n">llbdp</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">addimage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">llbdp</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">llbdp</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Signal/Noise&quot;</span><span class="p">,</span> <span class="n">imname</span><span class="p">,</span>
                                      <span class="n">thumbnailname</span><span class="p">,</span> <span class="n">_caption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">])</span>

        <span class="c1"># The plain ascii list may still be useful for regression testing</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="p">[</span><span class="s2">&quot;linelist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SummaryEntry</span><span class="p">(</span><span class="n">llbdp</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">serialize</span><span class="p">(),</span> <span class="s2">&quot;LineID_AT&quot;</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">taskargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="p">[</span><span class="s2">&quot;spectra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">SummaryEntry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_description</span><span class="p">,</span> <span class="s2">&quot;LineID_AT&quot;</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">taskargs</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addoutput</span><span class="p">(</span><span class="n">llbdp</span><span class="p">)</span>
        <span class="n">Peaks</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">end</span><span class="p">()</span></div>

<div class="viewcode-block" id="LineID_AT.summary"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.LineID_AT.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the summary dictionary from the AT, for merging</span>
<span class="sd">           into the ADMIT Summary object.</span>

<span class="sd">           LineID_AT adds the following to ADMIT summary:</span>

<span class="sd">           .. table::</span>
<span class="sd">              :class: borderless</span>

<span class="sd">              +---------+--------+---------------------------------------------+</span>
<span class="sd">              |   Key   | type   |    Description                              |</span>
<span class="sd">              +=========+========+=============================================+</span>
<span class="sd">              | linelist| table  | table of parameters of discovered lines     |</span>
<span class="sd">              +---------+--------+---------------------------------------------+</span>
<span class="sd">              | spectra | list   | the spectral plot of signal, noise, and S/N |</span>
<span class="sd">              +---------+--------+---------------------------------------------+</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           None</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           dict</span>
<span class="sd">               Dictionary of SummaryEntry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_summary&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span></div></div>


<div class="viewcode-block" id="Peaks"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks">[docs]</a><span class="k">class</span> <span class="nc">Peaks</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Lightweight class for working with the peaks found by one or more peak</span>
<span class="sd">        finding algorithms.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            A dictionary of keyword/value pairs of the parameters. Can contain</span>
<span class="sd">            any attribute. See Attributes below for a full listing of possible</span>
<span class="sd">            keywords and value types.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        centers : dict</span>

<span class="sd">        fcenters : dict</span>

<span class="sd">        singles : list</span>

<span class="sd">        fsingles : list</span>

<span class="sd">        pairs : dict</span>

<span class="sd">        x : list</span>
<span class="sd">            Listing of the x axis (frequency) for the given peaks</span>

<span class="sd">        y : list</span>
<span class="sd">            Listing of the y axis (intensity) for the given peaks</span>

<span class="sd">        offsets : set</span>
<span class="sd">            Listing of all possible offset values, shared among all instances</span>
<span class="sd">            of Peaks.</span>

<span class="sd">        offsetdone : boolean</span>
<span class="sd">            Whether or not the offsets have been converted to frequency.</span>
<span class="sd">            Internal use only should not be set manually.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;centers&quot;</span><span class="p">,</span> <span class="s2">&quot;offsets&quot;</span><span class="p">,</span> <span class="s2">&quot;singles&quot;</span><span class="p">,</span> <span class="s2">&quot;pairs&quot;</span><span class="p">,</span> <span class="s2">&quot;spec&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;offsetdone&quot;</span><span class="p">,</span> <span class="s2">&quot;fcenters&quot;</span><span class="p">,</span> <span class="s2">&quot;fsingles&quot;</span><span class="p">,</span> <span class="s2">&quot;linelist&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;blends&quot;</span><span class="p">,</span> <span class="s2">&quot;segments&quot;</span><span class="p">,</span> <span class="s2">&quot;fsegments&quot;</span><span class="p">,</span> <span class="s2">&quot;counts&quot;</span><span class="p">]</span>
    <span class="n">offsets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">offsetdone</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fcenters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">singles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fsingles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blends</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#self.x = []</span>
        <span class="c1">#self.y = []</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fsegments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#self.chans = []</span>
        <span class="k">for</span> <span class="n">kw</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;CENTERS&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">centers</span>
        <span class="nb">print</span> <span class="s2">&quot;FCENTERS&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcenters</span>
        <span class="nb">print</span> <span class="s2">&quot;SINGLES&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span>
        <span class="nb">print</span> <span class="s2">&quot;FSINGLES&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsingles</span>
        <span class="nb">print</span> <span class="s2">&quot;PAIRS&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span>
        <span class="nb">print</span> <span class="s2">&quot;LINELIST&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span>
        <span class="nb">print</span> <span class="s2">&quot;OFFSETS&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span>
        <span class="nb">print</span> <span class="s2">&quot;SEGMENTS&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span>
        <span class="nb">print</span> <span class="s2">&quot;FSEGMENTS&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsegments</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Peaks.reset"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot; Method to reset the Peaks static member variables so that LineID</span>
<span class="sd">            can be re-run without polluting the results with items from previous</span>
<span class="sd">            runs.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Peaks</span><span class="o">.</span><span class="n">offsets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">Peaks</span><span class="o">.</span><span class="n">offsetdone</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

<div class="viewcode-block" id="Peaks.removeidentified"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.removeidentified">[docs]</a>    <span class="k">def</span> <span class="nf">removeidentified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to remove already identified peaks.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            data : Peaks instance</span>
<span class="sd">                A Peaks instance to use as the base for removal</span>

<span class="sd">            tol : float</span>
<span class="sd">                The tolerance to allow (in GHz) for comparable lines</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">center</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcenters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">center</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">&lt;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">center</span> <span class="o">+</span> <span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
                    <span class="n">remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">center</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">rem</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcenters</span><span class="p">[</span><span class="n">rem</span><span class="p">]</span>
        <span class="n">remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">single</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsingles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">single</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">&lt;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">single</span> <span class="o">+</span> <span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
                    <span class="n">remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">single</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">single</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">rem</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsingles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peaks.flatten"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.flatten">[docs]</a>    <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to collapse pair peaks that are close together into single</span>
<span class="sd">            pair</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            tol : float</span>
<span class="sd">                The tolerance (minimum distance between points)</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            List containing the consolidated points</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mpattern</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">isnew</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">mpattern</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pattern</span> <span class="o">-</span> <span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">&lt;</span> <span class="n">o</span> <span class="o">&lt;</span> <span class="n">pattern</span> <span class="o">+</span> <span class="n">tol</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
                    <span class="n">isnew</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">p1</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span> <span class="o">+=</span> <span class="n">p1</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isnew</span><span class="p">:</span>
                <span class="n">mpattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="n">p1</span>
        <span class="k">return</span> <span class="n">mpattern</span></div>

<div class="viewcode-block" id="Peaks.getchan"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.getchan">[docs]</a>    <span class="k">def</span> <span class="nf">getchan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to get the channel number given the frequency</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            frq : float</span>
<span class="sd">                The frequency whose channel number is to be found</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            int containing the channel number, will be 0 or len(self.x)-1 if</span>
<span class="sd">            the frequency is outside of the frequency range in the class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">frq</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peaks.getchans"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.getchans">[docs]</a>    <span class="k">def</span> <span class="nf">getchans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to get the entire channel axis</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            masked : bool</span>
<span class="sd">                If True return a masked array with &quot;bad&quot; channels masked,</span>
<span class="sd">                else return a numpy array</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            array like containing the channel axis</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">chans</span><span class="p">(</span><span class="n">masked</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peaks.getspecs"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.getspecs">[docs]</a>    <span class="k">def</span> <span class="nf">getspecs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to get the entire spectral axis</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            masked : bool</span>
<span class="sd">                If True return a masked array with &quot;bad&quot; channels masked,</span>
<span class="sd">                else return a numpy array</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            array like containing the spectral axis</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">spec</span><span class="p">(</span><span class="n">masked</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peaks.getfreqs"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.getfreqs">[docs]</a>    <span class="k">def</span> <span class="nf">getfreqs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to get the entire frequency axis</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            masked : bool</span>
<span class="sd">                If True return a masked array with &quot;bad&quot; channels masked,</span>
<span class="sd">                else return a numpy array</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            array like containing the frequency axis</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">(</span><span class="n">masked</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peaks.getsegment"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.getsegment">[docs]</a>    <span class="k">def</span> <span class="nf">getsegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to get the segment that contains the given channel</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            chan : int</span>
<span class="sd">                The channel number to find the segment for</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Two element List containing the starting and ending channels</span>
<span class="sd">            for the segment containing the given channel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">chan</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">seg</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span></div>

<div class="viewcode-block" id="Peaks.getfsegment"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.getfsegment">[docs]</a>    <span class="k">def</span> <span class="nf">getfsegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to return the segment which contains the given frequency.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            freq : float</span>
<span class="sd">                The frequency for which the segment is requested</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            List containing the segment end points, or [None, None] if the frequency is not in a</span>
<span class="sd">            segment.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsegment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getchan</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span>
        <span class="n">fseg</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">fseg</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fseg</span></div>

<div class="viewcode-block" id="Peaks.sort"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.sort">[docs]</a>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to sort through all pairs and organize them into dictionary</span>
<span class="sd">            entries indexed by their common separation</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">listing</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">diff</span> <span class="ow">in</span> <span class="n">listing</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">[</span><span class="n">diff</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
                <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">item</span>
                <span class="c1"># search for p2 as a p1 in any other set</span>
                <span class="c1"># ignore p1 as it will have been caught in an earlier iteration</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">indx2</span><span class="p">,</span> <span class="n">item2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">indx</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">p2</span> <span class="o">==</span> <span class="n">item2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="p">:</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">item2</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="n">Peaks</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="p">[(</span><span class="n">p2</span> <span class="o">+</span> <span class="n">p1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">])</span>
                    <span class="n">Peaks</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">diff</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peaks.pairsort"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.pairsort">[docs]</a>    <span class="k">def</span> <span class="nf">pairsort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to sort a list of pairs into ascending order</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            pairs : list</span>
<span class="sd">                List of pairs (as lists) to be sorted</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            A list of the sorted pairs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">pairs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pairs</span></div>

<div class="viewcode-block" id="Peaks.patternsort"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.patternsort">[docs]</a>    <span class="k">def</span> <span class="nf">patternsort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to sort a detected patterns into sorted lists</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            pattern : dict</span>
<span class="sd">                Dictionary of the patterns to sort</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Dictionary of sorted patterns</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retpattern</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;stats&quot;</span> <span class="p">:</span> <span class="p">{},</span>
                      <span class="s2">&quot;specs&quot;</span> <span class="p">:</span> <span class="p">{}}</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">wings</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">stat</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairsort</span><span class="p">(</span><span class="n">wings</span><span class="p">)</span>
        <span class="n">retpattern</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">wings</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">spec</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairsort</span><span class="p">(</span><span class="n">wings</span><span class="p">)</span>
        <span class="n">retpattern</span><span class="p">[</span><span class="s2">&quot;specs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="k">return</span> <span class="n">retpattern</span></div>

<div class="viewcode-block" id="Peaks.getfreq"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.getfreq">[docs]</a>    <span class="k">def</span> <span class="nf">getfreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to get the frequency of the given channel, the channel can</span>
<span class="sd">            contain a fraction of a channel (e.g. 1.45)</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            chan : float</span>
<span class="sd">                The channel to convert</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Float of the frequency corresponding to the channel</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peaks.converttofreq"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.converttofreq">[docs]</a>    <span class="k">def</span> <span class="nf">converttofreq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to convert the peak and pattern locations from channel to</span>
<span class="sd">            frequency indexing</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Peaks</span><span class="o">.</span><span class="n">offsetdone</span><span class="p">:</span>
            <span class="n">tf1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">tf2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">freq</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">avgdif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tf1</span> <span class="o">-</span> <span class="n">tf2</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">Peaks</span><span class="o">.</span><span class="n">offsets</span><span class="p">:</span>
                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="n">avgdif</span><span class="p">)</span>
            <span class="n">Peaks</span><span class="o">.</span><span class="n">offsets</span> <span class="o">=</span> <span class="n">ts</span>
            <span class="n">Peaks</span><span class="o">.</span><span class="n">offsetdone</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsegments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
                <span class="n">fseg</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fsegments</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">fseg</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">fseg</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">single</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsingles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">single</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">wings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">v1</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcenters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">wings</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">wings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v1</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peaks.validatelinesegments"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.validatelinesegments">[docs]</a>    <span class="k">def</span> <span class="nf">validatelinesegments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to ensure that all line channel ranges do not go past the</span>
<span class="sd">            bounds of the original segments.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">drop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">low</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">getstart</span><span class="p">()</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">getend</span><span class="p">()</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fhigh</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">flow</span> <span class="ow">and</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">flow</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fhigh</span> <span class="ow">and</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">hi</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">fhigh</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">fhigh</span> <span class="ow">and</span> <span class="n">flow</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fhigh</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flow</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">:</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fhigh</span><span class="p">:</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="mf">1000000.</span>
                <span class="n">current</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="c1"># find the closest that is less than</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">)):</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">hi</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="p">:</span>
                        <span class="n">distance</span> <span class="o">=</span> <span class="n">dist</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">setend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">chans</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">getchanindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">current</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">setfend</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">()),</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flow</span><span class="p">:</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="mf">1000000.</span>
                <span class="n">current</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="c1"># find the closest that is less than</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">)):</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">low</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="p">:</span>
                        <span class="n">distance</span> <span class="o">=</span> <span class="n">dist</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">setstart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">chans</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">getchanindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">current</span><span class="p">][</span><span class="mi">0</span><span class="p">])])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">setfstart</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getend</span><span class="p">()),</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">getfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">getstart</span><span class="p">())))</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">drop</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="n">f</span><span class="p">]</span></div>

<div class="viewcode-block" id="Peaks.centerfreq"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.centerfreq">[docs]</a>    <span class="k">def</span> <span class="nf">centerfreq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to get the center frequency of the spectrum</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            None</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Float containing the center frequency of the spectrum</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">centerfreq</span><span class="p">()</span></div>

<div class="viewcode-block" id="Peaks.limitwidth"><a class="viewcode-back" href="../../../module/admit.at/LineID_AT.html#admit.at.LineID_AT.Peaks.limitwidth">[docs]</a>    <span class="k">def</span> <span class="nf">limitwidth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to ensure that the given peak and line width fit within its segment</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            center : float</span>
<span class="sd">                The center frequency in GHz</span>

<span class="sd">            width : float</span>
<span class="sd">                The half width of the line in GHz</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Two element List containing the start and end frequencies, limited by the</span>
<span class="sd">            segment boundaries</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsegments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">center</span> <span class="o">&lt;=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span> <span class="o">-</span> <span class="n">width</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">center</span> <span class="o">+</span> <span class="n">width</span><span class="p">)]</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">ADMIT 1.0.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, The ADMIT Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>