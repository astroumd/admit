<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Scripts that show real-world flows &#8212; ADMIT 1.0.6 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="ADMIT 1.0.6 documentation" href="index.html" />
    <link rel="next" title="Installation Guide" href="installguide.html" />
    <link rel="prev" title="Multiflow Projects" href="multiflows.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="installguide.html" title="Installation Guide"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="multiflows.html" title="Multiflow Projects"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ADMIT 1.0.6 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="scripts-that-show-real-world-flows">
<h1>Scripts that show real-world flows<a class="headerlink" href="#scripts-that-show-real-world-flows" title="Permalink to this headline">¶</a></h1>
<p>The Python scripts below are detailed, working examples of ADMIT processing as
might be done in the ALMA pipeline or by a scientist with an ALMA FITS cube.</p>
<div class="section" id="example-1-ingest-through-lineid-and-moment">
<h2>Example 1: <a class="reference external" href="module/admit.at/Ingest_AT.html">Ingest</a> through <a class="reference external" href="module/admit.at/LineID_AT.html">LineID</a> and <a class="reference external" href="module/admit.at/Moment_AT.html">Moment</a><a class="headerlink" href="#example-1-ingest-through-lineid-and-moment" title="Permalink to this headline">¶</a></h2>
<p id="admit-example1">This script takes a FITS cube and does the following:</p>
<ol class="arabic simple">
<li>Create an ADMIT project directory and import the FITS cube into a CASA image. [<a class="reference external" href="module/admit.at/Ingest_AT.html">Ingest</a>]</li>
<li>Compute <a class="reference external" href="https://en.wikipedia.org/wiki/Robust_statistics">robust statistics</a> on the input data. [<a class="reference external" href="module/admit.at/CubeStats_AT.html">CubeStats</a>]</li>
<li>Sum all cube along all channels of the frequency axis to make a integrated map. [<a class="reference external" href="module/admit.at/CubeSum_AT.html">CubeSum</a>]</li>
<li>Compute a spectrum through the cube at a specified point (default: the spatial center). [<a class="reference external" href="module/admit.at/CubeSpectrum_AT.html">CubeSpectrum</a>]</li>
<li>Create a position-velocity diagram by selecting an optimum slice position angle through examination of the emission properties. [<a class="reference external" href="module/admit.at/PVSlice_AT.html">PVSlice</a>]</li>
<li>Compute a position-velocity cross-correlation [<a class="reference external" href="module/admit.at/PVCorr_AT.html">PVCorr</a>]</li>
<li>Identify any spectral lines present in the data [<a class="reference external" href="module/admit.at/LineID_AT.html">LineID</a>]</li>
<li>Create a cutout cube for each spectral lines identified [<a class="reference external" href="module/admit.at/LineCube_AT.html">LineCube</a>]</li>
<li>Compute moment 0,1,2 maps, and spectra for each cutout cube [<a class="reference external" href="module/admit.at/Moment_AT.html">Moment</a>, <a class="reference external" href="module/admit.at/CubeSpectrum_AT.html">CubeSpectrum</a>]</li>
<li>Write out the ADMIT project results to XML and a summary HTML file.</li>
</ol>
<div class="section" id="admit-example1-py">
<h3><a class="reference external" href="admit-example1.py">admit_example1.py</a><a class="headerlink" href="#admit-example1-py" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Line #</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>casarun is ADMIT&#8217;s wrapper for running Python scripts with &#8216;casapy  &#8211;quiet &#8211;nogui -c&#8217;</td>
</tr>
<tr class="row-odd"><td>21</td>
<td>You need only to &#8216;import admit&#8217; to get all ADMIT functionality.</td>
</tr>
<tr class="row-even"><td>27-45</td>
<td>Initial parameters to for script options.</td>
</tr>
<tr class="row-odd"><td>48-54</td>
<td>ALMA does not yet pass VLSR to its output cubes, so we have to kludge it here.</td>
</tr>
<tr class="row-even"><td>56-70</td>
<td>Method to create string name of output directory based on input cube name.  E.g., for
input cube &#8216;mycube.fits&#8217;, output directory will be &#8216;mycube.admit&#8217;</td>
</tr>
<tr class="row-odd"><td>73-80</td>
<td>Parse command line arguments</td>
</tr>
<tr class="row-even"><td>89-91</td>
<td>Potentially clean up an old run</td>
</tr>
<tr class="row-odd"><td>98</td>
<td>Create an ADMIT project or open existing one (if it wasn&#8217;t cleaned up)</td>
</tr>
<tr class="row-even"><td>100-108</td>
<td>If a new ADMIT project, copy the FITS file into it, otherwise print some info and exit</td>
</tr>
<tr class="row-odd"><td>111</td>
<td>Set default plotting parameters.</td>
</tr>
<tr class="row-even"><td>114-116</td>
<td>Create the first task, <a class="reference external" href="module/admit.at/Ingest_AT.html">Ingest</a>, which reads in the FITS cube, and add the task to the
project <a class="reference external" href="module/admit/FlowManager.html">flow</a>. Optionally mask data that are zero (useMask=True).</td>
</tr>
<tr class="row-odd"><td>119-123</td>
<td>Create the second task, CubeStats_AT which calculates data statistics, and add the task
to the project <a class="reference external" href="module/admit/FlowManager.html">flow</a>. Set the method of robust statistics to be used (robust) and
optionally create the peak-point plot (usePPP=True).</td>
</tr>
<tr class="row-even"><td>125-129</td>
<td>Create the third task, CubeSum_AT which calculates a map over all channels, and add it to
the <a class="reference external" href="module/admit/FlowManager.html">flow</a>.</td>
</tr>
<tr class="row-odd"><td>131-137</td>
<td>Create the fourth task, CubeSpectrum_AT calculates a spectrum through the cube and add it
to the <a class="reference external" href="module/admit/FlowManager.html">flow</a>.</td>
</tr>
<tr class="row-even"><td>141-146</td>
<td>Choose one of the hardcoded ways of specifying a slice or slit for a position-velocity
diagram.   See <a class="reference external" href="module/admit.at/PVSlice_AT.html">PVSlice</a> for the difference between slices and slits.</td>
</tr>
<tr class="row-odd"><td>147-151</td>
<td>Alternatively, let PVSlice_AT determine the best slice location.</td>
</tr>
<tr class="row-even"><td>152-153</td>
<td>Now create the 5th task, <a class="reference external" href="module/admit.at/PVSlice_AT.html">PVSlice</a>, and add it to the <a class="reference external" href="module/admit/FlowManager.html">flow</a>.</td>
</tr>
<tr class="row-odd"><td>155-156</td>
<td>Create the 6th task, <a class="reference external" href="module/admit.at/PVCorr_AT.html">PVCorr</a>, and add it to the <a class="reference external" href="module/admit/FlowManager.html">flow</a>.</td>
</tr>
<tr class="row-even"><td>159-166</td>
<td>This is a workaround for the fact that ALMA data cubes do not currently include the
source LSR velocity in the image header.  So we look in our own internal list to see if
there is an entry for the source.  Future releases should not need this workaround.</td>
</tr>
<tr class="row-odd"><td>168-170</td>
<td>Create the 6th task, <a class="reference external" href="module/admit.at/LineID_AT.html">LineID</a>, and add it to the <a class="reference external" href="module/admit/FlowManager.html">flow</a>.</td>
</tr>
<tr class="row-even"><td>168-170</td>
<td>Create the 7th task, <a class="reference external" href="module/admit.at/LineCube_AT.html">LineCube</a>, and add it to the <a class="reference external" href="module/admit/FlowManager.html">flow</a>. Set the growth option to
include 10 channels around the channel range found by <a class="reference external" href="module/admit.at/LineID_AT.html">LineID</a>.</td>
</tr>
<tr class="row-odd"><td>172-174</td>
<td>Now we must run the tasks created so far, so that the subsequent tasks, which depend
the number of lines found, can run.</td>
</tr>
<tr class="row-even"><td>179-180</td>
<td>Now we must run the tasks created so far, so that the subsequent tasks, which depend
the number of lines found, can run.   Write the results to disk.</td>
</tr>
<tr class="row-odd"><td>183-184</td>
<td>Informational, print the number of lines found, equal the the length of the linecube
output BDP vector.</td>
</tr>
<tr class="row-even"><td>193-195</td>
<td>For each spectral line found, there will be a linecube image, accessed by
<a class="reference external" href="module/admit.bdp/Image_BDP.html#admit.bdp.Image_BDP.Image_BDP.getimagefile">ImageBDP.getimagefile</a>.</td>
</tr>
<tr class="row-odd"><td>197</td>
<td>Make the tuple needed for the subsequent addTask</td>
</tr>
<tr class="row-even"><td>198</td>
<td>Create and add a <a class="reference external" href="module/admit.at/Moment_AT.html">Moment</a> task for the i-th spectral line.</td>
</tr>
<tr class="row-odd"><td>200-202</td>
<td>Set the parameters for the moment tasks</td>
</tr>
<tr class="row-even"><td>203-214</td>
<td>Make a choice as to how to compute the <a class="reference external" href="module/admit.at/CubeSpectrum_AT.html">CubeSpectrum</a> for each output of <a class="reference external" href="module/admit.at/LineCube_AT.html">LineCube</a>. Use
the peak the moment map (usePeak=True), the positions listed in maxpos, or the location
of the original input FITS cube emission maximum.</td>
</tr>
<tr class="row-odd"><td>216-221</td>
<td>If no spectral lines were found, create moments of the whole input cube instead.</td>
</tr>
<tr class="row-even"><td>224-229</td>
<td>Finally, run all the un-run tasks, write the output to disk, and create a summary HTML
file index.html in the output admit directory.</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/env casarun</span>
<span class="c1">#</span>
<span class="c1"># admit-example1 version using new package style</span>
<span class="c1">#</span>
<span class="c1">#   admit-example1.py :  a first example ADMIT pipeline/flow</span>
<span class="c1">#</span>
<span class="c1">#   Usage:      $ADMIT/admit/test/admit-example1.py  [spwcube.fits] [alias] </span>
<span class="c1">#</span>
<span class="c1">#   This will create a spwcube.admit directory with all the</span>
<span class="c1">#   BDP&#39;s and associated data products inside. Linecubes will</span>
<span class="c1">#   have their own directory with their associates products</span>
<span class="c1">#   within that directory.</span>
<span class="c1">#</span>
<span class="c1">#   If you give an admit directory, it will try and re-run in that directory.</span>
<span class="c1"># ==============================================================================</span>

<span class="c1"># python system modules</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">math</span>

<span class="c1"># Always import admit!</span>
<span class="kn">import</span> <span class="nn">admit</span>

<span class="n">version</span>  <span class="o">=</span> <span class="s1">&#39;29-oct-2015&#39;</span>


<span class="c1">#  ===&gt;&gt;&gt; set some parameters for this run &lt;&lt;&lt;===========================================</span>
<span class="c1">#</span>
<span class="nb">file</span>     <span class="o">=</span> <span class="s1">&#39;foobar.fits&#39;</span>    <span class="c1"># the default FITS input name to be ingested</span>
<span class="n">alias</span>    <span class="o">=</span> <span class="s1">&#39;&#39;</span>               <span class="c1"># use a short alias instead of the possibly long basename?</span>
<span class="c1">#</span>
<span class="n">useMask</span>  <span class="o">=</span> <span class="bp">True</span>             <span class="c1"># use a mask where fits data == 0.0</span>
<span class="n">vlsr</span>     <span class="o">=</span> <span class="bp">None</span>             <span class="c1"># either set it below, or make get_vlsr() to work (else vlsr=0 will be used)</span>
<span class="n">maxpos</span>   <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># default to the peak in the cube for CubeSpectrum</span>
<span class="n">clean</span>    <span class="o">=</span> <span class="bp">True</span>             <span class="c1"># clean up the previous admit tree, i.e. no re-running</span>
<span class="n">plotmode</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">PlotControl</span><span class="o">.</span><span class="n">BATCH</span> <span class="c1"># NOPLOT, BATCH, INTERACTIVE, SHOW_AT_END</span>
<span class="n">plottype</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">PlotControl</span><span class="o">.</span><span class="n">PNG</span>   <span class="c1"># output image format. PNG, JPG, etc.</span>
<span class="n">loglevel</span> <span class="o">=</span> <span class="mi">15</span>               <span class="c1"># 10=DEBUG, 15=TIMING 20=INFO 30=WARNING 40=ERROR 50=FATAL</span>
<span class="n">usePeak</span>  <span class="o">=</span> <span class="bp">True</span>             <span class="c1"># LineCubeSpectra through peak of a Moment0 map? (else pos[] or SpwCube Peak)</span>
<span class="n">pvslice</span>  <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># PV Slice (x0,y0,x1,y1)</span>
<span class="n">pvslit</span>   <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># PV Slice (xc,yc,len,pa)  if none given, it will try and find out</span>
<span class="n">usePPP</span>   <span class="o">=</span> <span class="bp">True</span>             <span class="c1"># create and use PeakPointPlot?</span>
<span class="n">useMOM</span>   <span class="o">=</span> <span class="bp">True</span>             <span class="c1"># if no lines are found, do a MOM0,1,2 anyways ?</span>
<span class="n">pvSmooth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>          <span class="c1"># smooth the PVslice ?   Pos or Pos,Vel pixel numbers</span>
<span class="n">robust</span>  <span class="o">=</span> <span class="p">()</span>                <span class="c1"># Robust statistics method, () = default.</span>
<span class="c1">#  ====================================================================</span>


<span class="c1"># placeholder until we have an official way to find the VLSR of a source</span>
<span class="c1"># this is a remnant from how we did this in milestone2.py</span>
<span class="c1"># See the file $ADMIT/etc/vlsr.tab if you want to add sources</span>
<span class="k">def</span> <span class="nf">get_vlsr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">vlsr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">vlsr</span> <span class="o">!=</span> <span class="bp">None</span> <span class="p">:</span> <span class="k">return</span> <span class="n">vlsr</span>
    <span class="n">vq</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">VLSR</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">vq</span><span class="o">.</span><span class="n">vlsr</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">admit_dir</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create the admit directory name from a filename.</span>
<span class="sd">    This filename can be a FITS file (usually with a .fits extension</span>
<span class="sd">    or a directory, which would be assumed to be a CASA image or</span>
<span class="sd">    a MIRIAD image. It can be an absolute or relative address.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.admit&#39;</span>
    <span class="k">if</span> <span class="n">loc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">file</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">file</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span> <span class="o">==</span> <span class="n">ext</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Warning: assuming a re-run on existing &quot;</span><span class="p">,</span><span class="nb">file</span>
            <span class="k">return</span> <span class="nb">file</span>
        <span class="k">return</span> <span class="nb">file</span><span class="p">[:</span><span class="n">loc</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext</span>


<span class="c1"># Parse command line arguments, FITS file name and alias</span>
<span class="n">argv</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">casa_argv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">file</span>  <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">alias</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="nb">file</span>  <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">alias</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="c1">#-----------------------------------------------------------------------------------------</span>
<span class="c1">#----------------------------------- start of script -------------------------------------</span>

<span class="c1">#  announce version</span>
<span class="k">print</span> <span class="s1">&#39;ADMIT1: Version &#39;</span><span class="p">,</span><span class="n">version</span>

<span class="c1">#  do the work in a proper &quot;.admit&quot; directory</span>
<span class="n">adir</span> <span class="o">=</span> <span class="n">admit_dir</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
<span class="c1">#   dirty method, it really should check if adir is an admit directory</span>
<span class="k">if</span> <span class="n">clean</span> <span class="ow">and</span> <span class="n">adir</span> <span class="o">!=</span> <span class="nb">file</span><span class="p">:</span>
    <span class="k">print</span> <span class="s2">&quot;Removing previous results from &quot;</span><span class="p">,</span><span class="n">adir</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">adir</span><span class="p">)</span>
    <span class="n">create</span><span class="o">=</span><span class="bp">True</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">create</span><span class="o">=</span><span class="bp">False</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span><span class="n">adir</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Testing ADMIT1 style pipeline - version </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">version</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="n">create</span><span class="p">,</span><span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>

<span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">new</span><span class="p">:</span>
    <span class="c1"># copy the script into the admit directory</span>
    <span class="k">print</span> <span class="s2">&quot;Starting a new ADMIT using &quot;</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp -a </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">adir</span><span class="p">))</span>                 
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s2">&quot;All done, we just read an existing admit.xml and it should do nothing&quot;</span>
    <span class="n">a</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">diagram</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;admit.dot&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">a</span><span class="o">.</span><span class="n">showsetkey</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>     <span class="c1"># doesn&#39;t work properly in IPython!</span>

<span class="c1"># Default ADMIT plotting environment</span>
<span class="n">a</span><span class="o">.</span><span class="n">plotparams</span><span class="p">(</span><span class="n">plotmode</span><span class="p">,</span><span class="n">plottype</span><span class="p">)</span>

<span class="c1"># Ingest</span>
<span class="n">ingest1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">Ingest_AT</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="nb">file</span><span class="p">,</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">))</span>
<span class="n">a</span><span class="p">[</span><span class="n">ingest1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span><span class="n">useMask</span><span class="p">)</span> 
<span class="n">bandcube1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ingest1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>   


<span class="c1"># CubeStats - will also do log(Noise),log(Peak) plot</span>
<span class="n">cubestats1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeStats_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">])</span>
<span class="n">a</span><span class="p">[</span><span class="n">cubestats1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;robust&#39;</span><span class="p">,</span><span class="n">robust</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="n">cubestats1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;ppp&#39;</span><span class="p">,</span><span class="n">usePPP</span><span class="p">)</span>
<span class="n">csttab1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cubestats1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># CubeSum</span>
<span class="n">moment1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSum_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csttab1</span><span class="p">])</span>
<span class="n">a</span><span class="p">[</span><span class="n">moment1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;numsigma&#39;</span><span class="p">,</span><span class="mf">4.0</span><span class="p">)</span>   <span class="c1"># Nsigma clip in cube</span>
<span class="c1"># &gt;0 force single cuberms sigma from cubestats; &lt;0 would use rms(freq) table</span>
<span class="n">a</span><span class="p">[</span><span class="n">moment1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span><span class="mf">99.0</span><span class="p">)</span>     
<span class="n">csmom0</span> <span class="o">=</span> <span class="p">(</span><span class="n">moment1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># CubeSpectrum </span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">maxpos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">cubespectrum1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSpectrum_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">cubespectrum1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">maxpos</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">cubespectrum1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSpectrum_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csmom0</span><span class="p">])</span>
<span class="n">csptab1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cubespectrum1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>


<span class="c1"># PVSlice</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvslice</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
    <span class="c1"># hardcoded with a start,end</span>
    <span class="n">slice1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">PVSlice_AT</span><span class="p">(</span><span class="nb">slice</span><span class="o">=</span><span class="n">pvslice</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">),[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csmom0</span><span class="p">])</span>
<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvslit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
    <span class="c1"># hardcoded with a center,len,pa</span>
    <span class="n">slice1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">PVSlice_AT</span><span class="p">(</span><span class="n">slit</span><span class="o">=</span><span class="n">pvslit</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">),[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csmom0</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># use cubesum&#39;s map to generate the best slice</span>
    <span class="n">slice1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">PVSlice_AT</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">),[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csmom0</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;clip&#39;</span><span class="p">,</span><span class="mf">0.3</span><span class="p">)</span>        <span class="c1"># TODO: this is an absolute number for mom0</span>
    <span class="n">a</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>       <span class="c1"># SB185 works better with gamma=4</span>
<span class="n">a</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;smooth&#39;</span><span class="p">,</span><span class="n">pvSmooth</span><span class="p">)</span>     <span class="c1"># smooth, in pixel numbers</span>
<span class="n">pvslice1</span> <span class="o">=</span> <span class="p">(</span><span class="n">slice1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="n">corr1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">PVCorr_AT</span><span class="p">(),[</span><span class="n">pvslice1</span><span class="p">,</span><span class="n">csttab1</span><span class="p">])</span>
<span class="n">pvcorr1</span> <span class="o">=</span> <span class="p">(</span><span class="n">corr1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>


<span class="c1">#----------- Workaround because ALMA data don&#39;t include VLSR in header -----------------</span>
<span class="c1"># Need to run now, since LineID_AT needs the vlsr</span>
<span class="n">a</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">summaryData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getValue</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">vlsr</span> <span class="o">=</span> <span class="n">get_vlsr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="n">vlsr</span><span class="p">)</span>
<span class="k">print</span> <span class="s2">&quot;OBJECT = </span><span class="si">%s</span><span class="s2"> VLSR = &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">vlsr</span><span class="p">)</span>
<span class="c1">#---------------------------------------------------------------------------------------</span>

<span class="c1"># LineID uses integer segment=&lt;STRING&gt;:   pick ASAP or ADMIT </span>
<span class="n">lineid1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">LineID_AT</span><span class="p">(</span><span class="n">vlsr</span><span class="o">=</span><span class="n">vlsr</span><span class="p">,</span><span class="n">segment</span><span class="o">=</span><span class="s2">&quot;ADMIT&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">csptab1</span><span class="p">,</span><span class="n">csttab1</span><span class="p">,</span><span class="n">pvcorr1</span><span class="p">])</span> 
<span class="n">lltab1</span> <span class="o">=</span> <span class="p">(</span><span class="n">lineid1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># LineCube</span>
<span class="n">linecube1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">LineCube_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">lltab1</span><span class="p">])</span>
<span class="n">a</span><span class="p">[</span><span class="n">linecube1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;grow&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>          <span class="c1"># +growth</span>

<span class="c1"># RUN_1: now we need to run the flow, since we need to </span>
<span class="c1"># know the number of Lines found and produce the linecubes </span>
<span class="c1"># for the next for-loop.</span>
<span class="n">a</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>


<span class="n">nlines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">linecube1</span><span class="p">])</span>
<span class="k">print</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> lines during runtime&quot;</span> <span class="o">%</span> <span class="n">nlines</span>

<span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">)</span>    <span class="c1"># place holder to contain mol/line</span>
<span class="n">m</span> <span class="o">=</span> <span class="p">{}</span>               <span class="c1"># task id for moment on this mol/line</span>
<span class="n">sp</span><span class="o">=</span> <span class="p">{}</span>               <span class="c1"># task id for cubespectrum on this mol/line</span>
<span class="n">st</span><span class="o">=</span> <span class="p">{}</span>               <span class="c1"># task id for cubestats</span>

<span class="c1"># loop over all lines  </span>
<span class="c1"># produce moments and spectra from the linecubes just created</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
    <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">linecube1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getimagefile</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">bdp_types</span><span class="o">.</span><span class="n">CASA</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;LineDir:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># Moment maps from the LineCube</span>
    <span class="n">linecubei</span> <span class="o">=</span> <span class="p">(</span><span class="n">linecube1</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">Moment_AT</span><span class="p">(),[</span><span class="n">linecubei</span><span class="p">,</span><span class="n">csttab1</span><span class="p">])</span>
    <span class="k">print</span> <span class="s2">&quot;MOMENT_AT:&quot;</span><span class="p">,</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;moments&#39;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;numsigma&#39;</span><span class="p">,[</span><span class="mf">2.0</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;mom0clip&#39;</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span>        <span class="c1"># TODO: this is still an absolute value</span>
    <span class="k">if</span> <span class="n">usePeak</span><span class="p">:</span>
        <span class="n">momenti0</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="mi">0</span><span class="p">)</span>          <span class="c1"># this linecube mom0</span>
        <span class="c1"># CubeSpectrum through the line cube where the mom0 map has peak</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSpectrum_AT</span><span class="p">(),[</span><span class="n">linecubei</span><span class="p">,</span><span class="n">momenti0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">maxpos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># CubeSpectrum through the line cube at given point, </span>
        <span class="c1"># use the same maxpos for all linecubes as we used before</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSpectrum_AT</span><span class="p">(),[</span><span class="n">linecubei</span><span class="p">])</span>
        <span class="n">a</span><span class="p">[</span><span class="n">sp</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">maxpos</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># CubeSpectrum last resort, where it takes the peak from cube maximum</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSpectrum_AT</span><span class="p">(),[</span><span class="n">linecubei</span><span class="p">,</span><span class="n">csttab1</span><span class="p">])</span>

<span class="k">if</span> <span class="n">useMOM</span> <span class="ow">and</span> <span class="n">nlines</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># if no lines found, take a moment (0,1,2) over the whole cube</span>
    <span class="n">moment1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">Moment_AT</span><span class="p">(),[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csttab1</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">moment1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;moments&#39;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">moment1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;numsigma&#39;</span><span class="p">,[</span><span class="mf">2.0</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">moment1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;mom0clip&#39;</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span>       <span class="c1"># Nsigma</span>


<span class="c1"># final run and save</span>
<span class="n">a</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

<span class="c1"># symlink resources, create dot file, and write out index.html</span>
<span class="n">a</span><span class="o">.</span><span class="n">updateHTML</span><span class="p">()</span>

</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="example-2-adding-optional-continuum-map-input-smooth-and-overlapintegral">
<h2>Example 2: Adding optional continuum map input, <a class="reference external" href="module/admit.at/Smooth_AT.html">Smooth</a>, and <a class="reference external" href="module/admit.at/OverlapIntegral_AT.html">OverlapIntegral</a><a class="headerlink" href="#example-2-adding-optional-continuum-map-input-smooth-and-overlapintegral" title="Permalink to this headline">¶</a></h2>
<p>This script is identical to <a class="reference internal" href="#admit-example1">Example1</a> , with the addition of optional
clipping and smoothing of the input FITS file when ingested, finding
sources in a related continuum map using <a class="reference external" href="module/admit.at/SFind2D_AT.html">SFind2D</a>, and creating an OverlapIntegral image
of the first three spectral lines identified.  The notes below highlight the differences
between <a class="reference internal" href="#admit-example1">Example1</a> and <a class="reference internal" href="#admit-example2">Example2</a>.</p>
<div class="section" id="admit-example2-py">
<span id="admit-example2"></span><h3><a class="reference external" href="admit-example2.py">admit_example2.py</a><a class="headerlink" href="#admit-example2-py" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Line #</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>7</td>
<td>The name of the continuum image can be passed in on the command line</td>
</tr>
<tr class="row-odd"><td>40-44</td>
<td>Options to smooth the cube when ingesting (insmooth), or trim the size of the input cube
(inbox or inedge).  See <a class="reference external" href="module/admit.at/Ingest_AT.html">Ingest</a> documentation for details of these keywords. Note this
is an in-place smoothing, the output will be the smoothed cube.</td>
</tr>
<tr class="row-even"><td>45</td>
<td>Optionally, one can smooth the output of <a class="reference external" href="module/admit.at/Ingest_AT.html">Ingest</a>, rather than doing it in place.</td>
</tr>
<tr class="row-odd"><td>129-133</td>
<td>Smooth and trim options passed to <a class="reference external" href="module/admit.at/Ingest_AT.html">Ingest</a>.</td>
</tr>
<tr class="row-even"><td>136-152</td>
<td>Add a task to smooth the output of <a class="reference external" href="module/admit.at/Ingest_AT.html">Ingest</a> with <a class="reference external" href="module/admit.at/Smooth_AT.html">Smooth</a> and use the smoothed output from
here on (bandcube1 = bandcube2).</td>
</tr>
<tr class="row-odd"><td>157-165</td>
<td>If a continuum image was give, set up processing of it with <a class="reference external" href="module/admit.at/Ingest_AT.html">Ingest</a>, <a class="reference external" href="module/admit.at/CubeStats_AT.html">CubeStats</a>, and
<a class="reference external" href="module/admit.at/SFind2D_AT.html">SFind2D</a>.</td>
</tr>
<tr class="row-even"><td>273-281</td>
<td>If more than 3 spectral lines were identified by <a class="reference external" href="module/admit.at/LineID_AT.html">LineID</a>, create an <a class="reference external" href="module/admit.at/OverlapIntegral_AT.html">OverlapIntegral</a>
task and add it to the flow.</td>
</tr>
<tr class="row-odd"><td>284-289</td>
<td>Run the flow, write the output to disk, and create a summary HTML
file index.html in the output admit directory.</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/env casarun</span>
<span class="c1">#</span>
<span class="c1"># admit-example1 version using new package style</span>
<span class="c1">#</span>
<span class="c1">#   admit-example2.py :  a second example ADMIT pipeline/flow</span>
<span class="c1">#</span>
<span class="c1">#   Usage:      $ADMIT/admit/test/admit-example2.py  [spwcube.fits [alias]] [cont.fits]</span>
<span class="c1">#</span>
<span class="c1">#   This will create a spwcube.admit directory with all the</span>
<span class="c1">#   BDP&#39;s and associated data products inside. Linecubes will</span>
<span class="c1">#   have their own directory with their associates products</span>
<span class="c1">#   within that directory.</span>
<span class="c1">#   Optionally you can give a continuum image, cont.fits</span>
<span class="c1">#</span>
<span class="c1">#   If you give an admit directory, it will try and re-run in that directory.</span>

<span class="c1"># ========================================================================================</span>
<span class="c1"># python system modules</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">math</span>

<span class="c1"># Always import admit!</span>
<span class="kn">import</span> <span class="nn">admit</span>

<span class="n">version</span>  <span class="o">=</span> <span class="s1">&#39;29-oct-2015&#39;</span>

<span class="c1">#  ===&gt;&gt;&gt; set some parameters for this run &lt;&lt;&lt;========================================================</span>
<span class="c1">#</span>
<span class="nb">file</span>     <span class="o">=</span> <span class="s1">&#39;foobar.fits&#39;</span>    <span class="c1"># the default FITS input name to be ingested</span>
<span class="n">alias</span>    <span class="o">=</span> <span class="s1">&#39;&#39;</span>               <span class="c1"># use a short alias instead of the possibly long basename?</span>
<span class="n">cont</span>     <span class="o">=</span> <span class="s1">&#39;&#39;</span>               <span class="c1"># add this continuum fits file to the ingestion process?</span>
<span class="c1">#</span>
<span class="n">useMask</span>  <span class="o">=</span> <span class="bp">True</span>             <span class="c1"># use a mask where fits data == 0.0</span>
<span class="n">vlsr</span>     <span class="o">=</span> <span class="bp">None</span>             <span class="c1"># either set it below, or make get_vlsr() to work (else vlsr=0 will be used)</span>
<span class="n">maxpos</span>   <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># default to the peak in the cube for CubeSpectrum</span>
<span class="n">clean</span>    <span class="o">=</span> <span class="bp">True</span>             <span class="c1"># clean up the previous admit tree, i.e. no re-running</span>
<span class="n">plotmode</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">PlotControl</span><span class="o">.</span><span class="n">BATCH</span> <span class="c1"># NOPLOT, BATCH, INTERACTIVE, SHOW_AT_END</span>
<span class="n">plottype</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">PlotControl</span><span class="o">.</span><span class="n">PNG</span>   <span class="c1"># output image format. PNG, JPG, etc.</span>
<span class="n">loglevel</span> <span class="o">=</span> <span class="mi">15</span>               <span class="c1"># 10=DEBUG, 15=TIMING 20=INFO 30=WARNING 40=ERROR 50=FATAL</span>
<span class="n">insmooth</span> <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># smooth inside of Ingest_AT, in pixels</span>
<span class="n">inbox</span>    <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># box to cut in Ingest_AT  [x0,y0,x1,y1] or [x0,y0,z0,x1,y1,z1]</span>
<span class="n">inedge</span>   <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># edges to cut in Ingest_AT [zleft,zright]</span>
                            <span class="c1"># [0] and [1] are spatial</span>
                            <span class="c1"># [2] is frequency:    1=&gt;Hanning  &gt;1 Boxcar</span>
<span class="n">smooth</span>   <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># if set, smooth the cube right after ingest</span>
<span class="n">usePeak</span>  <span class="o">=</span> <span class="bp">True</span>             <span class="c1"># LineCubeSpectra through peak of a Moment0 map? (else pos[] or SpwCube Peak)</span>
<span class="n">pvslice</span>  <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># PV Slice (x0,y0,x1,y1)</span>
<span class="n">pvslit</span>   <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># PV Slice (xc,yc,len,pa)  if none given, it will try and find out</span>
<span class="n">usePPP</span>   <span class="o">=</span> <span class="bp">True</span>             <span class="c1"># create and use PeakPointPlot?</span>
<span class="n">useMOM</span>   <span class="o">=</span> <span class="bp">True</span>             <span class="c1"># if no lines are found, do a MOM0,1,2 anyways ?</span>
<span class="n">pvSmooth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>          <span class="c1"># smooth the PVslice ?   Pos or Pos,Vel pixel numbers</span>
<span class="n">robust</span>  <span class="o">=</span> <span class="p">()</span>                <span class="c1"># Robust statistics method, () = default.</span>
<span class="n">minOI</span>    <span class="o">=</span> <span class="mi">3</span>                <span class="c1"># If at least minOI linecubes present, use them in an OverlapIntegral</span>

<span class="c1"># placeholder until we have an official way to find the VLSR of a source</span>
<span class="c1"># this is a remnant from how we did this in milestone2.py</span>
<span class="c1"># See the file $ADMIT/etc/vlsr.tab if you want to add sources</span>
<span class="k">def</span> <span class="nf">get_vlsr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">vlsr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">vlsr</span> <span class="o">!=</span> <span class="bp">None</span> <span class="p">:</span> <span class="k">return</span> <span class="n">vlsr</span>
    <span class="n">vq</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">VLSR</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">vq</span><span class="o">.</span><span class="n">vlsr</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">admit_dir</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create the admit directory name from a filename.</span>
<span class="sd">    This filename can be a FITS file (usually with a .fits extension</span>
<span class="sd">    or a directory, which would be assumed to be a CASA image or</span>
<span class="sd">    a MIRIAD image. It can be an absolute or relative address.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.admit&#39;</span>
    <span class="k">if</span> <span class="n">loc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">file</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">file</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span> <span class="o">==</span> <span class="n">ext</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Warning: assuming a re-run on existing &quot;</span><span class="p">,</span><span class="nb">file</span>
            <span class="k">return</span> <span class="nb">file</span>
        <span class="k">return</span> <span class="nb">file</span><span class="p">[:</span><span class="n">loc</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext</span>


<span class="c1"># allow a command line argument to be the fits file name, unless you have foobar.fits ;-)</span>
<span class="n">argv</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">casa_argv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">file</span>  <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">alias</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="nb">file</span>  <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">alias</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="nb">file</span>  <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">alias</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">cont</span>  <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="c1">#----------------------------------------------------------------------</span>
<span class="c1">#--------------------------- start of script --------------------------</span>

<span class="c1">#  announce version</span>
<span class="k">print</span> <span class="s1">&#39;ADMIT2: Version &#39;</span><span class="p">,</span><span class="n">version</span>

<span class="c1">#  do the work in a proper &quot;.admit&quot; directory</span>
<span class="n">adir</span> <span class="o">=</span> <span class="n">admit_dir</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
<span class="c1">#   dirty method, it really should check if adir is an admit directory</span>
<span class="k">if</span> <span class="n">clean</span> <span class="ow">and</span> <span class="n">adir</span> <span class="o">!=</span> <span class="nb">file</span><span class="p">:</span>
    <span class="k">print</span> <span class="s2">&quot;Removing previous results from &quot;</span><span class="p">,</span><span class="n">adir</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">adir</span><span class="p">)</span>
    <span class="n">create</span><span class="o">=</span><span class="bp">True</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">create</span><span class="o">=</span><span class="bp">False</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span><span class="n">adir</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Testing ADMIT2 style pipeline - version </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">version</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="n">create</span><span class="p">,</span><span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>

<span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">new</span><span class="p">:</span>
    <span class="c1"># copy the script into the admit directory</span>
    <span class="k">print</span> <span class="s2">&quot;Starting a new ADMIT using &quot;</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp -a </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">adir</span><span class="p">))</span>     
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s2">&quot;All done, we just read an existing admit.xml and it should do nothing&quot;</span>
    <span class="k">print</span> <span class="s2">&quot;Use admit0.py to re-run inside of your admit directory&quot;</span>
    <span class="c1">#</span>
    <span class="n">a</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">diagram</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;admit.dot&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">a</span><span class="o">.</span><span class="n">showsetkey</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>     <span class="c1"># doesn&#39;t work properly in IPython!</span>

<span class="c1"># Default ADMIT plotting environment</span>
<span class="n">a</span><span class="o">.</span><span class="n">plotparams</span><span class="p">(</span><span class="n">plotmode</span><span class="p">,</span><span class="n">plottype</span><span class="p">)</span>

<span class="c1"># Ingest</span>
<span class="n">ingest1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">Ingest_AT</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="nb">file</span><span class="p">,</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">))</span>
<span class="n">a</span><span class="p">[</span><span class="n">ingest1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span><span class="n">useMask</span><span class="p">)</span> 
<span class="n">a</span><span class="p">[</span><span class="n">ingest1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;smooth&#39;</span><span class="p">,</span><span class="n">insmooth</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inbox</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">a</span><span class="p">[</span><span class="n">ingest1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;box&#39;</span><span class="p">,</span><span class="n">inbox</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inedge</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">a</span><span class="p">[</span><span class="n">ingest1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span><span class="n">inedge</span><span class="p">)</span>
<span class="n">bandcube1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ingest1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>   

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">smooth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">smooth1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">Smooth_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">smooth1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;bmaj&#39;</span><span class="p">,{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">smooth</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span><span class="s1">&#39;pixel&#39;</span><span class="p">})</span> 
    <span class="n">a</span><span class="p">[</span><span class="n">smooth1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;bmin&#39;</span><span class="p">,{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">smooth</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span><span class="s1">&#39;pixel&#39;</span><span class="p">})</span>
    <span class="n">a</span><span class="p">[</span><span class="n">smooth1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;bpa&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>                       
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">smooth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span><span class="p">[</span><span class="n">smooth1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;velres&#39;</span><span class="p">,{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">smooth</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span><span class="s1">&#39;pixel&#39;</span><span class="p">})</span>
    
    <span class="n">bandcube2</span> <span class="o">=</span> <span class="p">(</span><span class="n">smooth1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Forget about the original, so we can continue the flow with the smoothed cube</span>
    <span class="c1"># in this model, it would be better to use insmooth= for Ingest_AT, it doesn&#39;t</span>
    <span class="c1"># need the extra space to hold bandcube1</span>
    <span class="c1">#</span>
    <span class="c1"># Another model could be to have two flows in this script, up to LineID,</span>
    <span class="c1"># one with each (or more) smoothing factor and decide which one to continue with</span>
    <span class="c1"># or do LineID with bandcube2, but make linecube&#39;s from bandcube1</span>
    <span class="n">bandcube1</span> <span class="o">=</span> <span class="n">bandcube2</span>


<span class="c1"># If a continuum image was given, set up to ingest it and run</span>
<span class="c1"># source-find on it.</span>
<span class="k">if</span> <span class="n">cont</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
    <span class="n">ingest2</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">Ingest_AT</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">cont</span><span class="p">,</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;-cont&#39;</span><span class="p">))</span>
    <span class="n">contmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">ingest2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cubestats2</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeStats_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">contmap</span><span class="p">])</span>
    <span class="n">csttab2</span> <span class="o">=</span> <span class="p">(</span><span class="n">cubestats2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sfind2</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">SFind2D_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">contmap</span><span class="p">,</span><span class="n">csttab2</span><span class="p">])</span>
    <span class="n">cslist</span> <span class="o">=</span> <span class="p">(</span><span class="n">sfind2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">cslist</span> <span class="o">=</span> <span class="p">()</span>

<span class="c1"># CubeStats - will also do log(Noise),log(Peak) plot</span>
<span class="n">cubestats1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeStats_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">])</span>
<span class="n">a</span><span class="p">[</span><span class="n">cubestats1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;robust&#39;</span><span class="p">,</span><span class="n">robust</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="n">cubestats1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;ppp&#39;</span><span class="p">,</span><span class="n">usePPP</span><span class="p">)</span>
<span class="n">csttab1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cubestats1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># CubeSum</span>
<span class="n">moment1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSum_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csttab1</span><span class="p">])</span>
<span class="n">a</span><span class="p">[</span><span class="n">moment1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;numsigma&#39;</span><span class="p">,</span><span class="mf">4.0</span><span class="p">)</span>   <span class="c1"># Nsigma clip in cube</span>
<span class="c1"># &gt;0 force single cuberms sigma from cubestats; &lt;0 would use rms(freq) table</span>
<span class="n">a</span><span class="p">[</span><span class="n">moment1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span><span class="mf">99.0</span><span class="p">)</span>     
<span class="n">csmom0</span> <span class="o">=</span> <span class="p">(</span><span class="n">moment1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># CubeSpectrum </span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">maxpos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">cubespectrum1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSpectrum_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">cubespectrum1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">maxpos</span><span class="p">)</span>
<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">cubespectrum1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSpectrum_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">cslist</span><span class="p">])</span>    
<span class="k">else</span><span class="p">:</span>
    <span class="n">cubespectrum1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSpectrum_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csmom0</span><span class="p">])</span>
<span class="n">csptab1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cubespectrum1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>


<span class="c1"># PVSlice</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvslice</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
    <span class="c1"># hardcoded with a start,end</span>
    <span class="n">slice1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">PVSlice_AT</span><span class="p">(</span><span class="nb">slice</span><span class="o">=</span><span class="n">pvslice</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">),[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csmom0</span><span class="p">])</span>
<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvslit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
    <span class="c1"># hardcoded with a center,len,pa</span>
    <span class="n">slice1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">PVSlice_AT</span><span class="p">(</span><span class="n">slit</span><span class="o">=</span><span class="n">pvslit</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">),[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csmom0</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># use cubesum&#39;s map to generate the best slice</span>
    <span class="n">slice1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">PVSlice_AT</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">),[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csmom0</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;clip&#39;</span><span class="p">,</span><span class="mf">0.3</span><span class="p">)</span>        <span class="c1"># TODO: this is an absolute number for mom0</span>
    <span class="n">a</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>       <span class="c1"># SB185 works better with gamma=4</span>
<span class="n">a</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;smooth&#39;</span><span class="p">,</span><span class="n">pvSmooth</span><span class="p">)</span>     <span class="c1"># smooth, in pixel numbers</span>
<span class="n">pvslice1</span> <span class="o">=</span> <span class="p">(</span><span class="n">slice1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="n">corr1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">PVCorr_AT</span><span class="p">(),[</span><span class="n">pvslice1</span><span class="p">,</span><span class="n">csttab1</span><span class="p">])</span>
<span class="n">pvcorr1</span> <span class="o">=</span> <span class="p">(</span><span class="n">corr1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>


<span class="c1">#----------- Workaround because ALMA data don&#39;t include VLSR in header -----------------</span>
<span class="c1"># Need to run now, since LineID_AT needs the vlsr</span>
<span class="n">a</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">summaryData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getValue</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">vlsr</span> <span class="o">=</span> <span class="n">get_vlsr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="n">vlsr</span><span class="p">)</span>
<span class="k">print</span> <span class="s2">&quot;OBJECT = </span><span class="si">%s</span><span class="s2"> VLSR = &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">vlsr</span><span class="p">)</span>
<span class="c1">#---------------------------------------------------------------------------------------</span>

<span class="c1"># LineID uses integer segment=&lt;STRING&gt;:   pick ASAP or ADMIT </span>
<span class="n">lineid1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">LineID_AT</span><span class="p">(</span><span class="n">vlsr</span><span class="o">=</span><span class="n">vlsr</span><span class="p">,</span><span class="n">segment</span><span class="o">=</span><span class="s2">&quot;ADMIT&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">csptab1</span><span class="p">,</span><span class="n">csttab1</span><span class="p">,</span><span class="n">pvcorr1</span><span class="p">])</span> 
<span class="n">lltab1</span> <span class="o">=</span> <span class="p">(</span><span class="n">lineid1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># LineCube</span>
<span class="n">linecube1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">LineCube_AT</span><span class="p">(),</span> <span class="p">[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">lltab1</span><span class="p">])</span>
<span class="n">a</span><span class="p">[</span><span class="n">linecube1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;grow&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>          <span class="c1"># +growth</span>

<span class="c1"># RUN_1: now we need to run the flow, since we need to </span>
<span class="c1"># know the number of Lines found and produce the linecubes </span>
<span class="c1"># for the next for-loop.</span>
<span class="n">a</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>


<span class="n">nlines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">linecube1</span><span class="p">])</span>
<span class="k">print</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> lines during runtime&quot;</span> <span class="o">%</span> <span class="n">nlines</span>

<span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">)</span>    <span class="c1"># place holder to contain mol/line</span>
<span class="n">m</span> <span class="o">=</span> <span class="p">{}</span>               <span class="c1"># task id for moment on this mol/line</span>
<span class="n">sp</span><span class="o">=</span> <span class="p">{}</span>               <span class="c1"># task id for cubespectrum on this mol/line</span>
<span class="n">st</span><span class="o">=</span> <span class="p">{}</span>               <span class="c1"># task id for cubestats</span>

<span class="c1"># loop over all lines  </span>
<span class="c1"># produce moments and spectra from the linecubes just created</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
    <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">linecube1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getimagefile</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">bdp_types</span><span class="o">.</span><span class="n">CASA</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;LineDir:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># Moment maps from the LineCube</span>
    <span class="n">linecubei</span> <span class="o">=</span> <span class="p">(</span><span class="n">linecube1</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">Moment_AT</span><span class="p">(),[</span><span class="n">linecubei</span><span class="p">,</span><span class="n">csttab1</span><span class="p">])</span>
    <span class="k">print</span> <span class="s2">&quot;MOMENT_AT:&quot;</span><span class="p">,</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;moments&#39;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;numsigma&#39;</span><span class="p">,[</span><span class="mf">2.0</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;mom0clip&#39;</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span>        <span class="c1"># TODO: this is still an absolute value</span>
    <span class="k">if</span> <span class="n">usePeak</span><span class="p">:</span>
        <span class="n">momenti0</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="mi">0</span><span class="p">)</span>          <span class="c1"># this linecube mom0</span>
        <span class="c1"># CubeSpectrum through the line cube where the mom0 map has peak</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSpectrum_AT</span><span class="p">(),[</span><span class="n">linecubei</span><span class="p">,</span><span class="n">momenti0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">maxpos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># CubeSpectrum through the line cube at given point, </span>
        <span class="c1"># use the same maxpos for all linecubes as we used before</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSpectrum_AT</span><span class="p">(),[</span><span class="n">linecubei</span><span class="p">])</span>
        <span class="n">a</span><span class="p">[</span><span class="n">sp</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">maxpos</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># CubeSpectrum last resort, where it takes the peak from cube maximum</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">CubeSpectrum_AT</span><span class="p">(),[</span><span class="n">linecubei</span><span class="p">,</span><span class="n">csttab1</span><span class="p">])</span>

<span class="k">if</span> <span class="n">useMOM</span> <span class="ow">and</span> <span class="n">nlines</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># if no lines found, take a moment (0,1,2) over the whole cube</span>
    <span class="n">moment1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">Moment_AT</span><span class="p">(),[</span><span class="n">bandcube1</span><span class="p">,</span><span class="n">csttab1</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">moment1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;moments&#39;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">moment1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;numsigma&#39;</span><span class="p">,[</span><span class="mf">2.0</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">moment1</span><span class="p">]</span><span class="o">.</span><span class="n">setkey</span><span class="p">(</span><span class="s1">&#39;mom0clip&#39;</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span>       <span class="c1"># Nsigma</span>

<span class="c1"># OverlapIntegral</span>
<span class="k">if</span> <span class="n">minOI</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nlines</span> <span class="o">&gt;=</span> <span class="n">minOI</span><span class="p">:</span>
    <span class="c1">#  would really like to take the 3 strongest lines</span>
    <span class="k">print</span> <span class="s2">&quot;Testing OverlapIntegral, just take the first 3 lines&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">oi1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">OverlapIntegral_AT</span><span class="p">(),[</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
<span class="k">elif</span> <span class="n">minOI</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">print</span> <span class="s2">&quot;Only found </span><span class="si">%d</span><span class="s2"> lines, need </span><span class="si">%d</span><span class="s2"> for OverlapIntegral&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nlines</span><span class="p">,</span><span class="n">minOI</span><span class="p">)</span>


<span class="c1"># final run and save</span>
<span class="n">a</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

<span class="c1"># symlink resources, create dot file, and write out index.html</span>
<span class="n">a</span><span class="o">.</span><span class="n">updateHTML</span><span class="p">()</span>

</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="example-3-multiflow">
<h2>Example 3: Multiflow<a class="headerlink" href="#example-3-multiflow" title="Permalink to this headline">¶</a></h2>
<p>This is an example of a simple <a class="reference external" href="module/multiflows.html">multiflow</a> that takes the output of several <a class="reference external" href="module/admit.at/Moment_AT.html">Moment</a> tasks
to use as input to <a class="reference external" href="module/admit.at/PrincipalComponent_AT.html">PrincipalComponent</a> analysis.   The initial setup is similar to <a class="reference internal" href="#admit-example1">Example1</a>
and <a class="reference internal" href="#admit-example2">Example2</a>.</p>
<div class="section" id="admit-example3-py">
<span id="admit-example3"></span><h3><a class="reference external" href="admit-example3.py">admit_example3.py</a><a class="headerlink" href="#admit-example3-py" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Line #</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>45</td>
<td>At least two projects must be provided on the command line (or you can&#8217;t do PCA!)</td>
</tr>
<tr class="row-odd"><td>83</td>
<td>In order to create a multiflow, one uses the <a class="reference external" href="module/admit/ProjectManager.html">ProjectManager</a>.</td>
</tr>
<tr class="row-even"><td>85-94</td>
<td>For each input project, find output of <a class="reference external" href="module/admit.at/Moment_AT.html">Moment</a> tasks to use as input to
<a class="reference external" href="module/admit.at/PrincipalComponent_AT.html">PrincipalComponent</a>.</td>
</tr>
<tr class="row-odd"><td>89</td>
<td><a class="reference external" href="module/admit/ProjectManager.html#admit.ProjectManager.ProjectManager.findTask">findTask</a> will locate tasks of a specific type, in this case Moment_AT.</td>
</tr>
<tr class="row-even"><td>92</td>
<td>Add each <a class="reference external" href="module/admit.at/Moment_AT.html">Moment</a> task that is found to the current project, in case the tasks are stale
and need to be re-run.</td>
</tr>
<tr class="row-odd"><td>93</td>
<td>Keep track of the zeroth moment output BDPs of each <a class="reference external" href="module/admit.at/Moment_AT.html">Moment</a> task</td>
</tr>
<tr class="row-even"><td>100</td>
<td>Create the <a class="reference external" href="module/admit.at/PrincipalComponent_AT.html">PrincipalComponent</a> task and add it to the flow.  Its input BDPs are the
zeroth moment outputs of the <a class="reference external" href="module/admit.at/Moment_AT.html">Moment</a> tasks.</td>
</tr>
<tr class="row-odd"><td>102-105</td>
<td>Run the flow, including possible re-run of the <a class="reference external" href="module/admit.at/Moment_AT.html">Moment</a> tasks, write the output to disk,
and create a summary HTML file index.html in the output admit directory.</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/env casarun</span>
<span class="c1">#</span>
<span class="c1">#   admit-example3.py :  process a series of admit projects with PCA</span>
<span class="c1">#</span>
<span class="c1">#   Usage:      admit-example3.py  aproject p1.admit p2.admit p3.admit ....</span>
<span class="c1">#</span>
<span class="c1">#   This will create a new aproject.admit directory and search through p1,p2,p3,....</span>
<span class="c1">#   for moment0 maps to enter into PCA, optional smooth to a common beam.</span>
<span class="c1">#</span>
<span class="c1"># ==================================================================================</span>
<span class="c1"># python system modules</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">admit</span>

<span class="n">version</span>  <span class="o">=</span> <span class="s1">&#39;29-oct-2015&#39;</span>

<span class="c1">#  ===&gt;&gt;&gt; set some parameters for this run &lt;&lt;&lt;=========================================</span>

<span class="n">clean</span>    <span class="o">=</span> <span class="bp">True</span>             <span class="c1"># clean up the previous admit tree, i.e. no re-running</span>
<span class="n">plotmode</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">PlotControl</span><span class="o">.</span><span class="n">BATCH</span> <span class="c1"># NOPLOT, BATCH, INTERACTIVE, SHOW_AT_END</span>
<span class="n">plottype</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">PlotControl</span><span class="o">.</span><span class="n">PNG</span>   <span class="c1"># PNG, JPG, etc.</span>
<span class="n">loglevel</span> <span class="o">=</span> <span class="mi">15</span>               <span class="c1"># 10=DEBUG, 15=TIMING 20=INFO 30=WARNING 40=ERROR 50=FATAL</span>


<span class="k">def</span> <span class="nf">admit_dir</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; create the admit directory name from a filename </span>
<span class="sd">    This filename can be a FITS file (usually with a .fits extension</span>
<span class="sd">    or a directory, which would be assumed to be a CASA image or</span>
<span class="sd">    a MIRIAD image.  It can be an absolute or relative address</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.admit&#39;</span>
    <span class="k">if</span> <span class="n">loc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">file</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">file</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span> <span class="o">==</span> <span class="n">ext</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Warning: assuming a re-run on existing &quot;</span><span class="p">,</span><span class="nb">file</span>
            <span class="k">return</span> <span class="nb">file</span>
        <span class="k">return</span> <span class="nb">file</span><span class="p">[:</span><span class="n">loc</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext</span>


<span class="c1"># Parse command line arguments</span>
<span class="n">argv</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">casa_argv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s2">&quot;Need an admit project name, followed by one or more FITS files&quot;</span>
<span class="nb">file</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1">#--------------- start of script -----------------------------------------------</span>

<span class="c1">#  announce version</span>
<span class="k">print</span> <span class="s1">&#39;ADMIT3: Version &#39;</span><span class="p">,</span><span class="n">version</span>

<span class="c1">#  do the work in a proper &quot;.admit&quot; directory</span>
<span class="n">adir</span> <span class="o">=</span> <span class="n">admit_dir</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
<span class="c1">#   dirty method, it really should check if adir is an admit directory</span>
<span class="k">if</span> <span class="n">clean</span> <span class="ow">and</span> <span class="n">adir</span> <span class="o">!=</span> <span class="nb">file</span><span class="p">:</span>
    <span class="k">print</span> <span class="s2">&quot;Removing previous results from &quot;</span><span class="p">,</span><span class="n">adir</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">adir</span><span class="p">)</span>
    <span class="n">create</span><span class="o">=</span><span class="bp">True</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">create</span><span class="o">=</span><span class="bp">False</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span><span class="n">adir</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Testing ADMIT3 style pipeline - version </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">version</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="n">create</span><span class="p">,</span><span class="n">loglevel</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>

<span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">new</span><span class="p">:</span>
    <span class="k">print</span> <span class="s2">&quot;Starting a new ADMIT using &quot;</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp -a </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">adir</span><span class="p">))</span>
    <span class="n">a</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">admit_dir</span><span class="o">=</span><span class="n">adir</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s2">&quot;All done, we just read an existing admit.xml and it should do nothing&quot;</span>
    <span class="k">print</span> <span class="s2">&quot;Use admit0.py to re-run inside of your admit directory&quot;</span>
    <span class="c1">#</span>
    <span class="n">a</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">diagram</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;admit.dot&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">a</span><span class="o">.</span><span class="n">showsetkey</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">#doesn&#39;t work in IPython!</span>

<span class="c1"># Default ADMIT plotting environment</span>
<span class="n">a</span><span class="o">.</span><span class="n">plotparams</span><span class="p">(</span><span class="n">plotmode</span><span class="p">,</span><span class="n">plottype</span><span class="p">)</span>

<span class="n">pm</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">getManager</span><span class="p">()</span>                            <span class="c1"># get ProjectManager</span>

<span class="n">bdps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ap</span> <span class="ow">in</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>                            <span class="c1"># loop over projects</span>
    <span class="n">_p</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">addProject</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span>
    <span class="c1"># Search for Moment_AT tasks in the projects</span>
    <span class="n">ats</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">findTask</span><span class="p">(</span><span class="n">_p</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">at</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">Moment_AT</span><span class="p">()))</span>
    <span class="k">print</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> Moment_AT&#39;s in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ats</span><span class="p">),</span><span class="n">ap</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">ats</span><span class="p">:</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>                    <span class="c1"># add the AT to the </span>
        <span class="n">bdps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tid</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>                   <span class="c1"># for now, assume &#39;0&#39; was the mom0</span>
        <span class="k">print</span> <span class="s2">&quot;Moment_AT &quot;</span><span class="p">,</span><span class="n">ap</span><span class="p">,</span><span class="n">tid</span><span class="p">,</span><span class="mi">0</span>

<span class="k">print</span> <span class="s2">&quot;ADIR:&quot;</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="k">print</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> BDP&#39;s&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">bdps</span><span class="p">)</span>
<span class="k">print</span> <span class="s2">&quot;BDPs:&quot;</span><span class="p">,</span><span class="n">bdps</span>

<span class="n">pca</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">addtask</span><span class="p">(</span><span class="n">admit</span><span class="o">.</span><span class="n">PrincipalComponent_AT</span><span class="p">(),</span><span class="n">bdps</span><span class="p">)</span>

<span class="c1"># Run the flow, write the outputs, update the web page.</span>
<span class="n">a</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">updateHTML</span><span class="p">()</span>

</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Scripts that show real-world flows</a><ul>
<li><a class="reference internal" href="#example-1-ingest-through-lineid-and-moment">Example 1: Ingest through LineID and Moment</a><ul>
<li><a class="reference internal" href="#admit-example1-py">admit_example1.py</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-2-adding-optional-continuum-map-input-smooth-and-overlapintegral">Example 2: Adding optional continuum map input, Smooth, and OverlapIntegral</a><ul>
<li><a class="reference internal" href="#admit-example2-py">admit_example2.py</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-3-multiflow">Example 3: Multiflow</a><ul>
<li><a class="reference internal" href="#admit-example3-py">admit_example3.py</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="multiflows.html"
                        title="previous chapter">Multiflow Projects</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="installguide.html"
                        title="next chapter">Installation Guide</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/examplescripts.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="installguide.html" title="Installation Guide"
             >next</a> |</li>
        <li class="right" >
          <a href="multiflows.html" title="Multiflow Projects"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ADMIT 1.0.6 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, The ADMIT Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>