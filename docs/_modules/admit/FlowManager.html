<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>admit.FlowManager &#8212; ADMIT 1.0.6 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="ADMIT 1.0.6 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ADMIT 1.0.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for admit.FlowManager</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;.. _FlowManager-api:</span>

<span class="sd">   **Flow** --- Project task flow manager.</span>
<span class="sd">   ---------------------------------------</span>

<span class="sd">   This module defines the FlowManager class.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">admit</span>

<span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="FlowManager"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager">[docs]</a><span class="k">class</span> <span class="nc">FlowManager</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Manages the flow of data products between ADMIT tasks.</span>

<span class="sd">        The flow manager maintains the tree of ADMIT tasks (ATs) constituting</span>
<span class="sd">        a data flow. Tasks communicate through basic data products (BDPs)</span>
<span class="sd">        that flow between tasks, which combine and transform them into new</span>
<span class="sd">        BDPs according to their function. This class implements the bookkeeping</span>
<span class="sd">        to track task connections and inter-dependencies. A central concept</span>
<span class="sd">        is the task connection 4-tuple, ``(si, sp, di, dp)``, connecting a</span>
<span class="sd">        source task (ID ``si``) output BDP (port ``sp``) to a destination</span>
<span class="sd">        task (ID ``di``) input BDP (port ``dp``). The primary concern of the</span>
<span class="sd">        flow manager is to organize and maintain this connection information</span>
<span class="sd">        to permit efficient execution and modification of data flows.</span>

<span class="sd">        The flow manager includes limited functionality supporting</span>
<span class="sd">        self-modifying variadic flows (variflows). In a variflow, at least one</span>
<span class="sd">        AT produces a variable number of outputs, whether from instance to</span>
<span class="sd">        instance or between runs of the same instance. This presents a problem</span>
<span class="sd">        for defining the sub-flow emanating from a variadic AT, as every</span>
<span class="sd">        concrete flow must assume a fixed number of outputs from each AT to</span>
<span class="sd">        define the connection map. To support variflows, the flow manager will</span>
<span class="sd">        automatically clone or prune (disable) sub-flows attached to the</span>
<span class="sd">        variadic output ports of an AT, each time the AT is executed, according</span>
<span class="sd">        to the actual number of BDPs present. When additional parallel</span>
<span class="sd">        sub-flows are needed, the sub-flow(s) attached to the *first* variadic</span>
<span class="sd">        output port is cloned and connected to the new, extra outputs. (If </span>
<span class="sd">        the port already has *any* ATs attached to it, the existing sub-flow(s)</span>
<span class="sd">        are enabled but no cloning is performed.) If fewer sub-flows are</span>
<span class="sd">        needed, the excess tasks are simply disabled (i.e., not removed).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        connmap : triple-nested dictionary of 4-tuples, optional</span>
<span class="sd">            Initial value of the `_connmap` attribute</span>
<span class="sd">            (defaults to an empty dictionary).</span>

<span class="sd">        bdpmap : dictionary of list of 2-tuples, optional</span>
<span class="sd">            Initial value of the `_bdpmap` attribute</span>
<span class="sd">            (defaults to an empty dictionary).</span>

<span class="sd">        depsmap : dictionary of sets, optional</span>
<span class="sd">            Initial value of the `_depsmap` attribute</span>
<span class="sd">            (defaults to an empty dictionary).</span>

<span class="sd">        varimap : double-nested dictionary of list of sets, optional</span>
<span class="sd">            Initial value of the `_varimap` attribute</span>
<span class="sd">            (defaults to an empty dictionary).</span>

<span class="sd">        tasklevs : dictionary of int, optional</span>
<span class="sd">            Initial value of the `_tasklevs` attribute</span>
<span class="sd">            (defaults to an empty dictionary).</span>

<span class="sd">        tasks : dictionary of task references, optional</span>
<span class="sd">            Initial value of the `_tasks` attribute</span>
<span class="sd">            (defaults to an empty dictionary).</span>


<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        _connmap : triple-nested dictionary of 4-tuples</span>
<span class="sd">            Organizes connection 4-tuples in a 3-level dictionary hierarchy;</span>
<span class="sd">            `_connmap[si][di][dp]` is a connection 4-tuple ``(si, sp, di, dp)``</span>
<span class="sd">            connecting source task ID ``si``, BDP output port ``sp``, to</span>
<span class="sd">            destination task ``di``, input ``dp``.</span>

<span class="sd">        _bdpmap : dictionary of list of 2-tuples</span>
<span class="sd">            Relates BDP outputs from source tasks with the BDP inputs to</span>
<span class="sd">            connected destination tasks; `_bdpmap[di]` is a list of 2-tuples</span>
<span class="sd">            ``(si, sp)``, one for each BDP input port, describing the source</span>
<span class="sd">            of the corresponding BDP.</span>

<span class="sd">        _depsmap : dictionary of sets</span>
<span class="sd">            Maintains the task dependency levels needed by the `run()`_ method;</span>
<span class="sd">            `_depsmap[level]` is the set of task IDs residing at the</span>
<span class="sd">            dependency ``level``. Lower level tasks must execute prior to</span>
<span class="sd">            higher level tasks to satisfy dependency requirements; tasks at the</span>
<span class="sd">            same level may be executed in any order (even concurrently).</span>

<span class="sd">        _varimap : double-nested dictionary of list of sets</span>
<span class="sd">            Tracks variadic sub-flows and their controlling (variadic) root</span>
<span class="sd">            task; `_varimap[si][sp]` is a list of sub-flow task IDs, each </span>
<span class="sd">            stored as a set (one per sub-flow), emanating from task ID ``si``,</span>
<span class="sd">            (variadic) output port ``sp``.</span>

<span class="sd">        _tasklevs : dictionary of int</span>
<span class="sd">            Maintains task dependency information in a complementary (inverse)</span>
<span class="sd">            manner to `_depsmap`; `_tasklevels[id]` is the dependency level</span>
<span class="sd">            for task ``id``.</span>

<span class="sd">        _tasks : dictionary of task references</span>
<span class="sd">            Holds references to all ADMIT tasks in the flow, keyed by task id;</span>
<span class="sd">            `_tasks[id]` is an ADMIT task reference.</span>

<span class="sd">        _aliases : 2-tuple of dictionary of task aliases</span>
<span class="sd">            Reserved alias registry, keyed by alias base name (index 0) or AT</span>
<span class="sd">            type (index 1). For index 0, the value is an integer count of</span>
<span class="sd">            aliases created with that base name; for index 1, it is the number</span>
<span class="sd">            of default aliases created for ATs of that type. In both cases, the</span>
<span class="sd">            duplicate aliases are appended with &#39;@N&#39; for some integer N.</span>
<span class="sd">            Not present in XML.</span>

<span class="sd">        _taskid : int</span>
<span class="sd">            Task ID counter, used to ensure unqiue task IDs within the flow.</span>
<span class="sd">            Not present in XML.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        All internal state is kept up to date by `add()`_ and `remove()`_</span>
<span class="sd">        so that it is valid at all times. Hence `_connmap`, `_depsmap`, etc.</span>
<span class="sd">        should never be modified by any other methods, either inside or</span>
<span class="sd">        outside of FlowManager (the leading underscore emphasizes this</span>
<span class="sd">        intent).</span>

<span class="sd">        .. _add():    #admit.FlowManager.FlowManager.add</span>
<span class="sd">        .. _remove(): #admit.FlowManager.FlowManager.remove</span>
<span class="sd">        .. _run():    #admit.FlowManager.FlowManager.run</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bdpmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depsmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">varimap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">tasklevs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># _connmap: nested dictionary of connection tuples (si,sp,di,dp).</span>
        <span class="c1"># _connmap[si][di][dp] is a connection tuple of the form (si,sp,di,dp):</span>
        <span class="c1">#</span>
        <span class="c1">#   si is the source      task ID:          tasks[si];</span>
        <span class="c1">#   sp is the source      task output port:   bdp_out[sp];</span>
        <span class="c1">#   di is the destination task ID:          tasks[di];</span>
        <span class="c1">#   dp is the destination task input  port:   bdp_in[dp];</span>
        <span class="c1">#</span>
        <span class="c1"># The nested structure allows for efficient searching.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">connmap</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">connmap</span>

        <span class="c1"># _bdpmap: Task source to destination BDP port dictionary.</span>
        <span class="c1"># _bdpmap[id] is a list of source connections for each BDP input.</span>
        <span class="c1">#</span>
        <span class="c1"># For example, _bdpmap[3] = [(1,0), (2,3)] means:</span>
        <span class="c1">#  Task #3, BDP input 0 comes from task #1, BDP output 0</span>
        <span class="c1">#  Task #3, BDP input 1 comes from task #2, BDP output 3</span>
        <span class="c1">#</span>
        <span class="c1"># The _bdpmap[id] list is the same as the stuples argument to add()</span>
        <span class="c1"># for task #id. This structure is essentially the inverse of connmap</span>
        <span class="c1"># and is used to efficiently manage connection changes due to</span>
        <span class="c1"># add()/remove().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">bdpmap</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bdpmap</span>

        <span class="c1"># _depsmap: dictionary of task dependency levels.</span>
        <span class="c1"># _depsmap[lev] is a set of task IDs sharing dependency level lev.</span>
        <span class="c1">#</span>
        <span class="c1"># For example: { 0:set([1, 2]), 1:set([3, 4]) }</span>
        <span class="c1"># Level 0 tasks (IDs 1 and 2) execute first (maybe in parallel)</span>
        <span class="c1"># Level 1 tasks (IDs 3 and 4) execute next  (maybe in parallel)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">depsmap</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">depsmap</span>

        <span class="c1"># _varimap: nested dictionary of variadic sub-flows.</span>
        <span class="c1"># _varimap[si][sp] is a list of set of task IDs for each sub-flow.</span>
        <span class="c1">#</span>
        <span class="c1"># For example: { 0:{0:[set([1]), set([2])]}, 1:{2:[set([3, 4])]} }</span>
        <span class="c1"># Task IDs 0 and 1 are variadic.</span>
        <span class="c1"># Task 0 controls two variflows, each with one (managed) task attached</span>
        <span class="c1">#        to (variadic) BDP output port 0.</span>
        <span class="c1"># Task 1 controls one variflow with two tasks, at least attached</span>
        <span class="c1">#        to (variadic) BDP output port 2.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">varimap</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">varimap</span>

        <span class="c1"># _tasklevs: task dependency level dictionary.</span>
        <span class="c1"># _tasklevs[id] is the dependency level for task ID #id.</span>
        <span class="c1">#</span>
        <span class="c1"># This structure is essentially the inverse of _depsmap and is used</span>
        <span class="c1"># to efficiently manage dependency changes due to add()/remove().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasklevs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">tasklevs</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tasklevs</span>

        <span class="c1"># _tasks: task dictionary.</span>
        <span class="c1"># _tasks[id] is a reference to the AT task ID #id.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">tasks</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tasks</span>

        <span class="c1"># _aliases: task alias dictionary.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span> <span class="o">=</span> <span class="p">({},{})</span>

        <span class="c1"># Task ID counter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_taskid</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="k">def</span> <span class="nf">_find_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts logical index to task ID.</span>

<span class="sd">        Indexing by alias name or task ID is supported.</span>
<span class="sd">        This interface converts to a task ID. If the alias is not unique in the</span>
<span class="sd">        flow, an exception is thrown.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int or str</span>
<span class="sd">            Task ID number or alias name.</span>

<span class="sd">        unique : bool, optional</span>
<span class="sd">            Whether precisely one match is allowed (otherwise, the first found</span>
<span class="sd">            is returned).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Task ID number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">StringType</span><span class="p">:</span>
          <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="k">lambda</span> <span class="n">at</span><span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">_alias</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">unique</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> matches for alias &#39;</span><span class="si">%s</span><span class="s2">&#39; in flow&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span> <span class="n">index</span><span class="p">))</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">index</span>


    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of tasks under control of FlowManager.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           int</span>
<span class="sd">               Number of tasks in the flow (including any disabled tasks).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flow tasks membership operator.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           index : int or str</span>
<span class="sd">               Task ID number or alias name.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           bool</span>
<span class="sd">               Membership result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_id</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flow tasks iterator.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           iterator</span>
<span class="sd">               Task iterator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets flow task reference.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           index : int or str</span>
<span class="sd">               Task ID number or alias name.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           AT</span>
<span class="sd">               ADMIT task reference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_id</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span>


    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets new flow task.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           index : int or str</span>
<span class="sd">               Task ID number or alias name.</span>

<span class="sd">           value : AT</span>
<span class="sd">               Task reference.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           None</span>

<span class="sd">           Notes</span>
<span class="sd">           -----</span>
<span class="sd">           This is a low-level method and must not be used directly by external</span>
<span class="sd">           users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_id</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>


    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes flow task.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           index : int or str</span>
<span class="sd">               Task ID number or alias name.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           None</span>

<span class="sd">           Notes</span>
<span class="sd">           -----</span>
<span class="sd">           This is a low-level method and must not be used directly by external</span>
<span class="sd">           users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_id</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="nb">print</span> <span class="n">v</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="FlowManager.run"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Executes the flow, but only tasks that are out of date.</span>

<span class="sd">            Runs all stale, enabled tasks in the correct order, accounting for</span>
<span class="sd">            their inter-dependencies. This will reduce to a no-op for tasks</span>
<span class="sd">            whose outputs are up-to-date (not dependent on stale tasks). The</span>
<span class="sd">            (global) project summary is updated on-the-fly as tasks are</span>
<span class="sd">            executed and must contain a valid Summary object on entry.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            dryrun : bool, optional</span>
<span class="sd">                Whether to perform a dry run (else a live run); defaults to</span>
<span class="sd">                ``False``.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dryrun</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="c1"># Tasks at each level are independent and could be run in parallel.</span>
          <span class="c1"># For now, run them in task ID order for the sake of predictability.</span>
          <span class="n">dl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span>
          <span class="n">dl</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
          <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">si</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">isstale</span><span class="p">()</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">enabled</span><span class="p">():</span>
              <span class="c1"># Set BDP input arguments.</span>
              <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
              <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

              <span class="c1"># Run task.</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">stale</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
              <span class="n">task</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

              <span class="c1"># Update project summary.</span>
              <span class="n">summary</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
              <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">:</span>
                <span class="n">admit</span><span class="o">.</span><span class="n">Project</span><span class="o">.</span><span class="n">summaryData</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">summary</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

              <span class="c1"># Update variadic flows.</span>
              <span class="n">vm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span>
              <span class="k">if</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">vm</span> <span class="ow">and</span> <span class="n">vm</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
                <span class="c1"># Variadic output port range.</span>
                <span class="n">bport</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">_valid_bdp_out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">eport</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">_bdp_out</span><span class="p">)</span>

                <span class="c1"># Delete obsolete, managed sub-flows.</span>
                <span class="c1"># Exception: prototype (port 0) sub-flows are enabled/disabled.</span>
                <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">vm</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
                  <span class="k">if</span> <span class="n">sp</span> <span class="o">&gt;=</span> <span class="n">eport</span> <span class="ow">and</span> <span class="n">sp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">vm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">sp</span><span class="p">]:</span>
                      <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">flow</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">di</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">di</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">vm</span><span class="p">:</span> <span class="k">del</span> <span class="n">vm</span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
                  <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">vm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">sp</span><span class="p">]:</span>
                      <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">flow</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">di</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span><span class="p">(</span><span class="n">sp</span> <span class="o">&lt;</span> <span class="n">eport</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">di</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">:</span>
                          <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">downstream</span><span class="p">(</span><span class="n">di</span><span class="p">):</span>
                            <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span><span class="p">(</span><span class="n">sp</span> <span class="o">&lt;</span> <span class="n">eport</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">vm</span><span class="p">[</span><span class="n">si</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                  <span class="k">if</span> <span class="n">sp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sp</span> <span class="o">&gt;=</span> <span class="n">eport</span><span class="p">:</span> <span class="k">del</span> <span class="n">vm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">sp</span><span class="p">]</span>

                <span class="c1"># Clone new sub-flows onto dangling output ports.</span>
                <span class="c1"># Prototype flows must be attached to *first* variadic output.</span>
                <span class="k">if</span> <span class="n">bport</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
                  <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bport</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">eport</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">sp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
                      <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">bport</span><span class="p">]:</span>
                        <span class="c1"># idmap relates original task IDs to cloned task IDs.</span>
                        <span class="c1"># Process tasks in dependency order to fill this.</span>
                        <span class="n">idmap</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">tasks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
                        <span class="n">tasks</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tid</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasklevs</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span>

                        <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                          <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">di</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                          <span class="c1"># Shift connections attached to variadic outputs</span>
                          <span class="c1"># and translate cloned task IDs.</span>
                          <span class="n">stuples</span> <span class="o">=</span> <span class="p">[]</span>
                          <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">di</span><span class="p">]:</span>
                            <span class="n">sat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="k">if</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">idmap</span><span class="p">:</span> <span class="n">tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">idmap</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">_bdp_out_zero</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sat</span><span class="o">.</span><span class="n">_variflow</span> \
                               <span class="ow">and</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">_valid_bdp_out</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                              <span class="n">tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">sp</span><span class="o">-</span><span class="n">bport</span><span class="p">)</span>
                            <span class="n">stuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span>

                          <span class="n">idmap</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">stuples</span><span class="p">)</span>

                          <span class="c1"># For variadic clones, replicate their variflows.</span>
                          <span class="k">if</span> <span class="n">di</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">:</span>
                            <span class="n">vid</span> <span class="o">=</span> <span class="n">idmap</span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">di</span><span class="p">]:</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">vid</span><span class="p">][</span><span class="n">dp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                              <span class="k">for</span> <span class="n">vflow</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">vid</span><span class="p">][</span><span class="n">dp</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                                <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">vflow</span><span class="p">:</span>
                                  <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                  <span class="n">stuples</span> <span class="o">=</span> <span class="p">[]</span>
                                  <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">tid</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">idmap</span><span class="p">:</span>
                                      <span class="n">tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">idmap</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                    <span class="n">stuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span>
                                  <span class="n">idmap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">stuples</span><span class="p">)</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">vid</span><span class="p">][</span><span class="n">dp</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idmap</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span></div>


<div class="viewcode-block" id="FlowManager.connectInputs"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.connectInputs">[docs]</a>    <span class="k">def</span> <span class="nf">connectInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connects input BDPs to all tasks in the flow.</span>

<span class="sd">        Connections are made regardless of whether tasks are out of date or</span>
<span class="sd">        disabled. Missing inputs are ignored. This method also updates the</span>
<span class="sd">        stale flag on each task.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
            <span class="c1"># Set BDP input arguments (if available).</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
            <span class="n">task</span><span class="o">.</span><span class="n">clearinput</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>
              <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
              <span class="k">if</span> <span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span> <span class="n">src</span><span class="p">[</span><span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">addinput</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

            <span class="c1"># Update stale flag for child tasks.</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">isstale</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">stale</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="FlowManager.dryrun"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.dryrun">[docs]</a>    <span class="k">def</span> <span class="nf">dryrun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs a dry run.</span>

<span class="sd">           Dry runs provide a summary of which tasks are in the flow,</span>
<span class="sd">           which are stale (out-of-date), and the order in which they will be</span>
<span class="sd">           executed in a live run.</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">:</span>
            <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="nb">print</span> <span class="s1">&#39;AT&#39;</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="s2">&quot;(id </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">_type</span>
            <span class="k">for</span> <span class="nb">bin</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">_bdp_in</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;BDP input:&quot;</span><span class="p">,</span> <span class="nb">bin</span><span class="o">.</span><span class="n">_type</span>
            <span class="k">for</span> <span class="n">bout</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">_bdp_out</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;BDP output:&quot;</span><span class="p">,</span> <span class="n">bout</span><span class="o">.</span><span class="n">_type</span>
            <span class="nb">print</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="FlowManager.inFlow"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.inFlow">[docs]</a>    <span class="k">def</span> <span class="nf">inFlow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">stuples</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines whether a compatible task exists in the flow.</span>

<span class="sd">        A task is compatible with another if:</span>
<span class="sd">        1. It has the identical concrete type.</span>
<span class="sd">        2. It has the same task ID.</span>
<span class="sd">        3. It has identical source connections (if supplied).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a : ADMIT task</span>
<span class="sd">            Task reference.</span>

<span class="sd">        stuples : list of 2-tuples, optional</span>
<span class="sd">            List of source connection 2-tuples, one per BDP input port</span>
<span class="sd">            (default `None` bypasses the connection check).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        True if a compatible task exists in the flow, else False.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">:</span>
          <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">()]):</span>
            <span class="k">if</span> <span class="n">stuples</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">stuples</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">()]:</span>
              <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="FlowManager.add"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">stuples</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtuples</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends or inserts an AT into the task flow.</span>

<span class="sd">           Appending a task creates a new leaf---a task whose BDP outputs (if</span>
<span class="sd">           any) are not connected to any tasks; in this case, `dtuples` can</span>
<span class="sd">           be omitted. Insertion implies that one or more of the tasks&#39;s</span>
<span class="sd">           outputs feeds back into the flow, in which case `dtuples` will be</span>
<span class="sd">           non-empty.</span>

<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           a : AT</span>
<span class="sd">               ADMIT task to append/insert into the flow.</span>

<span class="sd">           stuples : list of 2-tuples, optional</span>
<span class="sd">               List of source connection 2-tuples, one per BDP input port.  For</span>
<span class="sd">               example, ``[(si0,sp0), (si1,sp1)]`` if the task requires two BDP</span>
<span class="sd">               inputs, the first (input port 0) from task ``si0``, BDP output</span>
<span class="sd">               ``sp0`` and the second (input port 1) from task ``si1``, BDP</span>
<span class="sd">               output ``sp1``. Defaults to `None` (no upstream tasks).</span>

<span class="sd">           dtuples : list of 4-tuples, optional</span>
<span class="sd">               List of destination connection 4-tuples ``(si, sp, di, dp)``.</span>
<span class="sd">               The number of connections varies but will be zero for leaf</span>
<span class="sd">               (i.e., appended) tasks. The source task ID in these tuples must</span>
<span class="sd">               match the input task ID ``a.id``, as it is the source for all</span>
<span class="sd">               `dtuples` connections. For example, [(1, 0, 2, 1), (1, 0, 3, 2)]</span>
<span class="sd">               if this task (id #1) disseminates its BDP output (port 0) to</span>
<span class="sd">               two downstream task inputs (#2 port 1 and #3 port 2). Defaults</span>
<span class="sd">               to `None` (no downstream tasks).</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           int</span>
<span class="sd">               Input task ID on success, else -1 (error detected).</span>

<span class="sd">           See Also</span>
<span class="sd">           --------</span>
<span class="sd">           remove</span>
<span class="sd">           replace</span>

<span class="sd">           Notes</span>
<span class="sd">           -----</span>
<span class="sd">           Usually all but the root task(s) will have a non-empty `stuples`</span>
<span class="sd">           list.</span>

<span class="sd">           As a convenience, in the ``stuples`` and ``dtuples`` arguments the</span>
<span class="sd">           task alias may be used in place of the integer task ID. Also, for </span>
<span class="sd">           the ``stuples`` argument (only), a destination port of zero may be</span>
<span class="sd">           omitted (implied); i.e., ``(si, 0)`` may be replaced with ``si`` (or</span>
<span class="sd">           the alias name).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errstr</span> <span class="o">=</span> <span class="s2">&quot;ERROR: FlowManager.add():&quot;</span>

        <span class="c1"># Converts alias names to task id in a list of tuples.</span>
        <span class="c1"># The implementation preserves project IDs within literal task IDs.</span>
        <span class="k">def</span> <span class="nf">norm_tuples</span><span class="p">(</span><span class="n">tuples</span><span class="p">):</span>
          <span class="n">rtn</span> <span class="o">=</span> <span class="p">[]</span>
          <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tuples</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">TupleType</span><span class="p">:</span>
              <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">StringType</span> <span class="k">else</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
              <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">rtn</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t0</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
              <span class="k">else</span><span class="p">:</span>          
                <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">StringType</span> <span class="k">else</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">rtn</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t0</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">StringType</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
              <span class="n">rtn</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

          <span class="k">return</span> <span class="n">rtn</span>

        <span class="c1"># Assign flow-unique task ID and alias.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">getProject</span><span class="p">():</span>
          <span class="n">a</span><span class="o">.</span><span class="n">setAlias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">)</span>
          <span class="n">a</span><span class="o">.</span><span class="n">newId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_taskid</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_taskid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Convenience values.</span>
        <span class="n">bm</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span>
        <span class="n">tl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasklevs</span>

        <span class="c1"># Loop over stuples (the sources of BDP inputs to this task).</span>
        <span class="n">di</span><span class="p">,</span> <span class="n">dp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">_taskid</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">lv</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bm</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">siset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">([]</span> <span class="k">if</span> <span class="n">stuples</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">norm_tuples</span><span class="p">(</span><span class="n">stuples</span><span class="p">)):</span>
            <span class="n">si</span><span class="p">,</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">siset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>

            <span class="c1"># Check source task is valid.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">si</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
              <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;no source task </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">si</span>
              <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c1"># This sequence reliably populates the triple-nested dictionary.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cm</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">si</span><span class="p">):</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">di</span><span class="p">):</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
            <span class="n">dp</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Save source ports for dependency management.</span>
            <span class="n">bm</span><span class="p">[</span><span class="n">di</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="c1"># Track task dependency level.</span>
            <span class="k">if</span> <span class="n">lv</span> <span class="o">&lt;=</span> <span class="n">tl</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span> <span class="n">lv</span> <span class="o">=</span> <span class="n">tl</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Add AT to task list.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">_taskid</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>

        <span class="c1"># Set dependency level.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dm</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">lv</span><span class="p">):</span> <span class="n">dm</span><span class="p">[</span><span class="n">lv</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">dm</span><span class="p">[</span><span class="n">lv</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">di</span><span class="p">)</span>
        <span class="n">tl</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="n">lv</span>

        <span class="c1"># New variflow root?</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">_bdp_out_zero</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">_variflow</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">dtuples</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot insert (only append) variadic AT.&quot;</span>
            <span class="n">admit</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Variadic subflow containing the new task (if any).</span>
        <span class="c1"># vi = (controlling task ID, task output port, subflow)</span>
        <span class="n">vi</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">set</span><span class="p">([</span><span class="n">di</span><span class="p">]))</span>

        <span class="c1"># Attach subflow if task is directly connected to a variadic AT port.</span>
        <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">siset</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
          <span class="k">if</span> <span class="n">vi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tl</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tl</span><span class="p">[</span><span class="n">vi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
            <span class="n">vat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">si</span><span class="p">]</span>
            <span class="n">vp</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vat</span><span class="o">.</span><span class="n">_valid_bdp_out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="c1"># Determine associated (highest-numbered) source port.</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
              <span class="n">sport</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
              <span class="k">if</span> <span class="n">sport</span> <span class="o">&gt;</span> <span class="n">sp</span><span class="p">:</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">sport</span>

            <span class="k">if</span> <span class="n">sp</span> <span class="o">&gt;=</span> <span class="n">vp</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">vi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">si</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">sp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

              <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">sp</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
              <span class="n">vi</span> <span class="o">=</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">sp</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Merge variflows connected through the new task.</span>
        <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">:</span>
          <span class="c1"># vp is the first (base) variadic port number</span>
          <span class="n">vp</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">si</span><span class="p">]</span><span class="o">.</span><span class="n">_valid_bdp_out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

          <span class="c1"># sport is the highest numbered port directly attached to task di</span>
          <span class="n">sport</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
          <span class="k">if</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">cm</span> <span class="ow">and</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">]:</span>
              <span class="k">if</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sport</span><span class="p">:</span>
                <span class="n">sport</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

          <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">sp</span><span class="p">]:</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">siset</span> <span class="o">&amp;</span> <span class="n">flow</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">vi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">vi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sp</span><span class="p">)</span> \
                                <span class="ow">and</span> <span class="p">(</span><span class="n">vi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">sport</span> <span class="o">&gt;=</span> <span class="n">vp</span><span class="p">)</span> \
                                <span class="ow">and</span> <span class="n">flow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">vi</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">vi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tl</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tl</span><span class="p">[</span><span class="n">vi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                  <span class="c1"># Previous flow merges into current one.</span>
                  <span class="n">flow</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">vi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                  <span class="n">vi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                  <span class="n">vi</span> <span class="o">=</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                  <span class="c1"># Current flow merges into previous one.</span>
                  <span class="n">vi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
                  <span class="n">flow</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># Remove any merged (cleared) flow slots.</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">sp</span><span class="p">]:</span>
              <span class="k">if</span> <span class="ow">not</span> <span class="n">flow</span><span class="p">:</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">sp</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
              <span class="k">else</span><span class="p">:</span>        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Check for recursion.</span>
        <span class="n">dtuples</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">dtuples</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">norm_tuples</span><span class="p">(</span><span class="n">dtuples</span><span class="p">)</span>
        <span class="n">leaf</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dtuples</span><span class="p">:</span> <span class="n">leaf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">downstream</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">leaf</span><span class="p">):</span>
          <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="s2">&quot;introduces recursion.&quot;</span>
          <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Loop over dtuples (the destinations of BDP outputs from this task).</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dtuples</span><span class="p">:</span>
            <span class="n">si</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">dp</span> <span class="o">=</span> <span class="n">t</span>

            <span class="c1"># Check destination task is valid.</span>
            <span class="k">if</span> <span class="n">di</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
              <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;no destination task </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">di</span>
              <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c1"># Remove existing connection.</span>
            <span class="n">t0</span>  <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">]</span>
            <span class="n">si0</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cm</span><span class="p">[</span><span class="n">si0</span><span class="p">][</span><span class="n">di</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">si0</span><span class="p">][</span><span class="n">di</span><span class="p">]):</span> <span class="n">cm</span><span class="p">[</span><span class="n">si0</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">di</span><span class="p">)</span>

            <span class="c1"># Add new connection.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cm</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">si</span><span class="p">):</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">di</span><span class="p">):</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">bm</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>

            <span class="c1"># Update dependency level if necessary.</span>
            <span class="k">if</span> <span class="n">tl</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lv</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">downstream</span><span class="p">(</span><span class="n">di</span><span class="p">):</span>
                    <span class="c1"># Remove old level.</span>
                    <span class="n">l0</span> <span class="o">=</span> <span class="n">tl</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
                    <span class="n">dm</span><span class="p">[</span><span class="n">l0</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="n">l0</span><span class="p">]):</span> <span class="n">dm</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">l0</span><span class="p">)</span>

                    <span class="c1"># Increment dependency level.</span>
                    <span class="n">l1</span> <span class="o">=</span> <span class="n">l0</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">tl</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">l1</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dm</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">l1</span><span class="p">):</span> <span class="n">dm</span><span class="p">[</span><span class="n">l1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">dm</span><span class="p">[</span><span class="n">l1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">_taskid</span></div>


<div class="viewcode-block" id="FlowManager.remove"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">keepRoot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">delFiles</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Removes an AT and its downstream tasks.</span>

<span class="sd">            Deletes an entire sub-flow starting from the specified root task.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            id : int</span>
<span class="sd">                Task ID of root AT to be removed.</span>

<span class="sd">            keepRoot : bool, optional</span>
<span class="sd">                Whether to preserve the root AT, `id`, and remove only its</span>
<span class="sd">                descendents.</span>

<span class="sd">            delFiles : bool, optional</span>
<span class="sd">                Whether to delete BDP data when removing tasks.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>

<span class="sd">            See Also</span>
<span class="sd">            --------</span>
<span class="sd">            add</span>
<span class="sd">            replace</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            This method does *not* remove any variflow-related metadata as this</span>
<span class="sd">            would disrupt the flow management performed by veriflows</span>
<span class="sd">            themselves. User removal of tasks within variadic flows is only</span>
<span class="sd">            supported via editing and re-running of script files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convenience values.</span>
        <span class="n">bm</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span>
        <span class="n">tl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasklevs</span>

        <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">downstream</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">keepRoot</span> <span class="ow">and</span> <span class="n">si</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span> <span class="k">continue</span>

            <span class="c1"># Remove task as BDP connection source.</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Remove task as BDP connection destination.</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">bm</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
                <span class="n">si0</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">si0</span><span class="p">):</span>
                    <span class="n">cm</span><span class="p">[</span><span class="n">si0</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">si0</span><span class="p">]):</span> <span class="n">cm</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">si0</span><span class="p">)</span>

            <span class="c1"># Remove output BDPs.</span>
            <span class="k">for</span> <span class="n">bdp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">bdp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">bdp</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delFiles</span><span class="p">)</span>

            <span class="c1"># Remove any summary information.</span>
            <span class="n">admit</span><span class="o">.</span><span class="n">Project</span><span class="o">.</span><span class="n">summaryData</span><span class="o">.</span><span class="n">delItemsByTaskID</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>

            <span class="c1"># Remove task and its flow metadata.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
            <span class="n">dm</span><span class="p">[</span><span class="n">tl</span><span class="p">[</span><span class="n">si</span><span class="p">]]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dm</span><span class="p">[</span><span class="n">tl</span><span class="p">[</span><span class="n">si</span><span class="p">]]:</span> <span class="n">dm</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tl</span><span class="p">[</span><span class="n">si</span><span class="p">])</span>
            <span class="n">tl</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
            <span class="n">bm</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">si</span><span class="p">)</span></div>


<div class="viewcode-block" id="FlowManager.replace"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">stuples</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Replaces one task with another, removing the original.</span>

<span class="sd">            The replacement task must have the same output signature (i.e,</span>
<span class="sd">            produce the same types/number of output BDPs)---otherwise the</span>
<span class="sd">            existing task could not be removed---but `stuples` may be specified</span>
<span class="sd">            if the inputs differ.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            id : int</span>
<span class="sd">                Task ID of AT to be removed.</span>

<span class="sd">            a : AT</span>
<span class="sd">                Task to insert into the flow.</span>

<span class="sd">            stuples : list of 2-tuples, optional</span>
<span class="sd">                Source connection 2-tuples ``(si, sp)`` for `a`. The special</span>
<span class="sd">                default value None indicates that the existing task&#39;s sources</span>
<span class="sd">                should be reused verbatim.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>

<span class="sd">            See Also</span>
<span class="sd">            --------</span>
<span class="sd">            add</span>
<span class="sd">            remove</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Matching input signature by default.</span>
        <span class="k">if</span> <span class="n">stuples</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">stuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>

        <span class="c1"># Form new destination connections list.</span>
        <span class="n">dtuples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="n">di</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
              <span class="n">dtuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">_taskid</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">)</span>

        <span class="c1"># Add the new task, then remove the old one.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">stuples</span><span class="p">,</span> <span class="n">dtuples</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span></div>


<div class="viewcode-block" id="FlowManager.clone"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">flow</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">idmap</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clones the flow emanating from a given root task (included).</span>

<span class="sd">            Creates an independent, parallel sub-flow duplicating the</span>
<span class="sd">            action of the original. If `flow` is `None`, the sub-flow emanating</span>
<span class="sd">            from task `id` (inclusive) is duplicated. Otherwise, the sub-flow </span>
<span class="sd">            defined by `flow = (fm, tid)`, where `fm` is a FlowManager instance</span>
<span class="sd">            and task `tid` (contained in `fm`) is the root of the sub-flow, is</span>
<span class="sd">            duplicated and spliced into the current flow, using task `id` as</span>
<span class="sd">            its root instead---i.e., task `tid` is identified with `id` and the</span>
<span class="sd">            tasks *following* `tid` are cloned and appended to `id`. In the</span>
<span class="sd">            latter case, task `id` is *not* duplicated; the new sub-flow is</span>
<span class="sd">            merely appended to it. </span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            id : int</span>
<span class="sd">                Task ID of the existing sub-flow root task.</span>

<span class="sd">            flow : 2-tuple, optional</span>
<span class="sd">                Tuple (fm, tid) describing an external sub-flow; `fm` is a </span>
<span class="sd">                FlowManager object and `tid` the ID of a task within it.</span>

<span class="sd">            idmap : dict of int key-values, optional</span>
<span class="sd">                Dictionary mapping root task IDs in `flow` to corresponding</span>
<span class="sd">                tasks in `self`.</span>
<span class="sd">                </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            int</span>
<span class="sd">                Task ID of the new (possibly cloned) root task.</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            If an external `flow` is provided that is not autonomous (i.e.,</span>
<span class="sd">            one or more of its ATs receives inputs from ATs outside the</span>
<span class="sd">            sub-flow), the `idmap` argument is required and must map task IDs</span>
<span class="sd">            from `flow` to `self` for all ATs outside the sub-flow. This</span>
<span class="sd">            informs the method how to identify parent tasks between flows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copy external flow/id?</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span> <span class="k">if</span> <span class="n">flow</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">flow</span>

        <span class="c1"># Convenience values.</span>
        <span class="n">bm</span><span class="p">,</span> <span class="n">cm</span> <span class="o">=</span> <span class="n">fid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">,</span> <span class="n">fid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_connmap</span>

        <span class="c1"># Follow flow, cloning and adding tasks.</span>
        <span class="c1"># The idmap translates original to cloned task IDs;</span>
        <span class="c1">#   root holds the task IDs of the current-level sub-flow root(s)</span>
        <span class="c1">#   dups holds the task IDs of already duplicated sub-flow ATs</span>
        <span class="k">if</span> <span class="n">idmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">idmap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">root</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">fid</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">dups</span><span class="o">=</span><span class="nb">set</span><span class="p">([])</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
          <span class="c1"># Leaf tasks are those immediately dependent on current root(s).</span>
          <span class="n">leaf</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

          <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">dups</span><span class="p">:</span> <span class="k">continue</span>

            <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">si</span><span class="p">):</span> <span class="n">leaf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># Create cloned source BDP map.</span>
            <span class="c1"># Only source IDs present in idmap require updating.</span>
            <span class="n">stuples</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">bm</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
              <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">idmap</span><span class="p">:</span>
                <span class="c1"># Cloned BDP input connection.</span>
                <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">idmap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="c1"># BDP input lies outside of the (external) sub-flow.</span>
                <span class="k">if</span> <span class="n">fid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">si</span> <span class="o">!=</span> <span class="n">fid</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                  <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span> <span class="s2">&quot;clone: input sub-flow is not autonomous&quot;</span>

              <span class="n">stuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">flow</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">si</span> <span class="o">!=</span> <span class="n">fid</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
              <span class="c1"># Duplicate task and add to current flow.</span>
              <span class="n">task</span> <span class="o">=</span> <span class="n">fid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">si</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
              <span class="n">task</span><span class="o">.</span><span class="n">baseDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">baseDir</span><span class="p">())</span>
              <span class="n">idmap</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">stuples</span><span class="p">)</span>
              <span class="n">dups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="c1"># Root task not duplicated between flows.</span>
              <span class="n">idmap</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>

          <span class="n">root</span> <span class="o">=</span> <span class="n">leaf</span>

        <span class="k">return</span> <span class="n">idmap</span><span class="p">[</span><span class="n">fid</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></div>


<div class="viewcode-block" id="FlowManager.find"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isMatch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds ATs in the flow matching a criterion.</span>

<span class="sd">        Applies the function `isMatch` to all ATs in the flow, in proper</span>
<span class="sd">        dependency order, accumulating matching ATs in a list (the return</span>
<span class="sd">        value). Downstream ATs are guaranteed to follow their predecessors in</span>
<span class="sd">        this list. Often `isMatch` may be conveniently expressed as a lambda</span>
<span class="sd">        function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        isMatch : bool functor(AT)</span>
<span class="sd">            Function object taking one AT as input and returning a Boolean.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of ATs</span>
<span class="sd">            ATs testing True using `isMatch`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Tasks at the same dependency level are scanned in an unspecified order.</span>
<span class="sd">        (Such tasks are all independent of each other.)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        To find all ATs with ID less than 100 in flow `fm`:</span>

<span class="sd">        &gt;&gt;&gt; fm.find(lambda at: at.id() &lt; 100)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span><span class="p">[</span><span class="n">level</span><span class="p">]:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">isMatch</span><span class="p">(</span><span class="n">task</span><span class="p">):</span> <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">matches</span></div>


<div class="viewcode-block" id="FlowManager.downstream"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.downstream">[docs]</a>    <span class="k">def</span> <span class="nf">downstream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">leaf</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determines the ATs downstream of a task (includes itself).</span>

<span class="sd">            The downstream tasks constitute the sub-flow emanating from the</span>
<span class="sd">            specified root task (also considered part of the sub-flow).</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            id : int</span>
<span class="sd">                Root task ID.</span>

<span class="sd">            leaf : set of int, optional</span>
<span class="sd">                Initial set of leaf task IDs.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            set</span>
<span class="sd">                Set of AT task IDs (including the root, `id`) on success,</span>
<span class="sd">                else an empty list if recursion is detected.</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            Recursion through task `id` is detected. This is used by **add()**</span>
<span class="sd">            to prevent the creation of cyclic flows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span>

        <span class="c1"># Collect the set of downstream tasks, one level at a time.</span>
        <span class="k">if</span> <span class="n">leaf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">leaf</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">root</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">id</span><span class="p">])</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">si</span><span class="p">):</span> <span class="n">leaf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">leaf</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># Recursion through id.</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">leaf</span>
            <span class="n">leaf</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">flow</span></div>


<div class="viewcode-block" id="FlowManager.show"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Displays formatted internal FlowManager state.</span>

<span class="sd">           Pretty-prints the current contents of the instance to the screen</span>
<span class="sd">           (standard output).</span>

<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">======== Begin FlowManager State ========&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---- Connection map ----&quot;</span>
        <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
                <span class="nb">print</span> <span class="s2">&quot;Task </span><span class="si">%d</span><span class="s2"> =&gt; </span><span class="si">%d</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">di</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">]</span>

        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---- BDP map ----&quot;</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Task </span><span class="si">%d</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>

        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---- Dependency map ----&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Level </span><span class="si">%d</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---- Variflow map ----&quot;</span>
        <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
            <span class="nb">print</span> <span class="s2">&quot;Task </span><span class="si">%d</span><span class="s2"> port </span><span class="si">%d</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">sp</span><span class="p">]</span>

        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---- Tasks (level) ----&quot;</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="s2">&quot;[stale&quot;</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">isstale</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">enabled</span><span class="p">():</span>
              <span class="n">attr</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span> <span class="k">else</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;disabled&quot;</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">:</span>
              <span class="n">attr</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span> <span class="k">else</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;variadic&quot;</span>
            <span class="k">if</span> <span class="n">attr</span><span class="p">:</span> <span class="n">attr</span> <span class="o">+=</span> <span class="s2">&quot;]&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;Task </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">):&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasklevs</span><span class="p">[</span><span class="n">tid</span><span class="p">]),</span> \
                  <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="s2">&quot;- &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="n">attr</span>
            <span class="nb">print</span> <span class="s2">&quot;  BDP  in:    map =&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">_bdp_in_map</span>
            <span class="k">for</span> <span class="n">bdp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">_bdp_in</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bdp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;    [Name: </span><span class="si">%s</span><span class="s2"> Type: </span><span class="si">%s</span><span class="s2"> Uid: </span><span class="si">%d</span><span class="s2"> Tid: </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bdp</span><span class="o">.</span><span class="n">show</span><span class="p">(),</span> <span class="n">bdp</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">bdp</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="n">bdp</span><span class="o">.</span><span class="n">_taskid</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;  BDP out:    map =&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">_bdp_out_map</span>
            <span class="k">for</span> <span class="n">bdp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">_bdp_out</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bdp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;    [Name: </span><span class="si">%s</span><span class="s2"> Type: </span><span class="si">%s</span><span class="s2"> Uid: </span><span class="si">%d</span><span class="s2"> Tid: </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bdp</span><span class="o">.</span><span class="n">show</span><span class="p">(),</span> <span class="n">bdp</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">bdp</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="n">bdp</span><span class="o">.</span><span class="n">_taskid</span><span class="p">)</span>
            <span class="nb">print</span>

        <span class="nb">print</span> <span class="s2">&quot;======== End FlowManager State ========&quot;</span></div>


<div class="viewcode-block" id="FlowManager.showsetkey"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.showsetkey">[docs]</a>    <span class="k">def</span> <span class="nf">showsetkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Display keysettings for all tasks, meant to be used to</span>
<span class="sd">            write a template file for rerunning an admit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">outfile</span> <span class="ow">and</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Default keywords in this flow:</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">stale</span> <span class="o">=</span><span class="s2">&quot;[stale]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">isstale</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> 
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;### Task </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">): </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tid</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_tasklevs</span><span class="p">[</span><span class="n">tid</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span><span class="n">stale</span><span class="p">))</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#   BDP name info could be displayed here too....</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">.</span><span class="n">_keys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;&#39;&#39;&quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;# a[</span><span class="si">%d</span><span class="s2">].setkey(&#39;</span><span class="si">%s</span><span class="s2">&#39;,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tid</span><span class="p">,</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="FlowManager.verify"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.verify">[docs]</a>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Verifies the internal state of the FlowManager.</span>

<span class="sd">            Verification searches for internal inconsistencies in the flow</span>
<span class="sd">            bookkeeping, which to improve runtime efficiency is partially</span>
<span class="sd">            redundant.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            bool</span>
<span class="sd">                ``True`` if the FlowManager state is valid, else ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">errstr</span> <span class="o">=</span> <span class="s2">&quot;ERROR: FlowManager.verify():&quot;</span>

        <span class="c1"># Convenience values.</span>
        <span class="n">bm</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span>
        <span class="n">tl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasklevs</span>

        <span class="c1"># Check tasks exist precisely once in the dependency map and levels.</span>
        <span class="c1"># This will detect cyclic flows among other things.</span>
        <span class="n">nTasks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">dm</span><span class="o">.</span><span class="n">values</span><span class="p">():</span> <span class="n">nTasks</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nTasks</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nTasks</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tl</span><span class="p">):</span>
          <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;Task count mismatch: &quot;</span> \
                <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> tasks, </span><span class="si">%d</span><span class="s2"> in _depsmap, </span><span class="si">%d</span><span class="s2"> in _tasklevs.&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">),</span> <span class="n">nTasks</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tl</span><span class="p">))</span>
          <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">:</span>
          <span class="k">if</span> <span class="nb">id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">_taskid</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;Task ID mismatch: &quot;</span> \
                  <span class="s2">&quot;tasks[</span><span class="si">%d</span><span class="s2">] ID is </span><span class="si">%d</span><span class="s2">.&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">_taskid</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>

          <span class="k">if</span> <span class="ow">not</span> <span class="n">tl</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
            <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;Task </span><span class="si">%d</span><span class="s2"> is not in _tasklevs.&quot;</span> <span class="o">%</span> <span class="nb">id</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">continue</span>

          <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">dm</span><span class="p">[</span><span class="n">tl</span><span class="p">[</span><span class="nb">id</span><span class="p">]]:</span>
            <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;Task </span><span class="si">%d</span><span class="s2"> is not in _depsmap level </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">tl</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Check consistency of _connmap and _bdpmap.</span>
        <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">bm</span><span class="p">:</span>
          <span class="n">dp</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="k">for</span> <span class="n">si</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">bm</span><span class="p">[</span><span class="n">di</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cm</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">si</span><span class="p">):</span>
              <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;Task </span><span class="si">%d</span><span class="s2"> is not a source in _connmap.&quot;</span> <span class="o">%</span> <span class="n">si</span>
              <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
              <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">di</span><span class="p">):</span>
              <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;Task </span><span class="si">%d</span><span class="s2"> is not a destination of </span><span class="si">%d</span><span class="s2"> in _connmap.&quot;</span> \
                    <span class="o">%</span> <span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span>
              <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
              <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">dp</span><span class="p">):</span>
              <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;Task </span><span class="si">%d</span><span class="s2"> input </span><span class="si">%d</span><span class="s2"> is not a destination&quot;</span> \
                    <span class="s2">&quot;of </span><span class="si">%d</span><span class="s2"> in _connmap.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span>
              <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
              <span class="k">continue</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">]</span> <span class="o">!=</span> <span class="n">conn</span><span class="p">:</span>
              <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;Connection mismatch: found </span><span class="si">%s</span><span class="s2">, expected </span><span class="si">%s</span><span class="s2">.&quot;</span> \
                    <span class="o">%</span> <span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">],</span> <span class="n">conn</span><span class="p">)</span>
              <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">dp</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">cm</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">]:</span>
              <span class="n">t</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">]</span>
              <span class="n">sp</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
              <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">si</span> <span class="ow">or</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">di</span> <span class="ow">or</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dp</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;Connection mismatch: found </span><span class="si">%s</span><span class="s2">, expected </span><span class="si">%s</span><span class="s2">.&quot;</span> \
                      <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">dp</span><span class="p">))</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>

              <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bm</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">di</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bm</span><span class="p">[</span><span class="n">di</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">dp</span><span class="p">):</span>
                <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;BDP connection </span><span class="si">%s</span><span class="s2"> not found.&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">di</span><span class="p">,</span> <span class="n">dp</span><span class="p">),)</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bm</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">sp</span><span class="p">):</span>
                  <span class="nb">print</span> <span class="n">errstr</span><span class="p">,</span> <span class="s2">&quot;BDP connection </span><span class="si">%s</span><span class="s2"> mismatch: &quot;</span> \
                        <span class="s2">&quot;found </span><span class="si">%s</span><span class="s2">, expected </span><span class="si">%s</span><span class="s2">.&quot;</span> \
                        <span class="o">%</span> <span class="p">((</span><span class="n">di</span><span class="p">,</span> <span class="n">dp</span><span class="p">),</span> <span class="n">bm</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="n">dp</span><span class="p">],</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">sp</span><span class="p">))</span>
                  <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">ok</span> <span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;FlowManager.verify(): okayed </span><span class="si">%d</span><span class="s2"> tasks.&quot;</span> <span class="o">%</span> <span class="n">nTasks</span>
        <span class="k">return</span> <span class="n">ok</span></div>


<div class="viewcode-block" id="FlowManager.stale"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.stale">[docs]</a>    <span class="k">def</span> <span class="nf">stale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">direct</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the stale flag of an AT and its downstream ATs.</span>

<span class="sd">            Stale tasks will be re-run upon execution of the flow, updating</span>
<span class="sd">            their output BDPs in the process; tasks not so marked are skipped</span>
<span class="sd">            to minimize running time.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            id : int</span>
<span class="sd">                Root task ID.</span>

<span class="sd">            direct : bool, optional</span>
<span class="sd">                Whether to mark only direct descendants stale (else the entire</span>
<span class="sd">                sub-flow); defaults to ``True``.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span> <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connmap</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>                         <span class="n">flow</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>                             <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downstream</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flow</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">markChanged</span><span class="p">()</span></div>


<div class="viewcode-block" id="FlowManager.diagram"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.diagram">[docs]</a>    <span class="k">def</span> <span class="nf">diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dotfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates dot (graphviz) diagram for the current flow.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            dotfile : str</span>
<span class="sd">                Output dot file name.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dot</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dotfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">dot</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;digraph flow {</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Loop over tasks in dependency order and connect them in the diagram.</span>
        <span class="c1"># The loop logic is similar to that in run().</span>
        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="c1"># Try to improve repeatability by sorting IDs.</span>
          <span class="n">dl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span>
          <span class="n">dl</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tid0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasklevs</span><span class="p">[</span><span class="n">tid0</span><span class="p">])</span>

          <span class="c1"># These colors are intended to match those</span>
          <span class="c1"># in the cascading style sheet for the html view</span>
          <span class="c1"># in etc/resources/css/admit.css.  They can be slightly</span>
          <span class="c1"># different shades if the flow is variadic or not (which is</span>
          <span class="c1"># not tracked in html view).</span>
          <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
            <span class="n">task</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;#bf080f&quot;</span>
              <span class="k">elif</span> <span class="n">task</span><span class="o">.</span><span class="n">enabled</span><span class="p">():</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;darkorange&quot;</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">isstale</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;#99dd99&quot;</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;#d06080&quot;</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">isstale</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;#d07070&quot;</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;#cf181f&quot;</span>
              <span class="k">elif</span> <span class="n">task</span><span class="o">.</span><span class="n">enabled</span><span class="p">():</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">isstale</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;#aaeeaa&quot;</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;#e07090&quot;</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">isstale</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;#e08080&quot;</span>

            <span class="n">dot</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;  task</span><span class="si">%d</span><span class="s1"> [shape=box,style=&quot;rounded,filled&quot;,color=&quot;</span><span class="si">%s</span><span class="s1">&quot;,label=&quot;</span><span class="si">%s</span><span class="se">\\</span><span class="s1">n</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&quot;]</span><span class="se">\n</span><span class="s1">&#39;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_AT&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">task</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span> 
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">tid</span><span class="p">]:</span>
              <span class="n">dot</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;  task</span><span class="si">%d</span><span class="s1"> -&gt; task</span><span class="si">%d</span><span class="s1"> [style=bold,fontsize=9,label=&quot; </span><span class="si">%d</span><span class="s1">&quot;];</span><span class="se">\n</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tid</span><span class="p">,</span> <span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
              <span class="p">)</span>

        <span class="n">dot</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dot</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="FlowManager.script"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.script">[docs]</a>    <span class="k">def</span> <span class="nf">script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">proj</span> <span class="o">=</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">tcube</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a Python script recreating the current flow.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        py : file</span>
<span class="sd">            Open, writable Python file object.</span>

<span class="sd">        proj : str, optional</span>
<span class="sd">            Project variable name; defaults to &#39;p&#39;.</span>

<span class="sd">        tcube : int, optional</span>
<span class="sd">            Task ID of Ingest_AT to set input file=cubefile; defaults to `None`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is a low-level method normally called only by Admit.script().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">py</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Flow tasks.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Loop over tasks in dependency order and connect them in the script.</span>
        <span class="c1"># The loop logic is similar to that in run().</span>
        <span class="n">idmap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="c1"># To increase regularity, order by ID number.</span>
          <span class="n">dl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span>
          <span class="n">dl</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

          <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
            <span class="n">task</span>  <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
            <span class="n">idmap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>  <span class="c1"># Renumber task IDs sequentially.</span>

            <span class="c1"># Determine non-default keywords.</span>
            <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;at = admit.</span><span class="si">%s</span><span class="s2">()&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="o">.</span><span class="n">_type</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">isAutoAlias</span><span class="p">():</span>
              <span class="n">args</span><span class="o">=</span> <span class="s2">&quot;&quot;</span> 
              <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">args</span><span class="o">=</span> <span class="s2">&quot;alias=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="o">.</span><span class="n">_alias</span>
              <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">_variflow</span> <span class="o">!=</span> <span class="n">at</span><span class="o">.</span><span class="n">_variflow</span><span class="p">:</span>
              <span class="n">args</span> <span class="o">+=</span> <span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;variflow=&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">_variflow</span><span class="p">)</span>
              <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="n">at</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span>
                <span class="k">if</span> <span class="n">tid</span> <span class="o">==</span> <span class="n">tcube</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
                  <span class="n">args</span> <span class="o">+=</span> <span class="s1">&#39;cubefile&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                  <span class="n">args</span> <span class="o">+=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">getkey</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>

            <span class="c1"># Simplify input tuples.</span>
            <span class="c1"># Use task alias when defined, otherwise the task ID.</span>
            <span class="n">tuples</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">tid</span><span class="p">]:</span>
              <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">_alias</span>
              <span class="n">t0</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idmap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">isAutoAlias</span><span class="p">()</span> <span class="k">else</span> \
                   <span class="nb">repr</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">tuples</span> <span class="o">+=</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">t0</span>
              <span class="k">else</span><span class="p">:</span>         <span class="n">tuples</span> <span class="o">+=</span> <span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">t0</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
              <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>

            <span class="n">py</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;t</span><span class="si">%-2d</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">.addtask(admit.</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">py</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">tuples</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="s2">&quot;, [</span><span class="si">%s</span><span class="s2">])</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tuples</span><span class="p">)</span>

            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="FlowManager.sameLineage"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.sameLineage">[docs]</a>    <span class="k">def</span> <span class="nf">sameLineage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">tid0</span><span class="p">,</span> <span class="n">flow0</span><span class="p">,</span> <span class="n">twins</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines whether two tasks in different flows have identical ancestry.</span>

<span class="sd">        Ancestry is determined by the type and number of parents, the</span>
<span class="sd">        associated port connections, and likewise for all grandparents, etc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tid : int</span>
<span class="sd">            Task ID in current flow.</span>

<span class="sd">        tid0 : int</span>
<span class="sd">            Task ID in `flow0`.</span>

<span class="sd">        flow0 : FlowManager</span>
<span class="sd">            Flow in which to search for matching task.</span>

<span class="sd">        twins : dict of ints</span>
<span class="sd">            Mapping of previously matched task IDs in `flow0` (keys) to</span>
<span class="sd">            corresponding IDs in the current flow (values).</span>

<span class="sd">        match : int (or None)</span>
<span class="sd">            Current best-match task ID in `flow0` known to have lineage</span>
<span class="sd">            compatible with `tid`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Whether `tid0` task has lineage compatible with `tid` and is the</span>
<span class="sd">            better-matching task (compared to `match`).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Fix stale setting when parent keywords have changed *between flows*,</span>
<span class="sd">          even though each task is individually up to date.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tid1</span> <span class="o">=</span> <span class="n">tid0</span> <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">match</span>

        <span class="c1"># The set of all tasks to compare for common ancestry.</span>
        <span class="n">ancestors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([(</span><span class="n">tid0</span><span class="p">,</span> <span class="n">tid1</span><span class="p">,</span> <span class="n">tid</span><span class="p">)])</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">ancestors</span><span class="p">:</span>
          <span class="n">tup</span> <span class="o">=</span> <span class="n">ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
          <span class="k">if</span> <span class="n">flow0</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">_type</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">_type</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
          <span class="k">if</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">bestMatch</span><span class="p">(</span><span class="n">flow0</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">flow0</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">==</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
              <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>

          <span class="n">bmap0</span> <span class="o">=</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
          <span class="n">bmap1</span> <span class="o">=</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
          <span class="n">bmap</span>  <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

          <span class="c1"># Check source connections match.</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bmap0</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bmap</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bmap0</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">bmap0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">bmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="n">ancestors</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">bmap0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bmap1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Everything matched (superior to `match`)...</span>
        <span class="k">return</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="FlowManager.findTwin"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.findTwin">[docs]</a>    <span class="k">def</span> <span class="nf">findTwin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">flow0</span><span class="p">,</span> <span class="n">twins</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to find corresponding task in another flow.</span>

<span class="sd">        For tasks to correspond they must be of identical types with identical</span>
<span class="sd">        lineage. The latter means that the two tasks have identical parents</span>
<span class="sd">        (the same number of inputs connected to the same ports on tasks of</span>
<span class="sd">        identical type), grandparents, etc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tid : int</span>
<span class="sd">            Task ID in current flow.</span>

<span class="sd">        flow0 : FlowManager</span>
<span class="sd">            Flow in which to search for matching task.</span>

<span class="sd">        twins : dict of ints</span>
<span class="sd">            Mapping of previously matched task IDs in `flow0` (keys) to</span>
<span class="sd">            corresponding IDs in the current flow (values).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int or None</span>
<span class="sd">            Valid `flow0` task ID on success, else ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Common ancestry implies corresponding tasks always occupy the same</span>
        <span class="c1"># dependency level. This greatly reduces the search domain.</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasklevs</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_depsmap</span><span class="p">:</span>
          <span class="n">match</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="k">for</span> <span class="n">tid0</span> <span class="ow">in</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_depsmap</span><span class="p">[</span><span class="n">level</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">twins</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">tid0</span><span class="p">):</span>
              <span class="c1"># Find all tasks with same ancestors; return the closest match.</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sameLineage</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">tid0</span><span class="p">,</span> <span class="n">flow0</span><span class="p">,</span> <span class="n">twins</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">tid0</span>
            <span class="k">elif</span> <span class="n">twins</span><span class="p">[</span><span class="n">tid0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tid</span><span class="p">:</span>
              <span class="k">return</span> <span class="n">tid0</span>

          <span class="k">return</span> <span class="n">match</span></div>


<div class="viewcode-block" id="FlowManager.mergeTasks"><a class="viewcode-back" href="../../module/admit/FlowManager.html#admit.FlowManager.FlowManager.mergeTasks">[docs]</a>    <span class="k">def</span> <span class="nf">mergeTasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">flow0</span><span class="p">,</span> <span class="n">summary0</span><span class="p">,</span> <span class="n">twins</span><span class="p">,</span> <span class="n">final</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merges task settings from another flow.</span>

<span class="sd">        Compares the tasks in `flow0` to `self`; tasks of the same type, </span>
<span class="sd">        at the same dependency level and with equivalent BDP input trees, are</span>
<span class="sd">        identified and relevant settings transferred into the current flow.</span>
<span class="sd">        Any task in the current flow which cannot be matched with a `flow0`</span>
<span class="sd">        task according to these criteria is passed unaltered. Each task in</span>
<span class="sd">        `flow0` may be merged with at most one task in the current flow.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        summary : SummaryData</span>
<span class="sd">            Summary data for current flow.</span>

<span class="sd">        flow0 : FlowManager</span>
<span class="sd">            Flow from which to merge task stale settings.</span>

<span class="sd">        summary0 : SummaryData</span>
<span class="sd">            Original summary data for `flow0`.</span>

<span class="sd">        twins : dict of ints</span>
<span class="sd">            Task IDs of all known pairs of identified (merged) tasks.</span>

<span class="sd">        final : bool</span>
<span class="sd">            Whether this will be the last call to this method for the current</span>
<span class="sd">            flow. If so, any unattached variflow branches will be merged.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is a low-level method normally called only by Admit.mergeFlow().</span>

<span class="sd">        In support of incremental flow construction, it is permissible to merge</span>
<span class="sd">        a flow multiple times; individual tasks will be merged at most once.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">addSummary</span><span class="p">(</span><span class="n">tid0</span><span class="p">,</span> <span class="n">tid1</span><span class="p">):</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">summary0</span><span class="o">.</span><span class="n">getItemsByTaskID</span><span class="p">(</span><span class="n">tid0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
              <span class="n">value</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
              <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                  <span class="n">entry</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">taskid</span> <span class="o">==</span> <span class="n">tid0</span><span class="p">:</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">setTaskID</span><span class="p">(</span><span class="n">tid1</span><span class="p">)</span>
                    <span class="n">summary</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">entry</span><span class="p">)</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">setTaskID</span><span class="p">(</span><span class="n">tid1</span><span class="p">)</span>
                <span class="n">summary</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">entry</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depsmap</span><span class="p">[</span><span class="n">level</span><span class="p">]:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
            <span class="n">tid0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findTwin</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">flow0</span><span class="p">,</span> <span class="n">twins</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tid0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
              <span class="k">if</span> <span class="ow">not</span> <span class="n">twins</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">tid0</span><span class="p">):</span>
                <span class="n">task</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">flow0</span><span class="p">[</span><span class="n">tid0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">)</span>
                <span class="n">twins</span><span class="p">[</span><span class="n">tid0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tid</span>
                <span class="n">addSummary</span><span class="p">(</span><span class="n">tid0</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                  
        <span class="k">if</span> <span class="n">final</span><span class="p">:</span>
          <span class="c1"># Process auto-generated aliases. This is done after all tasks</span>
          <span class="c1"># have been processed to minimize gratuitous reassignments</span>
          <span class="c1"># (which force tasks to be marked stale).</span>
          <span class="k">for</span> <span class="n">tid0</span> <span class="ow">in</span> <span class="n">twins</span><span class="p">:</span>
            <span class="n">task0</span> <span class="o">=</span> <span class="n">flow0</span><span class="p">[</span><span class="n">tid0</span><span class="p">]</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">twins</span><span class="p">[</span><span class="n">tid0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">isAutoAlias</span><span class="p">(</span><span class="n">compat</span><span class="o">=</span><span class="n">task0</span><span class="o">.</span><span class="n">_alias</span><span class="p">):</span>
              <span class="n">task</span><span class="o">.</span><span class="n">freeAlias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">)</span>
          <span class="c1">#</span>
          <span class="k">for</span> <span class="n">tid0</span> <span class="ow">in</span> <span class="n">twins</span><span class="p">:</span>
            <span class="n">task0</span> <span class="o">=</span> <span class="n">flow0</span><span class="p">[</span><span class="n">tid0</span><span class="p">]</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">twins</span><span class="p">[</span><span class="n">tid0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">isAutoAlias</span><span class="p">(</span><span class="n">compat</span><span class="o">=</span><span class="n">task0</span><span class="o">.</span><span class="n">_alias</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">setAlias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">,</span> <span class="n">task0</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span> <span class="o">!=</span> <span class="n">task0</span><span class="o">.</span><span class="n">_alias</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">markChanged</span><span class="p">()</span>

          <span class="c1"># Check for new tasks in protoype variadic sub-flows. If present,</span>
          <span class="c1"># mark the root stale so the sub-flows are recomputed. This assumes</span>
          <span class="c1"># the script contains *only* protoype flows; if re-running a script,</span>
          <span class="c1"># the user must manually add the task to *all* branches present.</span>
          <span class="c1">#</span>
          <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_varimap</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">twins</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> \
                           <span class="ow">and</span> <span class="mi">0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">twins</span><span class="p">[</span><span class="n">si</span><span class="p">]]:</span>
              <span class="c1"># Tasks in the new prototype flow.</span>
              <span class="n">proto</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
              <span class="k">for</span> <span class="n">subflow</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">twins</span><span class="p">[</span><span class="n">si</span><span class="p">]][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">proto</span> <span class="o">|=</span> <span class="n">subflow</span>
              <span class="c1">#</span>
              <span class="k">for</span> <span class="n">subflow</span> <span class="ow">in</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">subflow</span><span class="p">:</span>
                  <span class="k">if</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">twins</span><span class="p">:</span> <span class="n">proto</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">twins</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span>
              <span class="c1">#</span>
              <span class="c1"># If there are new (unmatched) tasks, mark the root stale so</span>
              <span class="c1"># that the variadic branches have a chance to regenerate.</span>
              <span class="k">if</span> <span class="n">proto</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">twins</span><span class="p">[</span><span class="n">si</span><span class="p">]]</span><span class="o">.</span><span class="n">markChanged</span><span class="p">()</span>

          <span class="c1"># Process variadic sub-flows.</span>
          <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_varimap</span><span class="p">:</span>
            <span class="c1"># Can&#39;t reintroduce tasks if the variadic root has disappeared!</span>
            <span class="k">if</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">twins</span><span class="p">:</span>
              <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">twins</span><span class="p">[</span><span class="n">si</span><span class="p">]]</span>
              <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">subflow</span> <span class="ow">in</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_varimap</span><span class="p">[</span><span class="n">si</span><span class="p">][</span><span class="n">sp</span><span class="p">]:</span>
                  <span class="c1"># Subflow task IDs are in a set (unordered) but need to </span>
                  <span class="c1"># be added in dependency order to maximize success.</span>
                  <span class="n">tids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subflow</span><span class="p">)</span>
                  <span class="n">tids</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tid0</span><span class="p">:</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_tasklevs</span><span class="p">[</span><span class="n">tid0</span><span class="p">])</span>

                  <span class="k">for</span> <span class="n">tid0</span> <span class="ow">in</span> <span class="n">tids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">twins</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">tid0</span><span class="p">):</span>
                      <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="p">:</span>
                        <span class="c1"># Missing tasks from the prototype flow? The user</span>
                        <span class="c1"># deleted them. To be safe, mark the root stale so the</span>
                        <span class="c1"># sub-flows get repopulated from the new prototype,</span>
                        <span class="c1"># and don&#39;t transfer the outdated sub-flows (below).</span>
                        <span class="n">root</span><span class="o">.</span><span class="n">markChanged</span><span class="p">()</span>
                      <span class="k">elif</span> <span class="ow">not</span> <span class="n">root</span><span class="o">.</span><span class="n">_stale</span><span class="p">:</span>
                        <span class="c1"># Reintroduce task iff all required inputs exist.</span>
                        <span class="n">stuples</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">stuple0</span> <span class="ow">in</span> <span class="n">flow0</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">tid0</span><span class="p">]:</span>
                          <span class="k">if</span> <span class="n">twins</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">stuple0</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="c1"># Translate input to new flow.</span>
                            <span class="n">stuples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">twins</span><span class="p">[</span><span class="n">stuple0</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">stuple0</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                          <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stuples</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">flow0</span><span class="o">.</span><span class="n">_bdpmap</span><span class="p">[</span><span class="n">tid0</span><span class="p">]):</span>
                          <span class="c1"># Ok, all inputs present.</span>
                          <span class="n">task</span> <span class="o">=</span> <span class="n">flow0</span><span class="p">[</span><span class="n">tid0</span><span class="p">]</span>
                          <span class="n">twins</span><span class="p">[</span><span class="n">tid0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">stuples</span><span class="p">)</span>
                          <span class="n">addSummary</span><span class="p">(</span><span class="n">tid0</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">ADMIT 1.0.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, The ADMIT Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>